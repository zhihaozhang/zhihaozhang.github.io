<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chih-Hao&#39;s Blog</title>
  <icon>https://www.gravatar.com/avatar/ee6c42acd9e6fdf6da073aabf58a2ad9</icon>
  <subtitle>骨灰级果粉</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://zhihaozhang.github.io/"/>
  <updated>2021-04-07T10:41:37.537Z</updated>
  <id>http://zhihaozhang.github.io/</id>
  
  <author>
    <name>Chih-Hao</name>
    <email>zhihaozhang@me.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>在中国远程为美企工作一年是一种什么样的体验（上）</title>
    <link href="http://zhihaozhang.github.io/2021/04/07/workAsContractor/"/>
    <id>http://zhihaozhang.github.io/2021/04/07/workAsContractor/</id>
    <published>2021-04-07T09:11:13.192Z</published>
    <updated>2021-04-07T10:41:37.537Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>由于新冠疫情，很多公司让员工<em>work from home</em>，尤其是在疫情失控的国家，不少公司开始在github上招remote开发者作为<strong>contractor</strong>(公司无需为contractor缴纳医疗保险和其他杂费，是控制成本的一种好方法)。</p><p>我幸运的得到了一份为美国某<em>纳斯达克</em>上市公司企业远程工作的机会，自从去年4月初为美国远程工作已经快一年了，想写一篇总结(流水账)纪念一下这宝贵的一年时光。</p><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="工作内容"><a href="#工作内容" class="headerlink" title="工作内容"></a>工作内容</h2><p>工作内容是用<strong>Flutter</strong>从0到1来编写一个类似<strong>抖音直播带货</strong>的App，这个应用已经有了Web版，公司想要开发一个手机版的类似应用。为了跟Web一致，遇到了很多问题，主要是由于浏览器和手机的长宽比差异。</p><p>一年里，我大约写了约2万行左右的Dart代码，也解决了不少问题(当然也有一些问题到现在也没有比较好的解决方法，比如5G信号和wifi网络切换造成直播掉线的问题)。</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gpbawj4agaj31560c0mxa.jpg" alt=""></p><blockquote><p>一年内的代码提交记录</p></blockquote><p>另外一部分工作就是为公司面试候选人，主要是<strong>Flutter</strong>方面的，也有<strong>iOS</strong>和<strong>安卓</strong>的原生开发者。</p><h2 id="同事"><a href="#同事" class="headerlink" title="同事"></a>同事</h2><h3 id="Mobile组内同事"><a href="#Mobile组内同事" class="headerlink" title="Mobile组内同事"></a>Mobile组内同事</h3><p>需要说明的是，我们<strong>Mobile</strong>组其他成员也是散落在世界各地，有欧洲<em>(英国伦敦、塞尔维亚、克罗地亚)</em>的，有南美的，当然也有美国的。大家处于不同的时区，因此每天例会(<em>stand up meeting</em>)选在了<strong>北京时间</strong>的11：30<strong>或</strong>12：30。之所以用了「或」字，因为我也是第一次知道美国的时间，一年会有两次挪动，一次往前移一小时，一次往后移一小时。</p><p>当然，这一年里，有人来，也有人走。有人比较nice，也有人比较不nice,合作起来不是那么愉快，这都是不可避免的，都是工作的一部分。</p><p>大家是用英语交流的，跟我一样，有些同事的母语也不是英语，交流起来并不是特别顺畅。但大部分同事的英语还是比较地道的。通过跟他们交流，最大的体会是敢开口<strong>说英语</strong>了。听说读写能力都有了不小的提升，也习得了不少地道的表述方式。</p><blockquote><p>印象最深的两个是，他们在纠正你错误之前，会礼貌的说一句:”correct me if I’m wrong”，表述某个现象很奇怪，会说<strong>Werid</strong>,而不是<strong>strange</strong>。</p></blockquote><p>同事总体都是非常厉害的，其中两个tech lead是<strong>前谷歌</strong>的员工，他们不喜欢坐班的方式，转为了自由开发者，获得了<a href="https://www.toptal.com" target="_blank" rel="external">Toptal</a>的认证，一个声称只给某个方向前3%顶尖水平从业者颁发的认证。有了这个认证，就会有很多公司通过Toptal来找到你，让你为其工作(当然Toptal也是会从中抽成一部分走的)。</p><h3 id="Mobile组外同事"><a href="#Mobile组外同事" class="headerlink" title="Mobile组外同事"></a>Mobile组外同事</h3><p>技术上接触到的组外同事主要是<strong>后端</strong>、<strong>Web前端</strong>工程师以及<strong>设计师</strong>、<strong>QA工程师</strong>、<strong>项目经理</strong>。</p><p><strong>后端</strong>、<strong>Web前端</strong>工程师是比较懂技术的，跟他们交流起来还是比较顺畅的。但最痛苦的是他们开始的时候总是绕开我们改了一些东西，然后，然后让我们填坑。(有时候要找数小时才能找到原因所在)</p><p>QA工程师，通常不是很懂技术，他们只能看到问题的表象，因此有些问题很难给他们解释的很明白。QA team里的人员也有一定的流动性，带来的问题是在测试过程中，有些新来的人测出来某些地方有点不太对，所以两个不同的人在不同的时间提出了相同或类似的问题，在jira上创建了ticket，可能这个ticket很久之前已经被close了。有些其实不是bug，而是不同选择的result。（例如上一篇博客写的<a href="http://zhihaozhang.github.io/2021/03/21/interactionAndStreamSize/">视频实时直播应用中视频流填充与道具摆放方式组合优缺点总结</a>） </p><p>设计师是不太懂技术的，他们只管设计，也不管能不能、容易不容易实现。(此处省略一万字) 设计师中途也换过一次，所以有些地方设计理念有些明显不同。</p><p>项目经理是很好的一个人，经验丰富，能够平衡大家的工作量，控制进度，有条不紊的推进；对外也能很好的帮我们扛住上层和CTO的压力，非常幸运能进入她的team。</p><h2 id="薪水"><a href="#薪水" class="headerlink" title="薪水"></a>薪水</h2><p>一份工作，收入是绕不过去的一个话题，但是具体数字毫无疑问是不能透露的。</p><p>首先，薪水是以<strong>美金(USD/$)</strong>结算的，在乘以汇率之后，在国内是个很高的数字，虽然汇率一直在跌，从去年7.17跌到最低6.42了，但总体依然是很满意的。</p><p>其次，美国薪水是<strong>每两周</strong>发一次，快乐自然就加倍了。之前看英超，一直说某某周薪多少磅，现在终于知道原因了。</p><p>后面因为要面试，无意间在他简历中看到了一个水平跟我差不多的候选者(后来成为了我同事)的薪资期望，我才发现，我的薪资期望当时填低了不少，我是按照中国收入水平来填的。</p><p>总之这一年，通过这份工作，我攒下了一笔钱。</p><p>——————————————————————————————————————上篇完结——————————————————————————————————————</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;由于新冠疫情，很多公司让员工&lt;em&gt;work from home&lt;/em&gt;，尤其是在疫情失控的国家，不少公司开始在github上招remot
      
    
    </summary>
    
      <category term="工作总结" scheme="http://zhihaozhang.github.io/categories/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="工作总结" scheme="http://zhihaozhang.github.io/tags/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>视频实时直播应用中视频流填充与道具摆放方式组合优缺点总结</title>
    <link href="http://zhihaozhang.github.io/2021/03/21/interactionAndStreamSize/"/>
    <id>http://zhihaozhang.github.io/2021/03/21/interactionAndStreamSize/</id>
    <published>2021-03-21T03:43:03.194Z</published>
    <updated>2021-03-21T05:06:54.752Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在做视频直播应用过程中，就视频流尺寸和道具的放置方式，在观众侧进行不同的抉择，会有优点和缺点，本文是开发过程中进行<strong>权衡</strong>的一个总结。</p><h1 id="直播流尺寸（Stream-Size）"><a href="#直播流尺寸（Stream-Size）" class="headerlink" title="直播流尺寸（Stream Size）"></a>直播流尺寸（Stream Size）</h1><p>由于主持人侧的视频流尺寸跟观众侧的手机屏幕分辨率和长宽比不可避免会有一定的差异，在观众侧，有两种方式来展示实时视频流，类似于CSS中的<strong>BoxFit</strong>值：</p><ol><li><strong>Cover</strong> ： 裁切视频流，以达到覆盖整个屏幕的目的，但边缘视频内容在观众侧可能丢失。</li><li><strong>Contain</strong> ： 视频流不裁切，内容完整可见，但上下或左右会有黑边。</li></ol><h1 id="道具的放置方式-Interactions"><a href="#道具的放置方式-Interactions" class="headerlink" title="道具的放置方式(Interactions)"></a>道具的放置方式(Interactions)</h1><p>道具是直播过程中的另一个<em>重头戏</em>，可以增加主持人和观众之间的互动。同样由于手机尺寸差异，同样需要进行抉择。一般是按照比例进行放置，但是比例基于谁有两种选择。</p><ol><li>基于手机屏幕尺寸 ： 可以保证所有的道具都完全可见，但位置相对于主持人的描述可能发生偏移，比如主持人说：请看我头顶的道具，此时观众看到的道具很可能并不在他头顶。</li><li>基于视频流的尺寸 ： 可以保证所有的道具都基于视频内容放置在同样位置，比如主持人把一个道具放置在他的头顶，不管观众使用什么手机尺寸，看到的道具都会放置在主持人头上；缺点也很明显，如果道具放在视频流边缘，那部分视频内容正好不幸被全部/部分裁切，那么道具只能看到部分甚至全部不可见。</li></ol><h1 id="组合的优缺点"><a href="#组合的优缺点" class="headerlink" title="组合的优缺点"></a>组合的优缺点</h1><p>这两个选项各有2种选择，产生了四种不同组合。我整理了一个表格，为了表述准确，使用了英文。</p><p>阅读表格前，想象主持人在使用一个长宽比1：1的平板电脑，观众使用五花八门的手机设备(长宽比大致为16:9)，这样主持人的视频流大致为正方形，而观众的屏幕是长方形。</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gorf6bbtj9j30xm0u00vk.jpg" alt=""></p><h1 id="帮助抉择的例子"><a href="#帮助抉择的例子" class="headerlink" title="帮助抉择的例子"></a>帮助抉择的例子</h1><p>用<strong>产品经理</strong>和<strong>开发者</strong>的对话来帮助理解抉择的过程：</p><p><strong>产品经理</strong>：我不想要黑边，我想视频流填充满观众的屏幕</p><p><strong>开发者</strong>：没问题！使用对视频流使用”Cover“，但是道具可能会部分/全部不可见。</p><p><strong>产品经理</strong>：但我不想道具被部分/全部砍掉</p><p><strong>开发者</strong>：使用屏幕尺寸作为道具的相对定位基准。但是道具跟视频内容的关系就脱钩了，主持人放在头上的道具，在观众侧并不在头上。</p><p><strong>产品经理</strong>：但是我想所有道具可见，而且跟视频内容完全挂钩。</p><p><strong>开发者</strong>：没问题！对视频流使用”contain“，对道具基于视频流进行定位，但这不可避免会产生黑边。</p><p><strong>产品经理</strong>：我不想要黑边！有没有一个办法，能解决上述的缺点？</p><p><strong>开发者</strong>：有一种方法，那就是把视频流拉伸到撑满屏幕！但这样的话视频在观众侧看起来真的很丑…</p><h1 id="其他App是怎么做的"><a href="#其他App是怎么做的" class="headerlink" title="其他App是怎么做的"></a>其他App是怎么做的</h1><h2 id="Mobile-first-App"><a href="#Mobile-first-App" class="headerlink" title="Mobile-first App"></a>Mobile-first App</h2><p>抖音和Instagram使用了”<strong>Cover</strong>“，并且只允许手机尺寸的视频流。</p><h2 id="Desktop-first-App"><a href="#Desktop-first-App" class="headerlink" title="Desktop-first App"></a>Desktop-first App</h2><p>Youtube和Twitter使用了”<strong>Contain</strong>“，保留了黑边，但是把这些空间用作其他用途，比如聊天室功能。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在做视频直播应用过程中，就视频流尺寸和道具的放置方式，在观众侧进行不同的抉择，会有优点和缺点，本文是开发过程中进行&lt;strong&gt;权衡&lt;/s
      
    
    </summary>
    
      <category term="视频直播应用" scheme="http://zhihaozhang.github.io/categories/%E8%A7%86%E9%A2%91%E7%9B%B4%E6%92%AD%E5%BA%94%E7%94%A8/"/>
    
    
      <category term="Flutter" scheme="http://zhihaozhang.github.io/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>helium-ol-map的设计取舍、权衡、实现、踩坑与npm发布</title>
    <link href="http://zhihaozhang.github.io/2019/07/02/OpenLayer/"/>
    <id>http://zhihaozhang.github.io/2019/07/02/OpenLayer/</id>
    <published>2019-07-02T06:30:01.392Z</published>
    <updated>2019-07-02T09:29:30.744Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经历了上次被百度地图<strong>封号、封IP甚至改变离线地图下载规则</strong>后，我们开始反思，是不是项目绑百度地图太紧了，如果后面需要<code>将应用场景变到其他城市</code>但百度离线地图不可用了，应该怎么办的问题。</p><p>为了摆脱百度地图的<strong>枷锁</strong>，我们不得不站在更高角度上考虑问题，考虑后续如何将系统做得更<em>通用</em>。将之前的<a href="http://zhihaozhang.github.io/2019/05/20/BMapOffline/">博文中</a>介绍的系统实现技术方案(<code>BMap+MapV</code>)拓展到支持更多主流地图引擎<em>（高德地图、腾讯地图、谷歌地图等）</em>。</p><p>经调研，我们最终选定了大名鼎鼎的<a href="https://openlayers.org" target="_blank" rel="external">OpenLayer</a>作为管理图层和绘制地图上层样式的Web GIS引擎。主要是考虑到两点。</p><ol><li>在地图数据源方面，它支持各种类型的瓦片地图，既支持在线的，也支持<strong>离线</strong>的(<code>这对我们很重要</code>)。比如OSM, Bing, MapBox, Stamen, MapQuest等等；还支持各种矢量地图，比如GeoJSON，TopoJSON，KML，GML等等。</li><li>OpenLayer社区活跃，可能会遇到的各种问题都可以找到解决方案，且后续更新也是有保障的。</li></ol><p>因此，这次我们实现了一个Library并发布到了npm上，地址是：<a href="https://www.npmjs.com/package/helium-ol-map" target="_blank" rel="external">helium-ol-map</a>。</p><p>在使用这个库的过程中，我感觉这个库还是很好用的，最直观的感受就是之前十几行的代码现在仅需一两行就搞定了。经过封装，感觉像是使用了声明式的方式在编程，描述我要做一件啥事，而之前是一直在操心这这件事的实现细节。我想，应该是已经达到了做这个库的目的。</p><p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g4ljr1l99fj31bw0om75y.jpg" alt=""></p><blockquote><p>代码前后对比(注释部分为之前的业务代码，现仅需一行代码)</p></blockquote><p>下文就简单介绍一下这个库的设计与实现过程中遇到问题的解决方案。</p><h1 id="OpenLayer5"><a href="#OpenLayer5" class="headerlink" title="OpenLayer5"></a>OpenLayer5</h1><p>OpenLayer本身API繁多，在做这个库之前我并没用用过，我是看了一两天<a href="http://weilin.me/ol3-primer/index.html" target="_blank" rel="external">OpenLayers 3 Primer</a>对OL3进行了简单的入门。这个部分我就不班门弄斧了，有需要的读者可以自行阅读理解，需要注意的是很多接口已经有所变动，以官网为准，不过了解基本的思想还是挺好的。</p><h1 id="helium-ol-map的设计与实现"><a href="#helium-ol-map的设计与实现" class="headerlink" title="helium-ol-map的设计与实现"></a>helium-ol-map的设计与实现</h1><p>这个库的实现主要分为两步，第一步是确定使用的地图引擎(<em>离线 or 在线</em>)；第二步图层管理方式。</p><h2 id="确定使用的地图引擎"><a href="#确定使用的地图引擎" class="headerlink" title="确定使用的地图引擎"></a>确定使用的地图引擎</h2><p>确定地图引擎之前，可以对比较通用的参数进行配置(同时也需要提供默认值)。比较通用的参数有：<strong>zoom/maxZoom/minZoom/center/origin/extent/elContainer等等</strong>。</p><p>由于每个引擎都有自己对经纬度的标准，确定地图引擎后，就要指定经纬度的投影规则(比如百度地图是<code>BD-09</code>)，然后对原始的经纬度向特定地图引擎规则转换，否则会造成地图的偏移。</p><p>接下来是指定<strong>Tile</strong>和<strong>VectorSource</strong>:</p><ul><li>ol.source.Tile对应的是瓦片数据源，现在网页地图服务中，绝大多数都是使用的瓦片地图，而OpenLayers 3作为一个WebGIS引擎，理所当然应该支持瓦片。</li><li>ol.source.Vector对应的是矢量地图源，点，线，面等等常用的地图元素(Feature)，就囊括到这里面了。这样看来，只要这两种Source就可以搞定80%的需求了。</li></ul><p>如果是离线地图版，还需要指定<em>离线地图的地址</em>。</p><p>好的，有了这些配置，就可以完成初始化地图了。</p><h2 id="图层管理方式"><a href="#图层管理方式" class="headerlink" title="图层管理方式"></a>图层管理方式</h2><p>另一个比较关键的点是对Layer的管理方式，这也是我与同事<strong>争执</strong>的<em>主要矛盾点</em>。由于第一期的地图业务主要是我完成，最终我说服了他，将各层Layer设计为一个key/Value的Object，并提供增删改查的方法；他的方案是给地图提供一个默认Layer，然后遍历这个Layer的各个feature进行管理。</p><p>不过他一直坚持的一点是点线面的绘制应该是在地图这一层进行管理的，但由于图层管理方式采用了我的方案，也就是点线面绘制的Layer在要添加的时候不确定有没有，因此将绘制点线面的返回值设为了需要绘制的feature，到使用的时候指定加到哪个Feature上。</p><p>下面给出了一个该库使用的example：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAP_TYPE = <span class="string">'baidu-offline'</span>;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> HeliumMap(&#123;</div><div class="line">    mapType: MAP_TYPE,</div><div class="line">    el: <span class="string">'map'</span>,</div><div class="line">    center: [<span class="number">102.870848</span>, <span class="number">25.024963</span>],</div><div class="line">    zoom: <span class="number">10</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> layerManager = <span class="keyword">new</span> HeliumLayerManager(&#123;</div><div class="line">    map : map</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> markerLayer = layerManager.createLayer();</div><div class="line">  layerManager.addLayer(<span class="string">'markerLayer'</span>,markerLayer);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> marker = map.createMarker(<span class="number">102.870848</span>, <span class="number">25.024963</span>);</div><div class="line">  layerManager.addFeature(marker,<span class="string">'markerLayer'</span>);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">var</span> lineLayer = layerManager.createLayer();</div><div class="line">  layerManager.addLayer(<span class="string">'lineLayer'</span>,lineLayer);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> line = map.createLine([<span class="number">102.870848</span>,<span class="number">24.024963</span>],[<span class="number">102.870848</span>,<span class="number">26.024963</span>],&#123;<span class="attr">fillColor</span>:<span class="string">"red"</span>,<span class="attr">strokeColor</span>:<span class="string">"red"</span>,<span class="attr">strokeWidth</span>:<span class="number">2</span>&#125;);</div><div class="line">  layerManager.addFeature(line,<span class="string">'lineLayer'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> polygonLayer = layerManager.createLayer();</div><div class="line">  layerManager.addLayer(<span class="string">'polygonLayer'</span>,polygonLayer);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> polygon = map.createPolygon([[<span class="number">102.870848</span>,<span class="number">25.024963</span>],[<span class="number">102.870848</span>,<span class="number">25.034963</span>],[<span class="number">102.880848</span>,<span class="number">25.034963</span>],[<span class="number">102.880848</span>,<span class="number">25.014963</span>],[<span class="number">102.870848</span>,<span class="number">25.024963</span>]]);</div><div class="line">  layerManager.addFeature(polygon,<span class="string">'polygonLayer'</span>);</div></pre></td></tr></table></figure><h1 id="遇到的一些坑"><a href="#遇到的一些坑" class="headerlink" title="遇到的一些坑"></a>遇到的一些坑</h1><p>实现过程中坑肯定还是会有的，第一个坑就是批量创建feature的时候，ID如果不明确指定而采取deafault-value,那么后面的feature会因此覆盖前面的feature，因此批量初始化feature的时候要确保每个feature有独特的ID。</p><p>第二个坑是坐标转换过程中可能会出现转换失败，需要用try catch包裹住可能throw error的部分。</p><p>第三个坑是坐标偏移，这个问题在上篇博客中是实现的很好的，跟友商的实现方式进行过比较，这次跟友商回到了同一起跑线上。主要是OL3里fromLonLat这个function的默认参数不是我们想要的地图坐标标准，需要明确指定符合自己引擎的标准。</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>短时间内上手OpenLayer也增强了我的信心，对于各种框架的使用，我越发找到感觉了。这是我离职前为公司做的最后一个项目了，也算是做到了<em>善始善终</em>。</p><p>最后，祝福公司明天更好，祝福自己的明天更好！</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="http://weilin.me/ol3-primer/index.html" target="_blank" rel="external">OpenLayers 3 Primer</a></li><li><a href="https://www.npmjs.com/package/helium-ol-map" target="_blank" rel="external">npm:helium-ol-map</a></li><li><a href="https://openlayers.org" target="_blank" rel="external">OpenLayer</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;经历了上次被百度地图&lt;strong&gt;封号、封IP甚至改变离线地图下载规则&lt;/strong&gt;后，我们开始反思，是不是项目绑百度地图太紧了，如果
      
    
    </summary>
    
      <category term="前端" scheme="http://zhihaozhang.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="GIS" scheme="http://zhihaozhang.github.io/tags/GIS/"/>
    
  </entry>
  
  <entry>
    <title>百度离线地图之死</title>
    <link href="http://zhihaozhang.github.io/2019/05/29/BMapOfflineDeath/"/>
    <id>http://zhihaozhang.github.io/2019/05/29/BMapOfflineDeath/</id>
    <published>2019-05-29T12:59:00.824Z</published>
    <updated>2019-06-12T02:56:38.803Z</updated>
    
    <content type="html"><![CDATA[<p>【6月6日更新】<br><strong>原来的策略对中国电信手机卡依然有效！！联通和移动均已失效，买张电信卡流量套餐吧。</strong></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首先得承认有点标题党，但是还是不得不向大家宣布一个坏消息，百度离线地图的获取规则变了。可以说一定程度上宣布了自己抓取百度离线地图这条路<strong>行不通</strong>了。</p><p>之前接到了百度的电话，我们10M/s的下载速度<code>（大约每秒下1000多张图片）</code>抓取地图的爬虫严重影响了他们的服务质量，让我们停止抓取。</p><p>当晚，他们就改变了<strong>地图加载</strong>规则。以下是我们猜测的新规则。</p><h1 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h1><p>基于一些实验，我们猜测:</p><blockquote><p>百度地图应该改了底图加载的规则，通过地图拖拽事件，回调了某个<em>callback function</em>，创建了<strong>session</strong>。每一次底图如果刷新，session就会刷新。已下载的图片不会受影响，但是新的url没有新建的session就会redirect到百度的error页面。</p></blockquote><p>每次刷新页面，session就重建了，因此获取到的数据都是<strong>error.html</strong>文件。</p><p>咨询了购买百度离线地图的价格，大约是3年<strong>150万</strong>人民币，<strong>打扰了</strong>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;【6月6日更新】&lt;br&gt;&lt;strong&gt;原来的策略对中国电信手机卡依然有效！！联通和移动均已失效，买张电信卡流量套餐吧。&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;
      
    
    </summary>
    
      <category term="前端" scheme="http://zhihaozhang.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端学习笔记" scheme="http://zhihaozhang.github.io/tags/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>基于百度离线地图时空可视分析系统的实现与性能优化</title>
    <link href="http://zhihaozhang.github.io/2019/05/20/BMapOffline/"/>
    <id>http://zhihaozhang.github.io/2019/05/20/BMapOffline/</id>
    <published>2019-05-20T09:01:35.346Z</published>
    <updated>2019-05-24T14:19:24.004Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>近期实现了一个<code>时空可视分析系统</code>的前端部分，帮助警方看到特定地区(主要为昆明)、特定时间段<strong>【时】</strong>、特定分局、派出所、街道<strong>【空】</strong>的各种类型警情统计；并提供对未来一段时间的警情预测，对警情高发区域进行重点<strong>部署</strong>和<strong>管控</strong>。整体界面如下图所示。</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1g38x2mgpr0j31fm0smtcy.jpg" alt=""></p><blockquote><p>界面截图(概念图)</p></blockquote><p>实现这个系统和<strong>优化性能</strong>的过程中有了一些<em>感悟和心得</em>，在这篇博客中进行记录。</p><h1 id="百度地图和百度离线地图"><a href="#百度地图和百度离线地图" class="headerlink" title="百度地图和百度离线地图"></a>百度地图和百度离线地图</h1><p>其实在2015年飞利浦实习时开发一款<em>iOS跑步软件</em>过程中有用过百度地图进行<strong>跑步路径</strong>绘制，但在web开发过程中还是第一次遇到<strong>GIS开发</strong>相关的任务，好在团队中有一个会写代码的宠物店老板，有丰富的离线地图开发经验，指导我完成了这次的开发任务。</p><p>可能大家对百度地图都不陌生，他可以支持地图样式定制化，各种风格的样式都可以进行配置，而且现在已经强大到你上传一幅图片，可以自动识别出你的风格进行<strong>识图配色</strong>，并导出为JSON文件。主要可配置的有：<strong>陆地、水系、陆地、文字描边、道路</strong>，这个功能可以让设计师也直接参与到地图风格的定型，减少工程师的工作量。</p><h2 id="百度地图底层技术"><a href="#百度地图底层技术" class="headerlink" title="百度地图底层技术"></a>百度地图底层技术</h2><p>大家可能注意到了，百度地图可以缩放到不同<strong>层级</strong>的，比如最大的层级是可以看到街道一级的，最小的层级是洲级别的，就百度地图而言，层级大约是0-18级。</p><p>地图的每一层又是可以左右挪动的，每一层都是由一张张底图组成的，他们的专业名称叫做<code>瓦片</code>。例如下图就是有9张<strong>瓦片</strong>组成的。<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1g38wx8r6r4j30ld0e7gml.jpg" alt=""></p><p>明白了上面两点，我们就可以用三个变量：<strong>瓦片等级（level）</strong>和瓦片坐标编号（X，Y）唯一确定瓦片，这也是离线抓取相应图片并放置到正确文件夹路径的<strong>关键</strong>所在，比如第一层级的最左上角的瓦片路径就是/0(level)/1(x)/1.png(y)。</p><p>当然，层级越高，我们看到的细节也就越多，例如用谷歌地图放大到最大层级就是可以看到你家的。这也意味着我们需要更多的瓦片来描述更高层级的地图，通常下一级的瓦片，是由上一级瓦片切割为<strong>4片</strong>组成的，就形成了下图的<strong>瓦片金字塔</strong>。</p><p><img src="http://cntchen.github.io/img/国内主要地图瓦片坐标系定义及计算原理/瓦片切割（瓦片金字塔）.jpg" alt=""></p><h2 id="百度离线地图瓦片的获取"><a href="#百度离线地图瓦片的获取" class="headerlink" title="百度离线地图瓦片的获取"></a>百度离线地图瓦片的获取</h2><p>由于我们系统需要部署在公安网内，不能访问外网，所以我们并不能实时获取百度地图的瓦片，只能提前将百度地图瓦片缓存下来，以上一节提到的方式进行保存。爬取百度离线地图，已经有很多人提供了代码甚至是exe文件，这里就不展开说了。这个过程是比较慢的，下载到16级，通常就需要<strong>三四天</strong>，因为<em>碎片文件</em>太多了，仅昆明周边，到15级大约有<strong>400万张</strong>图片了。</p><p>跟前线部署人员交流过程中发现，在文件传输和拷贝的过程中，也有文件碎片引起的速度慢的问题，这个问题后面想通过插external盘解决，毕竟让大家现场等三四天成本还是比较高的。</p><p>后面优化了爬虫的逻辑，每秒大概能下10M的图片，但很快百度就打电话过来问责了，说严重影响到了他们的服务了，然后就发现号和ip都被百度封了。到了第二天，百度直接加密了，获取的图片都是错误符EOF。</p><p>也就是说，自此之后，这种爬虫获取的方式将<strong>永久行不通了。</strong>百度离线地图获取的路被永远堵死了。</p><h2 id="其他地图"><a href="#其他地图" class="headerlink" title="其他地图"></a>其他地图</h2><p>其实不局限于百度地图，有很多其他选择，比如高德地图、谷歌地图等都是不错的选择，需要<strong>注意</strong>的是地图直接的经纬度标准不同，需要转换，否则会发生<strong>偏移</strong>甚至不可用。</p><p>例如我在做项目的时候拿到的是高德地图的数据，放到百度地图上，发生了明显的偏移。我使用<code>nodejs</code>写了一个读文件然后转换的逻辑，并写回文件。</p><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1g397e9gqttj319v0u0jve.jpg" alt=""></p><blockquote><p>转换前后轮廓对比(分局层面)</p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1g38zs0skkwj31a00tgtdk.jpg" alt=""></p><blockquote><p>转换前后轮廓对比(派出所层面)</p></blockquote><p>关于各大地图厂商的经纬度转换规则及实现，请参考<a href="https://blog.csdn.net/zxt94/article/details/79657780" target="_blank" rel="external">这篇博客</a>。</p><h1 id="项目总体架构"><a href="#项目总体架构" class="headerlink" title="项目总体架构"></a>项目总体架构</h1><p>项目是使用的<code>umi+dva</code>作为整体框架，使用数据流的方式管理的，当时空选项发生改变时，<code>dispatch</code>相应的action，通过异步网络请求出发<strong>Effects</strong>然后流向<strong>Reducers</strong>并改变<strong>State</strong>，然后通过state去改变绑定的View值。</p><p><img src="https://zos.alipayobjects.com/rmsportal/PPrerEAKbIoDZYr.png" alt=""></p><h2 id="性能优化策略1：组件"><a href="#性能优化策略1：组件" class="headerlink" title="性能优化策略1：组件"></a>性能优化策略1：组件</h2><p>作为React组件，并非每次轮询，组件都需要重新渲染一次的，通过重写<code>shouldComponentUpdate</code>方法可以判断是否真的需要刷新，这在状态比较多的时候，是很有效的性能提升手段。</p><h2 id="性能优化策略2：地图层级的防抖"><a href="#性能优化策略2：地图层级的防抖" class="headerlink" title="性能优化策略2：地图层级的防抖"></a>性能优化策略2：地图层级的防抖</h2><p>在监听地图Zoom的过程中，我发现会经常会发生<strong>抖动</strong>，造成了界面非常卡的现象。其实与防抖相对的还有节流，具体实现细节可以看<a href="https://www.cnblogs.com/walls/p/6399837.html" target="_blank" rel="external">JavaScript函数节流和函数防抖之间的区别</a>。</p><p>通过加入<strong>防抖</strong>机制，控制<em>只有足够多空闲时间</em>才会触发进入特定层级的事件，让界面流畅了许多。</p><h2 id="性能优化策略3：预渲染栅格线"><a href="#性能优化策略3：预渲染栅格线" class="headerlink" title="性能优化策略3：预渲染栅格线"></a>性能优化策略3：预渲染栅格线</h2><p>在我们的业务需求中，有个特殊的需求是要将地图切分为边长为500米的方格，用绿橙黄红四色展示这块区域内的警情发生频率。</p><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1g38ww5fun5j31s00u0n1d.jpg" alt=""></p><p>由于这个需求是后面加的，我前面并没有绘制栅格线，因此选用了对百度地图更为友好的mapV。兄弟公司实现这个需求的时候选用的是<strong>高德地图+openLayer</strong>。后期又接到了任务让加上栅格，于是我进行了调研，想出了两种备选方案。</p><p>方案1是让后台将所有格子都返回，即使这里面没有警情，我们这边让他不填充，但是边界线也是会有的，这样实现需要的时间比较短，考虑到实际出现警情的区域比较稀疏，因此为了减少网络流量和后台工作量，由我这边产生，时间复杂度大约是<strong>O(NM)</strong>；</p><p>方案二是引入<strong>openlayer</strong>，进行绘制，但是这样的话需要上手一下openlayer，而且配合百度地图离线版也是有一定的难度的，很可能会有坑(网上已经看到了不少人提问)，但是时间复杂度可以优化到<strong>O(N+M)</strong>。</p><p>出于效率考虑，我先选择了方案一，并实现了该想法，但是系统不出意料地卡了起来，用户体验非常差，首次绘制需要等待大约5秒，每次移动都会卡一秒，卡顿感非常明显。于是我引入了<strong>滑动窗口</strong>的概念，仅将当前视图范围内和周边一点点范围所需展示的进行渲染，沿着拖动窗口方向<strong>预渲染</strong>，优化过后，非常流畅。</p><p>但事情并不总是一直顺利，很快就遇到了栅格与绘制出的正方形对不上的问题(见下图)，多次尝试仍有一点点的偏移量，最后我不得不人工干预，定位到栅格的四个顶点，进行绘制，这样才算是完美匹配了。只能说我有点<strong>完美主义</strong>+<strong>强迫症</strong>，喜欢做到完美。</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1g3acw1zuocj30s61dmq2x.jpg" alt=""></p><h2 id="图层-用隐藏代替重绘-用过滤代替加Layer实现内存的高效分配"><a href="#图层-用隐藏代替重绘-用过滤代替加Layer实现内存的高效分配" class="headerlink" title="图层:用隐藏代替重绘/用过滤代替加Layer实现内存的高效分配"></a>图层:用隐藏代替重绘/用过滤代替加Layer实现内存的高效分配</h2><p>最早实现的版本中，每次zoom到不同图层，我都是将Layer移除然后重新绘制，这样效率比较低，但在数据量不大的时候影响也确实在忍受范围之内。后面增加了对特定分局的过滤需求后发现如果还这么搞，就会非常麻烦。</p><p>所以通过对overlay增加Type和分局字段，控制当前需要过滤掉的分局和层级图层，实现内存的高效分配(不需要反复释放和生成图层)。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="http://www.cnblogs.com/well1010/articles/baidu-map-node-canvas.html" target="_blank" rel="external">node-canvas实现百度地图个性化底图绘制</a></li><li><a href="http://cntchen.github.io/2016/05/09/国内主要地图瓦片坐标系定义及计算原理/" target="_blank" rel="external">http://cntchen.github.io/2016/05/09/国内主要地图瓦片坐标系定义及计算原理/</a></li><li><a href="https://blog.csdn.net/xfxf996/article/details/81225330" target="_blank" rel="external">百度地图离线API及地图数据下载工具-尝鲜篇</a></li><li><a href="https://www.cnblogs.com/walls/p/6399837.html" target="_blank" rel="external">JavaScript函数节流和函数防抖之间的区别</a></li><li><a href="https://blog.csdn.net/zxt94/article/details/79657780" target="_blank" rel="external">高德地图和百度地图之间的坐标转换</a></li></ol><h1 id="爬虫代码"><a href="#爬虫代码" class="headerlink" title="爬虫代码"></a>爬虫代码</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line"><span class="string">"bytes"</span></div><div class="line"><span class="string">"fmt"</span></div><div class="line"><span class="string">"io"</span></div><div class="line"><span class="string">"io/ioutil"</span></div><div class="line"><span class="string">"math"</span></div><div class="line"><span class="string">"net/http"</span></div><div class="line"><span class="string">"os"</span></div><div class="line"><span class="string">"os/exec"</span></div><div class="line"><span class="string">"strconv"</span></div><div class="line"><span class="string">"strings"</span></div><div class="line"><span class="string">"sync"</span></div><div class="line"><span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 当前时间</span></div><div class="line"><span class="keyword">var</span> nowTime <span class="keyword">string</span> = time.Now().Format(<span class="string">"20060102150405"</span>)</div><div class="line"></div><div class="line"><span class="comment">// 阻塞队列</span></div><div class="line"><span class="keyword">var</span> waitgroup sync.WaitGroup</div><div class="line"></div><div class="line"><span class="comment">// 地球半径</span></div><div class="line"><span class="keyword">var</span> R <span class="keyword">float64</span> = <span class="number">6378137</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">fmt.Println()</div><div class="line"><span class="keyword">var</span> mins, maxs, confirm, ok, fls <span class="keyword">string</span></div><div class="line"></div><div class="line">fmt.Printf(<span class="string">"输入最小、大层级（半角逗号隔开）："</span>)</div><div class="line">fmt.Scanln(&amp;fls)</div><div class="line"></div><div class="line">fmt.Printf(<span class="string">"输入最小经、纬度（半角逗号隔开）："</span>)</div><div class="line">fmt.Scanln(&amp;mins)</div><div class="line"></div><div class="line">fmt.Printf(<span class="string">"输入最大经、纬度（半角逗号隔开）："</span>)</div><div class="line">fmt.Scanln(&amp;maxs)</div><div class="line"></div><div class="line"><span class="keyword">if</span> fls == <span class="string">""</span> || mins == <span class="string">""</span> || maxs == <span class="string">""</span> &#123;</div><div class="line">fmt.Println(<span class="string">"输入值为空！"</span>)</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 切割字符串</span></div><div class="line">mina := strings.Split(mins, <span class="string">","</span>)</div><div class="line">maxa := strings.Split(maxs, <span class="string">","</span>)</div><div class="line">fla := strings.Split(fls, <span class="string">","</span>)</div><div class="line"></div><div class="line">minLng, _ := strconv.ParseFloat(mina[<span class="number">0</span>], <span class="number">64</span>)</div><div class="line">minLat, _ := strconv.ParseFloat(mina[<span class="number">1</span>], <span class="number">64</span>)</div><div class="line">maxLng, _ := strconv.ParseFloat(maxa[<span class="number">0</span>], <span class="number">64</span>)</div><div class="line">maxLat, _ := strconv.ParseFloat(maxa[<span class="number">1</span>], <span class="number">64</span>)</div><div class="line"></div><div class="line">startZ, _ := strconv.Atoi(fla[<span class="number">0</span>])</div><div class="line">endZ, _ := strconv.Atoi(fla[<span class="number">1</span>])</div><div class="line"></div><div class="line"><span class="comment">// 取得地图中心坐标经纬度</span></div><div class="line">lngCen := (minLng + maxLng) / <span class="number">2.0</span></div><div class="line">latCen := (minLat + maxLat) / <span class="number">2.0</span></div><div class="line"></div><div class="line">fmt.Printf(<span class="string">"数据输入正确，是否开始下载？（Y/n）："</span>)</div><div class="line">fmt.Scanln(&amp;confirm)</div><div class="line"></div><div class="line"><span class="keyword">if</span> confirm == <span class="string">"n"</span> &#123;</div><div class="line">fmt.Println(<span class="string">"程序退出！"</span>)</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">ColorPrintln(<span class="string">"---------------------下载开始---------------------"</span>, <span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">// 开始执行时间</span></div><div class="line">startTime := time.Now()</div><div class="line"></div><div class="line">GetAllFloor(minLng, maxLng, minLat, maxLat, startZ, endZ)</div><div class="line"></div><div class="line"><span class="comment">// 计算执行耗时</span></div><div class="line">allTime := time.Since(startTime)</div><div class="line"></div><div class="line">fmt.Println(allTime)</div><div class="line"></div><div class="line"><span class="comment">// 复制预览文件</span></div><div class="line"><span class="comment">// _, _ = CopyFile("./demo.html", "./"+nowTime+"/index.html")</span></div><div class="line"></div><div class="line"><span class="comment">// 生成地图索引文件</span></div><div class="line">MkIndex(lngCen, latCen, fla[<span class="number">0</span>], fla[<span class="number">1</span>])</div><div class="line"></div><div class="line">fmt.Println(<span class="string">"下载完成！"</span>)</div><div class="line">fmt.Printf(<span class="string">"是否预览地图？（Y/n）："</span>)</div><div class="line"></div><div class="line">fmt.Scanln(&amp;ok)</div><div class="line"></div><div class="line"><span class="keyword">if</span> ok == <span class="string">"n"</span> &#123;</div><div class="line">fmt.Println(<span class="string">"程序退出！"</span>)</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">cmd := exec.Command(<span class="string">"cmd"</span>, <span class="string">"/C"</span>, <span class="string">"start ./"</span>+nowTime+<span class="string">"/index.html"</span>)</div><div class="line">cmd.Run()</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 获得所有层级瓦片图</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAllFloor</span><span class="params">(minLng <span class="keyword">float64</span>, maxLng <span class="keyword">float64</span>, minLat <span class="keyword">float64</span>, maxLat <span class="keyword">float64</span>, startZ <span class="keyword">int</span>, endZ <span class="keyword">int</span>)</span></span> &#123;</div><div class="line"><span class="comment">// 创建存储瓦片图总文件夹</span></div><div class="line">os.MkdirAll(<span class="string">"./"</span>+nowTime+<span class="string">"/tiles"</span>, os.ModePerm)</div><div class="line"></div><div class="line"><span class="keyword">for</span> z := startZ; z &lt;= endZ; z++ &#123;</div><div class="line">waitgroup.Add(<span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> GetOneFloor(minLng, maxLng, minLat, maxLat, z, nowTime)</div><div class="line">fmt.Println(strconv.Itoa(z))</div><div class="line">&#125;</div><div class="line"></div><div class="line">waitgroup.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 获得一个层级瓦片图</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetOneFloor</span><span class="params">(minLng <span class="keyword">float64</span>, maxLng <span class="keyword">float64</span>, minLat <span class="keyword">float64</span>, maxLat <span class="keyword">float64</span>, z <span class="keyword">int</span>, nowTime <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">url := <span class="string">"http://online1.map.bdimg.com/tile/?qt=tile&amp;styles=pl&amp;scaler=1&amp;udt=20180810&amp;z="</span> + strconv.Itoa(z)</div><div class="line"></div><div class="line">minX, maxX, minY, maxY := GetBound(minLng, maxLng, minLat, maxLat, z)</div><div class="line"></div><div class="line"><span class="keyword">var</span> path <span class="keyword">string</span></div><div class="line"><span class="keyword">var</span> dir <span class="keyword">string</span></div><div class="line"></div><div class="line">fdir := <span class="string">"./"</span> + nowTime + <span class="string">"/tiles/"</span> + strconv.Itoa(z) + <span class="string">"/"</span></div><div class="line"></div><div class="line">os.Mkdir(fdir, os.ModePerm)</div><div class="line"></div><div class="line"><span class="keyword">for</span> i := minX; i &lt;= maxX; i++ &#123;</div><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, minY <span class="keyword">int</span>, maxY <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">dir = fdir + strconv.Itoa(i)</div><div class="line">os.Mkdir(dir, os.ModePerm)</div><div class="line"><span class="keyword">for</span> j := minY; j &lt;= maxY; j++ &#123;</div><div class="line">path = url + <span class="string">"&amp;x="</span> + strconv.Itoa(i) + <span class="string">"&amp;y="</span> + strconv.Itoa(j)</div><div class="line"></div><div class="line">resp, _ := http.Get(path)</div><div class="line">body, _ := ioutil.ReadAll(resp.Body)</div><div class="line">out, _ := os.Create(dir + <span class="string">"/"</span> + strconv.Itoa(j) + <span class="string">".png"</span>)</div><div class="line">io.Copy(out, bytes.NewReader(body))</div><div class="line">&#125;</div><div class="line">&#125;(i, minY, maxY)</div><div class="line">&#125;</div><div class="line"></div><div class="line">waitgroup.Done()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 根据经纬度和层级转换瓦片图范围</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetBound</span><span class="params">(minLng <span class="keyword">float64</span>, maxLng <span class="keyword">float64</span>, minLat <span class="keyword">float64</span>, maxLat <span class="keyword">float64</span>, z <span class="keyword">int</span>)</span> <span class="params">(minX <span class="keyword">int</span>, maxX <span class="keyword">int</span>, minY <span class="keyword">int</span>, maxY <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">minX = <span class="keyword">int</span>(math.Floor(math.Pow(<span class="number">2.0</span>, <span class="keyword">float64</span>(z<span class="number">-26</span>)) * (math.Pi * minLng * R / <span class="number">180.0</span>)))</div><div class="line">maxX = <span class="keyword">int</span>(math.Floor(math.Pow(<span class="number">2.0</span>, <span class="keyword">float64</span>(z<span class="number">-26</span>)) * (math.Pi * maxLng * R / <span class="number">180.0</span>)))</div><div class="line"></div><div class="line">minY = <span class="keyword">int</span>(math.Floor(math.Pow(<span class="number">2.0</span>, <span class="keyword">float64</span>(z<span class="number">-26</span>)) * R * math.Log(math.Tan(math.Pi*minLat/<span class="number">180.0</span>)+<span class="number">1.0</span>/math.Cos(math.Pi*minLat/<span class="number">180.0</span>))))</div><div class="line">maxY = <span class="keyword">int</span>(math.Floor(math.Pow(<span class="number">2.0</span>, <span class="keyword">float64</span>(z<span class="number">-26</span>)) * R * math.Log(math.Tan(math.Pi*maxLat/<span class="number">180.0</span>)+<span class="number">1.0</span>/math.Cos(math.Pi*maxLat/<span class="number">180.0</span>))))</div><div class="line"></div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 复制文件</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(src, dst <span class="keyword">string</span>)</span> <span class="params">(w <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">srcFile, err := os.Open(src)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">fmt.Println(err.Error())</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> srcFile.Close()</div><div class="line"></div><div class="line">dstFile, err := os.Create(dst)</div><div class="line"></div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">fmt.Println(err.Error())</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">defer</span> dstFile.Close()</div><div class="line"></div><div class="line"><span class="keyword">return</span> io.Copy(dstFile, srcFile)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 生成地图索引文件</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MkIndex</span><span class="params">(lngCen, latCen <span class="keyword">float64</span>, startZ <span class="keyword">string</span>, endZ <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">fname := <span class="string">"./"</span> + nowTime + <span class="string">"/index.html"</span></div><div class="line">f, err := os.OpenFile(fname, os.O_CREATE|os.O_RDWR|os.O_APPEND, os.ModeAppend|os.ModePerm)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">fmt.Println(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line">content := <span class="string">`&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="string">&lt;html&gt;</span></div><div class="line"><span class="string">&lt;head&gt;</span></div><div class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></div><div class="line"><span class="string">&lt;title&gt;地图预览&lt;/title&gt;</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">&lt;link rel="stylesheet" href="../js/leaflet/leaflet.css" /&gt;</span></div><div class="line"><span class="string">&lt;style&gt;</span></div><div class="line"><span class="string">#map &#123;height: 800px;&#125;</span></div><div class="line"><span class="string">&lt;/style&gt;</span></div><div class="line"><span class="string">&lt;/head&gt;</span></div><div class="line"><span class="string">&lt;body&gt;</span></div><div class="line"><span class="string">&lt;div id="map"&gt;&lt;/div&gt;</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">&lt;script src="../js/leaflet/leaflet.js"&gt;&lt;/script&gt;</span></div><div class="line"><span class="string">&lt;script src="../js/proj4-compressed.js"&gt;&lt;/script&gt;</span></div><div class="line"><span class="string">&lt;script src="../js/proj4leaflet.js"&gt;&lt;/script&gt;</span></div><div class="line"><span class="string">&lt;script&gt;</span></div><div class="line"><span class="string">var center = &#123;</span></div><div class="line"><span class="string">lng: "`</span> + strconv.FormatFloat(lngCen, <span class="string">'f'</span>, <span class="number">-1</span>, <span class="number">64</span>) + <span class="string">`",</span></div><div class="line"><span class="string">lat: "`</span> + strconv.FormatFloat(latCen, <span class="string">'f'</span>, <span class="number">-1</span>, <span class="number">64</span>) + <span class="string">`"</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">// 百度坐标转换</span></div><div class="line"><span class="string">var crs = new L.Proj.CRS('EPSG:3395',</span></div><div class="line"><span class="string">   '+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs',</span></div><div class="line"><span class="string">   &#123;</span></div><div class="line"><span class="string">   resolutions: function () &#123;</span></div><div class="line"><span class="string">   level = 19</span></div><div class="line"><span class="string">   var res = [];</span></div><div class="line"><span class="string">   res[0] = Math.pow(2, 18);</span></div><div class="line"><span class="string">   for (var i = 1; i &lt; level; i++) &#123;</span></div><div class="line"><span class="string">   res[i] = Math.pow(2, (18 - i))</span></div><div class="line"><span class="string">   &#125;</span></div><div class="line"><span class="string">   return res;</span></div><div class="line"><span class="string">   &#125;(),</span></div><div class="line"><span class="string">   origin: [0, 0],</span></div><div class="line"><span class="string">   bounds: L.bounds([20037508.342789244, 0], [0, 20037508.342789244])</span></div><div class="line"><span class="string">   &#125;),</span></div><div class="line"><span class="string">map = L.map('map', &#123;</span></div><div class="line"><span class="string">   crs: crs</span></div><div class="line"><span class="string">   &#125;);</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">   L.tileLayer('./tiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png', &#123;</span></div><div class="line"><span class="string">   maxZoom: `</span> + endZ + <span class="string">`,</span></div><div class="line"><span class="string">   minZoom: `</span> + startZ + <span class="string">`,</span></div><div class="line"><span class="string">   subdomains: [0,1,2],</span></div><div class="line"><span class="string">   tms: true</span></div><div class="line"><span class="string">   &#125;).addTo(map);</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">   new L.marker([center.lat, center.lng]).addTo(map);</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">   map.setView([center.lat, center.lng], `</span> + startZ + <span class="string">`);</span></div><div class="line"><span class="string">&lt;/script&gt;</span></div><div class="line"><span class="string">&lt;/body&gt;</span></div><div class="line"><span class="string">&lt;/html&gt;`</span></div><div class="line"></div><div class="line">f.WriteString(content)</div><div class="line">f.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 彩色输出</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ColorPrintln</span><span class="params">(s <span class="keyword">string</span>, i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line"></div><div class="line">fmt.Println(s)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;近期实现了一个&lt;code&gt;时空可视分析系统&lt;/code&gt;的前端部分，帮助警方看到特定地区(主要为昆明)、特定时间段&lt;strong&gt;【时】&lt;/
      
    
    </summary>
    
      <category term="前端" scheme="http://zhihaozhang.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端学习笔记" scheme="http://zhihaozhang.github.io/tags/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>《重学前端》学习笔记</title>
    <link href="http://zhihaozhang.github.io/2019/03/07/RelarnFrontend/"/>
    <id>http://zhihaozhang.github.io/2019/03/07/RelarnFrontend/</id>
    <published>2019-03-07T07:20:06.037Z</published>
    <updated>2019-03-07T09:11:41.375Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>工作一年多，做了不少数据可视化相关的工作，也用过<em>React、Vue、Angular</em>之类的框架，所以也算是半个前端工程师吧。一次偶然的机会，在极客时间看到了<strong>winter</strong>老师的课程<code>《重学前端》</code>，就预购进行了学习，本文可看做是该课程的一个学习笔记，希望能帮自己形成一定的知识体系，<strong>沉淀沉淀</strong>。</p><h1 id="01-明确前端学习路线与方法"><a href="#01-明确前端学习路线与方法" class="headerlink" title="01 明确前端学习路线与方法"></a>01 明确前端学习路线与方法</h1><p>作者给出了两个学习前端的建议。第一个方法是：<code>建立知识架构</code>，在这个架构上不断进行优化。他认为架构可以理解为只是的<strong>目录</strong>或<strong>索引</strong>，能帮助我们将零散的知识<strong>组织</strong>起来，帮助我们发现知识上的盲区。</p><p>知识架构有好坏，比如说到js，可能会想到一些词:<em>类型转换、this、闭包、作用域链、原型链</em>等等，这就是一种不好的架构，因为这些关键词的关系之间没有逻辑关系。</p><p>作者给出的架构体系是:</p><ul><li>文法</li><li>语义</li><li>运行时</li></ul><blockquote><p>对于任何计算机语言来说，必定是“用规定的文法，去表达特定语义，最终操作运行时的”一个过程。</p></blockquote><p>文法可以分成词法和语法，来自编译原理的划分，是完备的。语义则跟语法具有一一对应关系，这里暂时不区分。对于运行时部分，这个划分保持了完备性，我们都知道：<code>程序 = 算法 + 数据结构</code>，<strong>那么，对运行时来说，类型就是数据结构，执行过程就是算法。</strong></p><p>建立知识架构，同样有利于面试，没人能够记住所有的知识，当不可避免地谈到一个记不住的知识，如果你能快速定位到它在知识架构中的位置，把一些相关的点讲出来，我想，这也能捞回不少分。</p><p>第二个方法是<code>追本溯源</code>。追本溯源，其实就是关注技术提出的背景，关注原始的论文或者文章，关注作者说的话。操作起来也非常简单：翻翻资料（一般wiki上就有）找找历史上的文章和人物，再顺藤摸瓜翻出来历史资料就可以了。这可以帮助我们理解为什么JS是现在这个样子了。</p><p>举例说明:有一些知识，涉及的概念本身经历了各种变迁，变得非常复杂和有争议性，比如<strong>MVC</strong>，从1979年至今，概念变化非常大，MVC的定义几乎已经成了一段公案，作者曾经截取了MVC原始论文、MVP原始论文、微软MSDN、Apple开发者文档，这些内容里面，MVC画的图、箭头和解释都完全不同。</p><h1 id="02-列一份前端知识架构图"><a href="#02-列一份前端知识架构图" class="headerlink" title="02 列一份前端知识架构图"></a>02 列一份前端知识架构图</h1><p>第二节就给出了第一节提出的知识架构图。<br><img src="https://static001.geekbang.org/resource/image/d1/a8/d1cb4040d91207075e0591abffe1b9a8.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;工作一年多，做了不少数据可视化相关的工作，也用过&lt;em&gt;React、Vue、Angular&lt;/em&gt;之类的框架，所以也算是半个前端工程师吧。
      
    
    </summary>
    
      <category term="前端" scheme="http://zhihaozhang.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端学习笔记" scheme="http://zhihaozhang.github.io/tags/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>《Swift必备Tips》读书笔记</title>
    <link href="http://zhihaozhang.github.io/2019/02/20/swifterTips/"/>
    <id>http://zhihaozhang.github.io/2019/02/20/swifterTips/</id>
    <published>2019-02-20T10:51:15.478Z</published>
    <updated>2019-03-05T13:31:11.280Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>本文是对<a href="https://onevcat.com" target="_blank" rel="external">喵神</a>编写的<a href="https://onev.cat/publication/swifter/" target="_blank" rel="external">《Swift必备Tips(第四版)》</a>的读书笔记，内容是我不太熟悉或觉得有用的Swift使用技巧,需要注意的是tips按照我的理解进行了一些<strong>合并和拆分</strong>。</p><p>不断更新中~</p><h1 id="将protocol的方法声明为mutating"><a href="#将protocol的方法声明为mutating" class="headerlink" title="将protocol的方法声明为mutating"></a>将protocol的方法声明为mutating</h1><p><code>mutating</code>关键字是用来在方法中修改struct或enum变量的，若不声明会报错。</p><h1 id="多元组Tuple"><a href="#多元组Tuple" class="headerlink" title="多元组Tuple"></a>多元组Tuple</h1><p>一个js中也有类似功能的东西，不适用额外空间完成交换的方式也和js中类似。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">swapMe2</span>&lt;T&gt;<span class="params">( a: <span class="keyword">inout</span> T, b: <span class="keyword">inout</span> T)</span></span> &#123;</div><div class="line">    (a,b) = (b,a)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1 id="autoclosure和？？、-escaping关键字"><a href="#autoclosure和？？、-escaping关键字" class="headerlink" title="@autoclosure和？？、@escaping关键字"></a>@autoclosure和？？、@escaping关键字</h1><h2 id="autoclosure"><a href="#autoclosure" class="headerlink" title="@autoclosure"></a>@autoclosure</h2><p>@autoclosure是把一句表达式自动封装成一个闭包，在语法上看起来会很漂亮。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">logIfTrue</span><span class="params">(<span class="number">_</span> predicate: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">Bool</span>) &#123;</div><div class="line">    <span class="keyword">if</span> predicate() &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"True"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">logIfTrue(<span class="number">2</span> &gt; <span class="number">1</span>) <span class="comment">// 2 &gt; 1会被自动封装为一个闭包</span></div></pre></td></tr></table></figure></p><h2 id="？？"><a href="#？？" class="headerlink" title="？？"></a>？？</h2><p>??关键字可以快速地对nil进行条件判断，左侧值是不为nil的Optional值时返回其value，等于nil的时候返回右侧值。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> ??&lt;T&gt;<span class="params">(<span class="keyword">optional</span>: T?, defaultValue: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">T</span>?) -&gt; <span class="type">T</span>?</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> ??&lt;T&gt;<span class="params">(<span class="keyword">optional</span>: T?, defaultValue: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">T</span>) -&gt; <span class="type">T</span></div></pre></td></tr></table></figure><p>??的两种实现都用到了@autoclosure关键字，主要是类似于短路表达式，左边不为nil时右边才有计算的需要，否则会造成浪费。从这里衍生出一条面试题，让你设计 || 或 &amp;&amp; 的实现，也是右边设计成一个闭包，右侧有计算必要的时候再进行计算。</p><p>最后要注意，@autoclosure不支持带输入参数的写法，只有形如()-&gt;T的参数才能使用这个特性进行简化。</p><h2 id="escaping"><a href="#escaping" class="headerlink" title="@escaping"></a>@escaping</h2><p>@escaping是用来表明某个闭包是可以“<code>逃逸</code>”的。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(block: <span class="params">()</span></span></span>-&gt;()) &#123;</div><div class="line">        block()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWorkAsync</span><span class="params">(block: @escaping <span class="params">()</span></span></span>-&gt;()) &#123;</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        block()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> foo = <span class="string">"foo"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> &#123;</div><div class="line">        doWork &#123;</div><div class="line">            <span class="built_in">print</span>(foo)</div><div class="line">        &#125;</div><div class="line">        foo = <span class="string">"bar"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method2</span><span class="params">()</span></span> &#123;</div><div class="line">        doWorkAsync &#123;</div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.foo)</div><div class="line">        &#125;</div><div class="line">        foo = <span class="string">"bar"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">S</span>().method1() <span class="comment">// foo</span></div><div class="line"><span class="type">S</span>().method2() <span class="comment">// bar</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">method3</span><span class="params">()</span></span> &#123;</div><div class="line">    doWorkAsync &#123;</div><div class="line">        [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>?.foo ?? <span class="string">"nil"</span>)</div><div class="line">    &#125;</div><div class="line">    foo = <span class="string">"bar"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">S</span>().method3() <span class="comment">// nil</span></div></pre></td></tr></table></figure><p>doWork不会”<strong>逃逸</strong>“，因此闭包的作用域不会超过函数本身，所以不需要担心闭包内持有self。而doWorkAsync则不同，由于需要确保闭包内成员有效性，如果在闭包内引用了self及其成员的话，需要强制明确的写出self。method3中，由于self已经被是否，因此输出nil。</p><h1 id="static和class-关键字"><a href="#static和class-关键字" class="headerlink" title="static和class 关键字"></a>static和class 关键字</h1><h2 id="异同点"><a href="#异同点" class="headerlink" title="异同点"></a>异同点</h2><p><strong>相同点</strong>：static和class都是表示“类型范围作用域”这一概念的。<br><strong>不同点</strong>：class是专门用在class类型的上下文中的，可以用来<em>修饰类方法和类属性。</em><br>class中现在是不能出现在class的存储属性的。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span>&#123;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">bar</span>: <span class="title">Bar</span>?</span></div><div class="line"><span class="class">&#125;</span></div></pre></td></tr></table></figure></p><p>会得到一个编译错误，class variables not yet supported，改成static就可以通过编译了。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>任何时候使用static都是没问题的。</p><h1 id="多类型和容器使用Any-AnyObject的技巧"><a href="#多类型和容器使用Any-AnyObject的技巧" class="headerlink" title="多类型和容器使用Any/AnyObject的技巧"></a>多类型和容器使用Any/AnyObject的技巧</h1><p>Swift中常用的原生容器类型有<code>Array/Dictionay/Set</code>，他们都是范型的，也就是说放在一个集合中的类型要一致。</p><p>但是Any可以让我们在容器中放各种类型的元素，但也不可避免的带来了<strong>部分信息损失</strong>，从容器中取出后还需要进行一次类型转换。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Any 类型可以隐式转换</span></div><div class="line"><span class="keyword">let</span> mixed: [<span class="type">Any</span>] = [<span class="number">1</span>, <span class="string">"two"</span>, <span class="number">3</span>]</div><div class="line"></div><div class="line"><span class="comment">// 转换为 [NSObject]</span></div><div class="line"><span class="keyword">let</span> objectArray = [<span class="number">1</span> <span class="keyword">as</span> <span class="type">NSObject</span>, <span class="string">"two"</span> <span class="keyword">as</span> <span class="type">NSObject</span>, <span class="number">3</span> <span class="keyword">as</span> <span class="type">NSObject</span>]</div><div class="line"></div><div class="line"><span class="comment">//建议的使用方式</span></div><div class="line"><span class="keyword">let</span> mixed: [<span class="type">CustomStringConvertible</span>] = [<span class="number">1</span>, <span class="string">"two"</span>, <span class="number">3</span>]</div><div class="line"></div><div class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> mixed &#123;</div><div class="line">    <span class="built_in">print</span>(obj.description)</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="改善方法一"><a href="#改善方法一" class="headerlink" title="改善方法一"></a>改善方法一</h2><p>作者认为，把这些不同类型的元素放到一个容器中，肯定是由于他们有<strong>共性</strong>，也就是这些元素服从某个共同的协议，这样虽有一定损失，但相对于Any或AnyObject还是改善了不少。</p><h2 id="改善方法二"><a href="#改善方法二" class="headerlink" title="改善方法二"></a>改善方法二</h2><p>另一种做法是用enum可以带有值的特点，将类型信息<code>封装到enum中</code>。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IntOrString</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">IntValue</span>(<span class="type">Int</span>)</div><div class="line">    <span class="keyword">case</span> <span class="type">StringValue</span>(<span class="type">String</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> mixed = [<span class="type">IntOrString</span>.<span class="type">IntValue</span>(<span class="number">1</span>),</div><div class="line">             <span class="type">IntOrString</span>.<span class="type">StringValue</span>(<span class="string">"two"</span>),</div><div class="line">             <span class="type">IntOrString</span>.<span class="type">IntValue</span>(<span class="number">3</span>)]</div><div class="line"></div><div class="line"><span class="keyword">for</span> value <span class="keyword">in</span> mixed &#123;</div><div class="line">    <span class="keyword">switch</span> value &#123;</div><div class="line">    <span class="keyword">case</span> <span class="keyword">let</span> .<span class="type">IntValue</span>(i):</div><div class="line">        <span class="built_in">print</span>(i * <span class="number">2</span>)</div><div class="line">    <span class="keyword">case</span> <span class="keyword">let</span> .<span class="type">StringValue</span>(s):</div><div class="line">        <span class="built_in">print</span>(s.capitalized)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="AnyClass"><a href="#AnyClass" class="headerlink" title="AnyClass"></a>AnyClass</h1><p>除了上面提到的Any和AnyObject，还有一个表示<strong>任意</strong>这个概念的东西<strong>AnyClass</strong>。在Swift中的定义方式:</p><blockquote><p>typealias AnyClass = AnyObject.Type</p></blockquote><p>得到的是一个元类型(Meta),存储的是一个类的类型本身。除了可以用元类型来调用类方法或类变量，还可以用在<strong>传递类型的时候，不需要不断地改动代码了。</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> usingVCTypes: [<span class="type">AnyClass</span>] = [<span class="type">MusicViewController</span>.<span class="keyword">self</span>,</div><div class="line">    <span class="type">AlbumViewController</span>.<span class="keyword">self</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupViewControllers</span><span class="params">(<span class="number">_</span> vcTypes: [AnyClass])</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> vcType <span class="keyword">in</span> vcTypes &#123;</div><div class="line">        <span class="keyword">if</span> vcType <span class="keyword">is</span> <span class="type">UIViewController</span>.<span class="type">Type</span> &#123;</div><div class="line">            <span class="keyword">let</span> vc = (vcType <span class="keyword">as</span>! <span class="type">UIViewController</span>.<span class="type">Type</span>).<span class="keyword">init</span>()</div><div class="line">            <span class="built_in">print</span>(vc)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">setupViewControllers(usingVCTypes)</div></pre></td></tr></table></figure></p><p>在编框架时，搭好框架后，用DSL的方式进行配置，就可以在不触及Swift编码的情况下，完成一系列复杂操作了。另外，Cocoa API中，也经常需要一个AnyClass的输入，如:self.tableView.registerClass(<br>    UITableViewCell.self, forCellReuseIdentifier: “myCell”)</p><h1 id="Self"><a href="#Self" class="headerlink" title="Self"></a>Self</h1><p>首字母大写的Self，通常用在协议内，指代实现协议的类型<strong>和子类</strong>。实现代理方法有点技巧。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Copyable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">()</span></span> -&gt; <span class="type">Self</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>: <span class="title">Copyable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> num = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">()</span></span> -&gt; <span class="type">Self</span> &#123;</div><div class="line">        <span class="keyword">let</span> result = type(of: <span class="keyword">self</span>).<span class="keyword">init</span>()</div><div class="line">        result.num = num</div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>直接使用MyClass()进行初始化是错误的，无法编译，因为该方法要求返回的是一个<strong>抽象的</strong>、表示当前类型的Self，而不是真实类型MyClass。type(of:)在js中也有，保证了方法与当前类型上下文无关，无论是MyClass还是它的子类，都可以正确地返回合适的类型，满足Self的要求。</p><p>注意需要有required关键字修饰init方法，<strong>保证当前类和子类都能响应init方法</strong>，否则type(of: self).init()可能会出错。另一个解决方法是申明class为<strong>final</strong>，保证不会有其他子类来继承这个类型，本质上也是保证type(of: self).init()不会出错。</p><h1 id="动态类型和多方法-amp-protocol-extension"><a href="#动态类型和多方法-amp-protocol-extension" class="headerlink" title="动态类型和多方法 &amp; protocol extension"></a>动态类型和多方法 &amp; protocol extension</h1><p>Swift默认是不采用动态派发的，方法调用在编译时决定。如果想绕开这个限制，需要手动对输入类型做判断与转换。如果没有判断，即使printThem的函数第一个参数传入Dog()，也是派发的Pet的printPet()方法。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printThem</span><span class="params">(<span class="number">_</span> pet: Pet, <span class="number">_</span> cat: Cat)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> aCat = pet <span class="keyword">as</span>? <span class="type">Cat</span> &#123;</div><div class="line">        printPet(aCat)</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> aDog = pet <span class="keyword">as</span>? <span class="type">Dog</span> &#123;</div><div class="line">        printPet(aDog)</div><div class="line">    &#125;</div><div class="line">    printPet(cat)</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>关于调用什么方法，在protocol extension这个tips里也有这个问题。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">A2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> -&gt; <span class="type">String</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">A2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hi"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method2</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hi"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B2</span>: <span class="title">A2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method2</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> a2 = b2 <span class="keyword">as</span> <span class="type">A2</span></div><div class="line"></div><div class="line">a2.method1() <span class="comment">// hello</span></div><div class="line">a2.method2() <span class="comment">// hi</span></div></pre></td></tr></table></figure></p><p>作者认为可以这样来理解：对于 method1，因为它在 protocol 中被定义了，因此对于一个被声明为遵守协议的类型的实例 (也就是对于 a2) 来说，可以确定实例必然实现了 method1，我们可以放心大胆地用<strong>动态派发</strong>的方式使用最终的实现 (不论它是在类型中的具体实现，还是在协议扩展中的默认实现)；但是对于 method2 来说，我们只是在协议扩展中进行了定义，没有任何规定说它必须在最终的类型中被实现。在使用时，因为 a2 只是一个符合 A2 协议的实例，编译器对 method2 唯一能确定的只是在协议扩展中有一个默认实现，<strong>因此在调用时，无法确定安全，也就不会去进行动态派发，而是转而编译期间就确定的默认实现。</strong></p><h1 id="final-关键字"><a href="#final-关键字" class="headerlink" title="final 关键字"></a>final 关键字</h1><p>上面提到了final，作者对final关键字的态度是:<strong>虽然final能告诉编译器这段代码不会被更改，但是提升的性能非常有限，建议先优化算法和图像相关的内容。</strong></p><p>final真正适用的几个场景:</p><ul><li>类方法或功能以及确实完备了，比如很难会重写计算字符串MD5或AES加密解密的工具类。</li><li>子类继承和修改是一件危险的事情，比如在某个公司管理的系统中我们对员工按照一定规则进行编号，这样通过编号我们能迅速找到任一员工。而假如我们在子类中重写了这个编号方法，很可能就导致基类中的依赖员工编号的方法失效。</li><li>为了父类中某些代码一定会被执行。比如有时候父类中有一些关键代码是在被继承重写后必须执行的 (比如状态配置，认证等等)，否则将导致运行时候的错误。</li></ul><h1 id="lazy-关键字"><a href="#lazy-关键字" class="headerlink" title="lazy 关键字"></a>lazy 关键字</h1><p>在构建和生成新的对象时，内存分配会在运行时耗费不少时间，如果有一些对象的属性和内容非常复杂，耗时不可忽略；另外，有些情况下，我们不会立即使用到一个对象的所有属性，默认初始化会将全部变量初始化，包括特定环境下的存储属性，这是一种浪费，懒加载就是为此而生。</p><p>lazy除了可以修饰属性，也有其他用法:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lazy</span>&lt;S : SequenceType&gt;<span class="params">(s: S)</span></span> -&gt; <span class="type">LazySequence</span>&lt;<span class="type">S</span>&gt;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lazy</span>&lt;S : CollectionType where S.Index : RandomAccessIndexType&gt;<span class="params">(s: S)</span></span></div><div class="line">                -&gt; <span class="type">LazyRandomAccessCollection</span>&lt;<span class="type">S</span>&gt;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lazy</span>&lt;S : CollectionType where S.Index : BidirectionalIndexType&gt;<span class="params">(s: S)</span></span></div><div class="line">                -&gt; <span class="type">LazyBidirectionalCollection</span>&lt;<span class="type">S</span>&gt;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lazy</span>&lt;S : CollectionType where S.Index : ForwardIndexType&gt;<span class="params">(s: S)</span></span></div><div class="line">                -&gt; <span class="type">LazyForwardCollection</span>&lt;<span class="type">S</span>&gt;</div><div class="line">                </div><div class="line"><span class="keyword">let</span> data = <span class="number">1</span>...<span class="number">3</span></div><div class="line"><span class="keyword">let</span> result = data.<span class="built_in">lazy</span>.<span class="built_in">map</span> &#123;</div><div class="line">    (i: <span class="type">Int</span>) -&gt; <span class="type">Int</span> <span class="keyword">in</span></div><div class="line">    <span class="built_in">print</span>(<span class="string">"正在处理 <span class="subst">\(i)</span>"</span>)</div><div class="line">    <span class="keyword">return</span> i * <span class="number">2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="string">"准备访问结果"</span>)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"操作后结果为 <span class="subst">\(i)</span>"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="string">"操作完毕"</span>)</div></pre></td></tr></table></figure><p>用来配合像map和filter这类接受闭包并进行运行的方法一起，让整个行为变成延时的。有lazy和无lazy的输出是完全不同的。<strong>对于那些不需要完全运行，可能提前退出的情况，使用lazy是进行性能优化的一种有效手段。</strong></p><h1 id="weak和unowned"><a href="#weak和unowned" class="headerlink" title="weak和unowned"></a>weak和unowned</h1><p>这两个关键字和<strong>内存管理</strong>关系紧密，主要是用来解决<em>计数机制</em>中的<em>循环引用</em>问题的。一般来说，我们希望“被动”的乙方不要去持有“主动”的一方。举一个例子：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> b: <span class="type">B</span></div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</div><div class="line">        b = <span class="type">B</span>()</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">        b.a = <span class="keyword">self</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">deinit</span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"A deinit"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    (<span class="keyword">weak</span>/<span class="keyword">unowned</span>) <span class="keyword">var</span> a: <span class="type">A</span>? = <span class="literal">nil</span></div><div class="line">    <span class="keyword">deinit</span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"B deinit"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在class B对A的声明前加上weak/unowned关键字，就可以保证内存正确的释放。weak和unowned的区别是:unowned设置以后，即使它原来引用的内容以及被释放了，它仍然会保持对已经释放对象的一个<strong>“无效的”</strong>引用，它不能Optional值，也不会指向nil。但此时如果继续调用，程序就会崩溃。相比之下，weak就友好不少，在应用的内容释放后，标记为weak的成员会自动地变为nil。Apple的建议是如果能够确定在访问时不会已经被释放的话，尽量使用unowned，试过存在被释放的可能性，那就用weak。</p><p>两个实际经常使用的场景:</p><ol><li>设置delegate。作者举了一个异步网络请求的例子，这种情况下无法保证在拿到返回时作为delegate的对象一定还存活，所以需要用<strong>weak</strong>关键字。</li><li>在self属性存储为闭包时，其中拥有对self的引用。闭包的例子非常经典，因为闭包中对任何其他元素的引用都是会被闭包自动持有的。如果我们在闭包中写了self，其实闭包内也持有了当前对象，如果当前实例直接或间接的有引用，就形成了self-&gt;闭包-&gt;self的循环引用。这种情况下使用哪个关键字的策略同上。</li></ol><h1 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h1><p>协议-委托(protocol-delegate)模式贯穿于整个Cocoa框架中，为代码之间的关系清理和解耦合做出了贡献。</p><p>上面已经提到了，在ARC中，对于一般的delegate，我们会在声明中将其指定为weak，这样实际对象被释放时，会被重置为nil。一种常见的错误是:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">MyClassDelegate</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method</span><span class="params">()</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</div><div class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">MyClassDelegate</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span>, <span class="title">MyClassDelegate</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">var</span> someInstance: <span class="type">MyClass</span>!</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidLoad()</div><div class="line"></div><div class="line">        someInstance = <span class="type">MyClass</span>()</div><div class="line">        someInstance.delegate = <span class="keyword">self</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">method</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"Do something"</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><blockquote><p>原因是Swift的Protocol不仅可以被class所遵守，也可以被struct和enum遵守，本身就不通过<strong>引用计数(ARC)</strong>来管理内存，所以也不可能用weak这样的ARC概念进行修饰。</p></blockquote><p>在Swift中使用weak delegate，有两种解决方式，主要思路都是将protocol限制在class内。</p><ol><li>在MyClassDelegate后面增加:class，使得只允许class遵守它；</li><li>在protocol前加上@objc,OC中只有类能实现protocol。</li></ol><h1 id="String和NSString"><a href="#String和NSString" class="headerlink" title="String和NSString"></a>String和NSString</h1><p>首先他们是可以无缝转换的，作者推荐尽可能使用String，原因有三：</p><ol><li>现在Cocoa所有的API都接受和返回String类型</li><li>String是struct，NSString是Object，String更符合字符串<strong>“不变”</strong>这一特性，在多线程编程时非常重要。另外，在不触及NSString特有操作和动态特性时，使用String的性能也更好。</li><li>String实现了Collection协议，而NSString没有，所以有些Swift语法特性只有String可以用。比如for…in枚举。String和Range配合没有NSString和NSRange配合方便。</li></ol><h1 id="GCD和延时调用、取消的封装"><a href="#GCD和延时调用、取消的封装" class="headerlink" title="GCD和延时调用、取消的封装"></a>GCD和延时调用、取消的封装</h1><p>GCD是一种非常方便的使用多线程的方式，在<em>“复杂必死”</em>的多线程编程中，保持简单就是避免错误的金科玉律。</p><p>作者给出的延时调用策略有两种，第一种不太推荐，是创建一个<strong>selector</strong>，因为它并不安全(需要通过字符串创建，改动代码比较危险)。第二种是使用<strong>asyncAfter</strong>。</p><p>另外作者将其进行了<strong>封装</strong>，并提供了取消的功能，调用起来非常方便。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typealias</span> <span class="type">Task</span> = (<span class="number">_</span> cancel : <span class="type">Bool</span>) -&gt; <span class="type">Void</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">delay</span><span class="params">(<span class="number">_</span> time: TimeInterval, task: @escaping <span class="params">()</span></span></span>-&gt;()) -&gt;  <span class="type">Task</span>? &#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">dispatch_later</span><span class="params">(block: @escaping <span class="params">()</span></span></span>-&gt;()) &#123;</div><div class="line">        <span class="keyword">let</span> t = <span class="type">DispatchTime</span>.now() + time</div><div class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: t, execute: block)</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">var</span> closure: (()-&gt;<span class="type">Void</span>)? = task</div><div class="line">    <span class="keyword">var</span> result: <span class="type">Task</span>?</div><div class="line"></div><div class="line">    <span class="keyword">let</span> delayedClosure: <span class="type">Task</span> = &#123;</div><div class="line">        cancel <span class="keyword">in</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> internalClosure = closure &#123;</div><div class="line">            <span class="keyword">if</span> (cancel == <span class="literal">false</span>) &#123;</div><div class="line">                <span class="type">DispatchQueue</span>.main.async(execute: internalClosure)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        closure = <span class="literal">nil</span></div><div class="line">        result = <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    result = delayedClosure</div><div class="line"></div><div class="line">    dispatch_later &#123;</div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> delayedClosure = result &#123;</div><div class="line">            delayedClosure(<span class="literal">false</span>)</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">(<span class="number">_</span> task: Task?)</span></span> &#123;</div><div class="line">    task?(<span class="literal">true</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用方法</span></div><div class="line"><span class="keyword">let</span> task = delay(<span class="number">2</span>) &#123;<span class="built_in">print</span>(<span class="string">"2秒后输出"</span>)&#125;</div><div class="line"></div><div class="line">cancel(task)</div></pre></td></tr></table></figure></p><h1 id="Lock的封装"><a href="#Lock的封装" class="headerlink" title="Lock的封装"></a>Lock的封装</h1><p>OC中的@synchronized关键字在Swift中已经不存在了，因此不得不帮助编译器实现这个关键字。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">synchronized</span><span class="params">(<span class="number">_</span> lock: AnyObject, closure: <span class="params">()</span></span></span> -&gt; ()) &#123;</div><div class="line">    objc_sync_enter(lock)</div><div class="line">    closure()</div><div class="line">    objc_sync_exit(lock)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">myMethodLocked</span><span class="params">(anObj: AnyObject!)</span></span> &#123;</div><div class="line">    synchronized(anObj) &#123;</div><div class="line">        <span class="comment">// 在括号内持有 anObj 锁</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 一个实际的线程安全的 setter 例子</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> _str = <span class="string">"123"</span></div><div class="line">    <span class="keyword">var</span> str: <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">get</span> &#123;</div><div class="line">            <span class="keyword">return</span> _str</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">set</span> &#123;</div><div class="line">            synchronized(<span class="keyword">self</span>) &#123;</div><div class="line">                _str = newValue</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    <span class="comment">// 下略</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>结合swift尾随闭包的语言特性，使用起来就跟OC很像了。</p><h1 id="属性访问控制"><a href="#属性访问控制" class="headerlink" title="属性访问控制"></a>属性访问控制</h1><p>Swift中由低至高提供了<strong>private/fileprivate/internal/public/open</strong>五种访问控制权限。默认值是internal。<br>private让代码只能在当前作用域或者同一文件中<em>同一类型</em>的作用域中被使用，fileprivate表示代码可以在当前文件中被访问，而<em>不做类型限定</em>。</p><p>作者认为:如果想让同意module或者target中的其他代码访问的话，保持默认的internal。如果在为其他开发者开发库的话，可能会希望用public甚至open，方便在target外调用。public和open的区别是，只有open的内容才能在别的框架中被继承或重写。因此，如果你只希望别人使用而不希望他们修改，就设为public，否则open。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;本文是对&lt;a href=&quot;https://onevcat.com&quot; target=&quot;_blank&quot; rel=&quot;externa
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="SwiftTips" scheme="http://zhihaozhang.github.io/tags/SwiftTips/"/>
    
  </entry>
  
  <entry>
    <title>仿微信朋友圈/抖音个人主页的设计与实现</title>
    <link href="http://zhihaozhang.github.io/2019/02/19/wechatMoment/"/>
    <id>http://zhihaozhang.github.io/2019/02/19/wechatMoment/</id>
    <published>2019-02-19T02:37:12.387Z</published>
    <updated>2019-02-19T07:44:14.055Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>因业务发展需要，在新版本的<a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external">Match问答</a>中，我们决定加入更多的社交元素，方便大家互相勾搭和交流，更多地展现自己的学习日常和个性，在原有版本的基础上计入了<em>动态</em>和<em>个人主页</em>两个模块，其中个人主页又分为<em>第一人称视图</em>和<em>第三人称视图</em>。本文是我在<em>春节假期期间</em>实现这两个模块的<strong>一点小心得</strong>。</p><p>期间参考了大量开源项目的已有代码，进行了借鉴和向Swift 4.2的改写，在此表示感谢，开源项目<em>不完整列表</em>见文末附录。</p><h1 id="用户自己的个人主页视图"><a href="#用户自己的个人主页视图" class="headerlink" title="用户自己的个人主页视图"></a>用户自己的个人主页视图</h1><h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><p>个人主页视图借鉴了最右这款非常受欢迎的应用，只不过上方的布局稍有不同。其实不止是最右，抖音、微博、知乎等App都有着非常类似的个人主页。</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g0bjpqiltvj30ye0u0acz.jpg" alt=""></p><blockquote><p>Match与最右的个人主页对比</p></blockquote><p>整个个人主页可分为两部分，第一部分是上方的头像、昵称、性别、个性签名、背景图片的区域；第二部分是下方的配置项，定制化的TableView。</p><p>头像外面加了一圈白色的圆，可以更突出头像部分，实现也比较简单，<strong>显式指定</strong>头像所属imageView的layer的borderWidth和borderColor即可，<strong>当然前提是已经将头像裁剪为圆形</strong>。</p><p>Tableview的分割线起始位置的定制:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, willDisplay cell: UITableViewCell, forRowAt indexPath: IndexPath)</span></span> &#123;</div><div class="line">        tableView.tableFooterView = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">0</span>, height: <span class="number">0</span>))</div><div class="line">        tableView.separatorInset = <span class="type">UIEdgeInsets</span>(top: <span class="number">0</span>, <span class="keyword">left</span>: <span class="number">50</span>, bottom: <span class="number">0</span>, <span class="keyword">right</span>: <span class="number">0</span>)</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>比起其他应用，我还有一个功能没实现，那就是下拉的时候背景图片的放大。研究过OC代码后，发现这个功能也不难，主要实现方式是didscroll代理方法中监听滑动的偏移量，作为控制image的zoom倍率依据。</p><p><img src="https://raw.githubusercontent.com/QuintGao/GKPageScrollView/master/GKPageScrollViewDemo/gif/wy.gif" alt=""></p><blockquote><p>头图下拉放大效果</p></blockquote><h2 id="更换背景和头像事件"><a href="#更换背景和头像事件" class="headerlink" title="更换背景和头像事件"></a>更换背景和头像事件</h2><p>更换头像和背景思路是类似的，都是给一个图片增加手势事件的识别，通常有两种实现方式。第一种是比较土味的方法，给图片覆盖上一层透明的button，将button设为与图片形状一样；第二种方式是给imageView加上UITapGestureRecognizer，比较简单就不再赘述。</p><p>添加或更改图片涉及到图片拉伸的问题，因此需要进行裁剪，头像的比例是1：1，而背景图片比较复杂，为了适应各种手机型号的屏幕，宽度拉到与屏幕等宽，高度和宽度维持一个固定的宽高比，当然这对用户应该是透明的，将裁剪方式的选择权还给用户。</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1g0bkwkb6rcj30u01szq45.jpg" alt=""></p><blockquote><p>图片裁剪页</p></blockquote><h1 id="他人个人主页的实现"><a href="#他人个人主页的实现" class="headerlink" title="他人个人主页的实现"></a>他人个人主页的实现</h1><h2 id="布局-1"><a href="#布局-1" class="headerlink" title="布局"></a>布局</h2><p>社交的重要一部分是去其他人的个人主页看看，其他人的个人主页和用户自己看自己的个人主页肯定是有区别的。用户自己的主页主要是一个去各种设置的中转站，用户看别人的主页主要是看他人的<em>头像、签名、背景、收入、问答、动态等内容</em>。</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1g0bprodsijg30om1hcb2h.gif" alt=""></p><blockquote><p>他人个人主页视图</p></blockquote><p>上半部分和个人主页是一样的设计，下半部分有不同，是一个在其他应用中很受欢迎的左右滑动的Tab，暂且将其命名为swipe view。</p><h2 id="实现的关键点与细节"><a href="#实现的关键点与细节" class="headerlink" title="实现的关键点与细节"></a>实现的关键点与细节</h2><p>为了让用户可以右滑退出这个页面，我将下方的swipe view的左边距设为了10px，这样方便用户用手势进行退出，保留着navigation ViewController的退出方式。</p><p>这个页面的难点是<strong>嵌套scrollview的冲突处理</strong>，整个页面是被一个scrollview包裹起来的，而swipe view中也是scrollview，这里设定了上方有view的时候，使得滑动相应外层滑动事件，而当swipe view滑动至顶部的时候，将swipe view头固定于信号栏下方，此时的滑动事件相应者为swipe view中的scrollview。</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1g0bqfoepukj31kw0qe3zs.jpg" alt=""></p><blockquote><p>去除了业务逻辑的关键代码片段 (made with Carbonize)</p></blockquote><p>固定住外层scrollview的主要实现方式是设置<strong>scrollview.contentOffset.y</strong>变量，当swipe view在scrollview中的坐标位置小于某个值的时候，设定scrollview.contentOffset.y为一个定值，这样就固定住了swipe view的表头部分。注意，开始的时候我设定的是isUserInteractionEnabled属性，这样swipe内的所有内容都不能交互了，比如正常的图片也不能点开看大图了。后面改成了isScrollEnabled，这样就不影响除了滑动外的其他操作了。</p><h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>其实现在实现这个功能还有点美中不足，那就是固定住scrollview是一个滑动操作，而要想接着对swipe view中的scrollview进行滑动，必须再滑动一次，也就是中间必须中断一次。目前还不知道如何将一次滑动操作发给两个响应者进行处理。</p><h1 id="朋友圈的设计与实现"><a href="#朋友圈的设计与实现" class="headerlink" title="朋友圈的设计与实现"></a>朋友圈的设计与实现</h1><p>微信朋友圈的<strong>点赞、留言、回复功能</strong>是很多应用都需要的功能，在实现这个功能的时候，我参考了不少优秀的blog和开源代码，并最终选中了【附录4】的OC实现进行了向Swift 4.2的改写，后面根据自己的需求进行了一些定制，主要是点击点赞和评论用户名跳转到他的个人主页。</p><h2 id="朋友圈的两种实现方式"><a href="#朋友圈的两种实现方式" class="headerlink" title="朋友圈的两种实现方式"></a>朋友圈的两种实现方式</h2><p>【附录6】里介绍了朋友圈有两种主要实现方式，第一种是将每条动态作为TableView的一个cell，然后cell内部的点赞、评论又作为一个TableView，其中点赞作为Header view，每条评论作为二级cell。布局依赖Masonry，是自动布局autolayout技术，并且依赖第三方缓存cell高度进行优化，这种实现方式作者认为代价比较高。<strong>主要是页面结构复杂，依赖第三方库Masonry，集成难度较大。</strong></p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1g0bqzhdnqaj30xh0u07c9.jpg" alt=""></p><blockquote><p>微信朋友圈的两种实现思路</p></blockquote><p>方式二是一个tableView，cell用来展示评论数据，headerView用来展示头像、发布文字和时间等等，主要优化策略也是缓存cell高度，保证后续滑动tableview不会重复计算，提升流畅度，我改写的库也答题是这种思路。</p><h2 id="点赞超链接的实现"><a href="#点赞超链接的实现" class="headerlink" title="点赞超链接的实现"></a>点赞超链接的实现</h2><p>点赞超链接主要是借助<strong>NSAttributedString/NSMutableAttributedString</strong>，让用户名高亮为蓝色，并附带上User_id的信息，统一跳转到上文实现的第三人称视图中。</p><h2 id="一个优化过的点"><a href="#一个优化过的点" class="headerlink" title="一个优化过的点"></a>一个优化过的点</h2><p>朋友圈里有个点我觉得对于用户体验的提升还蛮有优化意义的，那就是防止弹出的键盘遮挡住原动态和评论，下面给出参考的实现方式，主要思路是得到当前的cell，使其滑动。</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1g0brs0e0gbj31bw0tedh3.jpg" alt=""></p><blockquote><p>使得tableview上滑的代码(made with Carbonize)</p></blockquote><h2 id="可优化的点"><a href="#可优化的点" class="headerlink" title="可优化的点"></a>可优化的点</h2><p>可优化的点还有很多，作者也列出了一些供大家参考。</p><ol><li>cell复用机制+sectionView复用机制 </li><li>将cell的高度和cell里控件的frame存在model里</li><li>减少cell内部控件的层级，层级不易太深</li><li>缩略图和大图URL（拿起大刀让后台兄弟去完成，因为后台不提供缩略图功能，朋友圈很容易内存警告） </li><li>图片圆角cornerRadius,缓存圆角等等</li><li>高度缓存（cell评论区高度+section区头高度）</li><li>异步加载渲染(图片+文本+view)（利用SDWebImage异步下载图片，文本和view没完成异步处理）</li></ol><h1 id="参考-amp-致谢"><a href="#参考-amp-致谢" class="headerlink" title="参考&amp;致谢"></a>参考&amp;致谢</h1><ol><li><a href="https://github.com/sprint84/PhotoCropEditor" target="_blank" rel="external">PhotoCropEditor</a></li><li><a href="https://github.com/QuintGao/GKPageScrollView" target="_blank" rel="external">GKPageScrollView</a></li><li><a href="https://github.com/yysskk/SwipeMenuViewController" target="_blank" rel="external">SwipeMenuViewController</a></li><li><a href="https://github.com/ChellyLau/MomentKit" target="_blank" rel="external">MomentKit</a></li><li><a href="https://www.jianshu.com/p/395bac3648a7" target="_blank" rel="external">iOS 实现微信朋友圈评论回复功能</a></li><li><a href="https://blog.csdn.net/wenmingzheng/article/details/78081127" target="_blank" rel="external">朋友圈评论回复的两种实现方式</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;因业务发展需要，在新版本的&lt;a href=&quot;https://itunes.apple.com/cn/app/match问答/id141472
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS开发" scheme="http://zhihaozhang.github.io/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Google Flutter Live 18笔记与观后感</title>
    <link href="http://zhihaozhang.github.io/2018/12/23/ABitOfFlutter/"/>
    <id>http://zhihaozhang.github.io/2018/12/23/ABitOfFlutter/</id>
    <published>2018-12-23T03:07:21.122Z</published>
    <updated>2018-12-23T09:25:45.348Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在上一篇博客<a href="http://zhihaozhang.github.io/2018/12/22/FlutterLive/">Flutter live 18之后的移动开发技术综述</a>中，我基于自己比较肤浅的认知，对比了原生开发和跨平台开发，以及各大主流跨平台开发的优缺点，并引出了本文的主角Flutter。恰逢Flutter Live 18刚结束不久，Google中国在B站上也给出了<a href="https://www.bilibili.com/video/av38438700/?redirectFrom=h5" target="_blank" rel="external">Flutter Live ‘18 视频合集</a>，而且是中英文双字幕的良心资源。</p><p>本文可以理解为我看该视频合集过程中的一些笔记和一些观(流)后(水)感(账)。</p><h1 id="Flutter-live-18发布会"><a href="#Flutter-live-18发布会" class="headerlink" title="Flutter live 18发布会"></a>Flutter live 18发布会</h1><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fygoy5kriqj30zl0u0wfj.jpg" alt=""></p><blockquote><p>主持人Tim Sneath</p></blockquote><p>刚登台，主持人就激动了，难掩满面的笑意，足以见得他是对今天的发布会多么的有<strong>信心</strong>。</p><p>这次发布会被分割为了5个视频，分别是:</p><ol><li>官宣Flutter 1.0发布</li><li>Flutter设计主题</li><li>Flutter开发主题</li><li>FLutter live 五大两点</li><li>One More Thing<br>这篇博客也将分成这几个Section进行。</li></ol><h2 id="官宣Flutter-1-0发布"><a href="#官宣Flutter-1-0发布" class="headerlink" title="官宣Flutter 1.0发布"></a>官宣Flutter 1.0发布</h2><p>首先是主持人对所有开发Flutter的工程师表示感谢，他们中有web和移动平台的佼佼者，甚至有<em>HTML标准的前编辑</em>、<em>WebKit和Blink的主要开发者</em>和<em>Javascript V8引擎的开发者</em>这种级别的<strong>大咖</strong>，以及<em>上千社区人员</em>帮助提issue、提供补丁、引入新特性，在大家的集体努力下，造就了今天的<strong>Flutter</strong>。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fygpb01tndj318q0n6jru.jpg" alt=""></p><blockquote><p>Flutter四大特性</p></blockquote><p>在主持人看来，Flutter的出现，让用户在性能和开发速度方面二选一的窘境不复存在了。从商业上讲，公司<strong>再也不需要组建iOS组和Android组两支团队了</strong>。</p><p>为了佐证Flutter的四大特性，他们特意开发了一个叫<strong><a href="https://itunes.apple.com/cn/app/the-history-of-everything/id1441257460?mt=8" target="_blank" rel="external">History</a></strong>的app，在苹果商店/安卓商店都是可以下载到的。请了另一个工程师上来演示了该应用，交互、动画无论在今年的旗舰机亦或是五年前的iPhone 5s上，都能达到60fps，非常流畅。这主要得益于<em>Skia 2D</em>引擎，直接向显卡绘制图像，所有的像素都归开发者管理，因此无论设计师给出什么原画稿，都是可以实现的，而且是以<strong>60fps</strong>的速度渲染出来。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fygprc5iuyj311m0p8abu.jpg" alt=""></p><blockquote><p>运行在Flutter应用中的Google地图</p></blockquote><p>Demo过程中，果然有彩蛋，那就是运行在Flutter应用中的支持交互的Google地图。有种苹果画中画的感觉，不过在Flutter中，也就是个普通的<strong>Widget</strong>而已啦。常规操作、常规操作，虽然台下已经尖叫声一片了。我在iPhone 6和X上都下载了该应用，都非常流畅，大家如果有兴趣的也可以下载下来试试。</p><p>话筒交还给主持人，主持人上台以极富激情，甚至有点破音的语气宣布了<em>Flutter 1.0的发布</em>，正式摘掉了Flutter <strong>Beta</strong>的帽子，虽然已经有相当多的(大约3000+ APPs)成功案例了。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fygpx9uowrj31880mu3zd.jpg" alt=""></p><blockquote><p>Flutter 1.0之前取得的一些成绩</p></blockquote><p>个人认为，Flutter 1.0的发布也是在提醒所有开发者可以来学习了，<strong>不管你学不学的动，反正劳资就要更新。</strong></p><h2 id="Flutter-设计主题"><a href="#Flutter-设计主题" class="headerlink" title="Flutter 设计主题"></a>Flutter 设计主题</h2><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fygq20v2v8j318m0geq36.jpg" alt=""></p><blockquote><p>一个APP的从0到1</p></blockquote><p>接下来，主持人将应用从0到1切分为了4个部分，分别是<strong>设计、开发、与在线服务连接以及发布。</strong></p><p>首先介绍的是设计部分，由Material Design Team的will介绍。他一上台就说到了好的设计是非常昂贵的，而且设计师给出的设计闪光的地方很难实现，最后只能在让体验更为出色的细节上选择了妥协。最终交付出一个可用但不够好的应用出来，并美名曰后面改善，但<strong>Later Never Comes</strong>，对于代码的重构，道理也是一样。</p><p>这个部分我深有感触，为了赶工期，妥协设计师设计稿里真正精华的部分。但有了Flutter，就可以打破这一循环，因为Flutter就是<strong>Designed for Good Design</strong>。Material Design team实现了一套非常精美的Widgets，使得应用更灵活、富有表现力。不仅开箱即用，而且很容易扩展。除了Material，还有苹果的设计语言iOS风格的cupertino，就像从UIkit里拿出来的那样。不同的是，由于开源，开发者可以进去看源码，但对iOS private API却无法做到。</p><p>后面请上了获奖应用Reflectly的联合创始人上台一起进行分享。他负责UX/UI和前端的开发，首先是打了一波他们产品的广告，好像是一个日记类应用。后面以主持人采访他的形式展开，这是他第一个应用，前端就他一个人，仅使用<strong>2个半月</strong>就完成了学习和开发的全过程。</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fygqkmb2ehj30vc0m6q3j.jpg" alt=""></p><p>后面请上了和谷歌合作的2Dimensions公司负责人，他们带来了一款可以将矢量动画作为一个Widget直接嵌入到Flutter应用中的工具<a href="https://medium.com/2dimensions/flare-launch-d524067d34d8" target="_blank" rel="external">Flare</a>。Flare打破了传统的模式，无需再单独开发应用和动画，然后再转换成设备资源和代码，这部分的工作由设计师完成即可，减轻了程序员的负担，也促进了程序员和设计师的合作，设计师也更深入地参与到了应用的全过程。</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fygqt4rx5rg30hs0a2qaq.gif" alt=""></p><blockquote><p>Flare Demo</p></blockquote><h2 id="Flutter-开发主题"><a href="#Flutter-开发主题" class="headerlink" title="Flutter 开发主题"></a>Flutter 开发主题</h2><h3 id="Live-Coding"><a href="#Live-Coding" class="headerlink" title="Live Coding"></a>Live Coding</h3><p>回归到开发的主题，请出了Emily和Matt两个人上台进行现场开发，以体现开发过程是多么的<strong>愉快</strong>。两个人给我的感觉像是被代码耽误了的相声演员，演讲非常棒。他们也确实在12分钟内展示了如何开发出一个精美的应用，并与现场观众进行交互。</p><p>除了展示了开发的高效，还重点展示了热重载对于调试方面效率的重大提升。这个部分上篇博客有所提及，在这就不重复提了，重点看一下Flutter 1.0的新特性：<br><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fygr07kagdj315e0l23yz.jpg" alt=""></p><p>首先是更好的遵守了iOS设计规范，加入了很多针对iOS的widgets。另外接入了近 20 种 Firebase 服务、上文提到的Google Maps，以及不断优化性能、压缩由Flutter打包的应用大小。此外，也悉心听取了来自Flutter社区的反馈，解决了大量的问题。</p><p>另外，Flutter正式使用Dart 2.1作为编程语言，它增强了性能，减少了code体积，可以提供更快的类型检查以及更有用的类型错误提示信息。语言新特性也使得开发构建过程变得更快。实际上，在刷twitter的过程中，我也确实看到了很多人对Dart 2.1性能的提升表示了赞赏。</p><h3 id="connet"><a href="#connet" class="headerlink" title="connet"></a>connet</h3><p>接下来是开发的另一个板块，链接外部服务。这个部分的完善主要是靠生态系统，Flutter核心部分被尽可能的压缩了，开发者可以根据自己的需要引入外部<a href="https://pub.dartlang.org/flutter" target="_blank" rel="external">Packages</a>，当然这些库也是全部开源的。</p><p>为了展示使用外部Packages，邀请了另一位工程师上台展示了machine learning库<em>ML Kit</em>和摄镜头库的使用，开发了一个根据人面部表情显示动画人物表情的应用。</p><p>移动支付作为常见的应用常见，在Flutter里也获得了很好的支持。这个部分是由知名支付服务商Square公司负责人上台介绍的，他们带来了两个全新的<a href="https://squareup.com/flutter" target="_blank" rel="external">支付SDK</a>，在使用Square支付识读器直接支付还是使用手机应用进行支付两方面都简化了支付操作和服务，估计国内的支付宝和微信团队很快会跟进吧。</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fygrgi493gj30u00mh0v3.jpg" alt=""></p><blockquote><p>Square支付在销售水果的家族农场中的应用</p></blockquote><h3 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h3><p>持续集成环节请出的是Flutter的合作伙伴Nevercode，他们发布了<a href="https://codemagic.io/" target="_blank" rel="external">Codemagic</a>,一款针对Flutter设计的，简化了iOS和Android应用编译和打包处理的过程的工具。看她在现场通过在Github上选了一些项目，然后点了几下就可以生成包括测试在内的一整套的处理流程，通知会发送到Slcak channel内，感觉非常方便。</p><p>其实在发布iOS应用过程中，用Xcode的发布工具也不难，只是前段时间苹果服务器好像抽风过，引来网上大片吐槽。</p><h2 id="One-More-Thing"><a href="#One-More-Thing" class="headerlink" title="One More Thing"></a>One More Thing</h2><p>One More Thing其实是乔布斯非常喜欢用的手段，在发布会最后发布一些改变世界的东西。这次的Flutter live也增加了这一环节，足见这一环节宣的重要性。这个环节的大新闻就是:</p><blockquote><p>Flutter不仅局限于移动端，也可以跑在<em>macOS/windows/Linux</em>，甚至<strong>网页</strong>上！</p></blockquote><p>实际上，Flutter live 18的演讲幻灯片正是跑在macOS上的程序，现场掌声雷动，关于macOS上写Flutter程序，可以参考<a href="https://juejin.im/post/5c1873f66fb9a04a0d56c72b?utm_source=gold_browser_extension" target="_blank" rel="external">使用 Flutter 开发 macOS App</a>。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fygs18tlrrj30u007xq2z.jpg" alt=""></p><p>Dart不仅可以被编译为本机ARM代码，还可以被编译为用于生产环境的Javascript代码。现场demo了一个还处于实验室开发阶段实验性项目，<strong><a href="https://mp.weixin.qq.com/s/UwnUBj3cJ5WJeeluZ71i8w" target="_blank" rel="external">Hummingbird</a></strong>，一个基于Web实现的<em>Flutter Runtime</em>，这个项目可以让Flutter能够无需改动地运行在Web平台。现场展示了一个类似华容道的网页应用。现场还给出了一篇文章，介绍了Hummingbird背后的更多技术细节， <a href="https://medium.com/flutter-io/hummingbird-building-flutter-for-the-web-e687c2a023a8" target="_blank" rel="external">Hummingbird: Building Flutter for the Web</a>，预计在明年的Google IO上发布。</p><p>最后是Flutter的Engineering Manager Eric上台发表温情演讲，回顾了做Flutter的初衷，并表达了对社区的感谢。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我在原生iOS开发方面有着比较深厚的技术积累，最近也在读React Virtual DOM部分的源码，因此Flutter对我来说非常亲切，很容易就上手了。关于Flutter，我觉得很不舒服的一点是一切皆Widget，连Center这种样式都被设计成了Widget，因此很容易写出类似回调地狱的<strong>Widget地狱</strong>，或许后面会有第三方的DSL library出现吧，这点确实想念JSX的语法。</p><p>我觉得Flutter对于前端开发者来说，是一个不能绕过的主题，这也是我决定写这篇笔记的原因，希望更多的人能在更短的时间内看完Flutter Live 18并知晓Flutter的存在，因为它必将改变大前端开发的方式。</p><p>谢谢您抽出宝贵的时间阅读，欢迎留言与我讨论。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://www.bilibili.com/video/av38438700/?redirectFrom=h5" target="_blank" rel="external">Flutter Live ‘18 视频合集</a></li><li><a href="https://itunes.apple.com/cn/app/the-history-of-everything/id1441257460?mt=8" target="_blank" rel="external">History on App Store</a></li><li><a href="https://medium.com/2dimensions/flare-launch-d524067d34d8" target="_blank" rel="external">Flare</a></li><li><a href="https://pub.dartlang.org/flutter" target="_blank" rel="external">Flutter Packages</a></li><li><a href="https://squareup.com/flutter" target="_blank" rel="external">Square支付SDK</a></li><li><a href="https://codemagic.io/" target="_blank" rel="external">Codemagic</a></li><li><a href="https://juejin.im/post/5c1873f66fb9a04a0d56c72b?utm_source=gold_browser_extension" target="_blank" rel="external">使用 Flutter 开发 macOS App</a></li><li><a href="https://medium.com/flutter-io/hummingbird-building-flutter-for-the-web-e687c2a023a8" target="_blank" rel="external">Hummingbird: Building Flutter for the Web</a></li><li><a href="https://mp.weixin.qq.com/s/UwnUBj3cJ5WJeeluZ71i8w" target="_blank" rel="external">Hummingbird: Web 里的 Flutter</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;在上一篇博客&lt;a href=&quot;http://zhihaozhang.github.io/2018/12/22/FlutterLive/&quot;&gt;F
      
    
    </summary>
    
      <category term="Flutter" scheme="http://zhihaozhang.github.io/categories/Flutter/"/>
    
    
      <category term="Flutter" scheme="http://zhihaozhang.github.io/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter live 18之后的移动开发技术综述</title>
    <link href="http://zhihaozhang.github.io/2018/12/22/FlutterLive/"/>
    <id>http://zhihaozhang.github.io/2018/12/22/FlutterLive/</id>
    <published>2018-12-22T02:55:04.074Z</published>
    <updated>2018-12-23T01:37:56.495Z</updated>
    
    <content type="html"><![CDATA[<h1 id="移动开发技术"><a href="#移动开发技术" class="headerlink" title="移动开发技术"></a>移动开发技术</h1><p>移动开发技术泛指手机端的应用开发，平台主要有iOS和Android。移动开发技术大体目前可分为两类，一类是<strong>原生开发</strong>，一类是<strong>跨平台开发</strong>。</p><p>两者各有优缺点，先给出大佬的观点:</p><blockquote><p>移动端Web开发就像用店里买的锅炒菜，稳定快捷，做家常菜足够了。而native开发就好像不但要做菜，还要亲自打一口最合适自己的锅。虽然速度不快，虽然成本很高，但是想要做出最好吃的拿手菜，用店里的锅就是做不出那个味道。 ​​​​    ———即刻iOS leader JasonYuh</p></blockquote><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1545461964211&amp;di=1038f58e9d429567c6485c62a6226e38&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.swootech.com%2FUploadFiles%2F2018%2F2%2F2018061110010414053.jpg" alt=""></p><h2 id="原生开发"><a href="#原生开发" class="headerlink" title="原生开发"></a>原生开发</h2><p>原生开发是指使用特定语言(如<strong>Kotlin</strong>与<strong>Swift</strong>)调用系统SDK开发的应用。在接触Flutter之前，我属于这类开发人员。对于原生开发，我总结出如下的优缺点:</p><h3 id="原生开发的优点"><a href="#原生开发的优点" class="headerlink" title="原生开发的优点"></a>原生开发的优点</h3><ul><li>速度快，性能好，用户体验佳，原汁原味</li><li>开发人员多，社区比较完善，可用的第三方库健全</li><li>可访问平台的所有功能，如iPhone X的前置深度相机进行面部识别、蓝牙、GPS等</li><li>有谷歌和苹果的工程师每年召开开发者大会WWDC/Google IO，更新SDK，演讲介绍best practice</li></ul><h3 id="原生开发的缺点"><a href="#原生开发的缺点" class="headerlink" title="原生开发的缺点"></a>原生开发的缺点</h3><ul><li>开发成本高，人力成本大，需要两班人马</li><li>功能更新或内容更新需要发布新版本，有审核周期</li><li>Swift ABI不稳定，Swift版本升级维护工作量大，因此保守的国内公司大部分代码还是用OC</li></ul><p>上面两点是我在开发<a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external">Match问答</a>的过程中深有体会的两点。我与朋友分别开发和维护iOS和Android客户端，版本迭代的人力成本是翻倍的。任何的修改都要提交审核，通常第一次审核遇到的麻烦比较多，后面审核相对比较顺利，但也要平均两天的时间，这对于高速变化的互联网时代一定是不可接受的。</p><h1 id="跨平台技术"><a href="#跨平台技术" class="headerlink" title="跨平台技术"></a>跨平台技术</h1><p>针对原生开发人力成本和动态化不足的缺点，诞生了一些跨平台的动态化框架。根据原理可大体分为三类:</p><ul><li>Html5+Webview渲染的Hybrid APP</li><li>以ReactNative为代表的JS开发+原生渲染</li><li>以Flutter为代表的自绘UI+Native</li></ul><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyffdnnxq3j30dy07dglk.jpg" alt=""></p><blockquote><p>跨平台技术与原生技术示意图 (图片来源:知乎用户 @易旭昕)</p></blockquote><h2 id="Flutter之外的跨平台技术"><a href="#Flutter之外的跨平台技术" class="headerlink" title="Flutter之外的跨平台技术"></a>Flutter之外的跨平台技术</h2><h3 id="Html5-Webview渲染的Hybrid-APP"><a href="#Html5-Webview渲染的Hybrid-APP" class="headerlink" title="Html5+Webview渲染的Hybrid APP"></a>Html5+Webview渲染的Hybrid APP</h3><p>第一类技术主要是利用原生控件<strong>Webview</strong>渲染网页，加载前端工程师开发好的已适配手机端的网页，这类应用也被称为<strong>Hybrid APP</strong>。它确实解决了原生开发带来的人力成本与动态性不够的问题。</p><p>它最大的缺点是性能问题，Webview可以理解为一个浏览器内核，上文提到的蓝牙、前置摄像头这些资源是无权访问到的。若使用到这些功能，需要用JS与原生API通信，这个部分是由<strong>JSBridge</strong>完成的。涉及到<strong>通信</strong>事情就复杂起来了，需要指定协议(规定消息的格式含义等)，性能也随之降低。</p><h3 id="以ReactNative为代表的JS开发-原生渲染"><a href="#以ReactNative为代表的JS开发-原生渲染" class="headerlink" title="以ReactNative为代表的JS开发+原生渲染"></a>以ReactNative为代表的JS开发+原生渲染</h3><p>第二类技术在第一类技术的基础上进行了改进，将不堪重负的Webview替换为了原生渲染。以React Native为例，它借助React的<strong>Virtual DOM</strong>技术，在RN中将其渲染为原生控件树，从而大幅提升了渲染效率。</p><p>响应式编程也是React提出的一个重要思想，状态(State)改变，则UI随之改变。这样开发者只需要处理和关注状态的变化，剩下的交给框架完成，得益于Diff算法，框架可以高效的完成DOM更新操作。</p><p>如此看来，React真是非常<strong>伟大</strong>。Vue的作者也在一个讨论React与Vue的帖子下大方承认，再过若干年，React的历史功绩肯定在Vue之上。Flutter中也从中大量借鉴了宝贵经验。关于两者的<em>布局、构建、渲染、更新机制</em>，后面可以展开单写一篇博客。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyfgjgs816j30w808mgm3.jpg" alt=""></p><blockquote><p>Flutter的渲染、绘制机制示意图(图片来源:知乎用户 @JoeyChi)</p></blockquote><p>国内厂商也进行了尝试，比如阿里的<strong><a href="http://weex.apache.org/cn/guide/" target="_blank" rel="external">Weex</a></strong>和华为小米等国内厂商制定的<strong><a href="https://www.quickapp.cn" target="_blank" rel="external">快应用</a></strong>。</p><p>相比于第一类解决方案，第二类解决方案性能已经提升蛮多的了，但还是无法避开Javascript与原生的通信。而且作为<strong>解释性</strong>的语言，Javascript的性能好不到哪里去。</p><p>另外，当iOS/Android系统更新后，控件可能会更新，也就是虚拟DOM渲染的目标就更新了，因此不可避免的会有一段时间的空档期，等待社区控件的更新。</p><h2 id="Flutter"><a href="#Flutter" class="headerlink" title="Flutter"></a>Flutter</h2><h3 id="Flutter的改进与性能"><a href="#Flutter的改进与性能" class="headerlink" title="Flutter的改进与性能"></a>Flutter的改进与性能</h3><p>Flutter抛弃了JS，使用了可编译为机器码的Dart作为编程语言，底层Engine层包含了 Skia渲染引擎以及文字处理引擎，自绘了UI，同时支持iOS的<strong>Cupertino</strong>风格与Android的<strong>Material</strong>风格。</p><p>正是因为较好的解决了上面的问题，<em>Flutter</em>声称可以达到<strong>媲美原生</strong>的效果。关于原生与Flutter的性能对比，可以参考<a href="https://juejin.im/post/5b85e9f86fb9a01a175dc986" target="_blank" rel="external">Flutter和原生应用性能对比</a>。</p><blockquote><p>在假设他能够做到独立、第三方的前提下，结论是:android 原生在内存、CPU 资源占用方面要低于 flutter，并且安装包的体积也要小于 flutter，所以，不考虑其他因素，单纯从性能角度来说，android 原生肯定是要优于 flutter 的。但 flutter 也有它的优点，比如跨平台的开发、毫秒级的热重载等等，另外跨端开发也逐渐的流行起来，所以，我们在学好android原生的基础上，对跨端开发也要抱有积极的心态。</p></blockquote><h3 id="Flutter的历史"><a href="#Flutter的历史" class="headerlink" title="Flutter的历史"></a>Flutter的历史</h3><p><strong>Flutter</strong>是谷歌最早于2017年5月推出的一套<em>跨平台、开源UI框架</em>，初衷是同时支持<strong>iOS、Android</strong>开发，并且是传说中的操作系统<strong>Fuchsia</strong>的默认开发套件，使用<strong>Dart</strong>语言编写。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyffezmcv5j30u007taad.jpg" alt=""></p><h3 id="Flutter的特点"><a href="#Flutter的特点" class="headerlink" title="Flutter的特点"></a>Flutter的特点</h3><p>其实学习Flutter有一段时间了，他的优点挺多，官方总结如下：</p><ul><li>界面精美</li><li>速度快</li><li>支持热重载</li><li>开放</li></ul><p>就我自己使用Flutter一段时间以来的实际体验，展开介绍一下。Flutter一直强调对屏幕的像素级掌控，让开发者不受限的堆叠任何图形、视频、文本和控件。Flutter内置的<strong>Widgets</strong>非常精美，最大程度的实现了Material Desig，因此应用的外观<strong>下限</strong>是有保证的(^_^)。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fyffmoe4hoj31bc0r6wgu.jpg" alt=""></p><blockquote><p>Flutter官方给出界面样例</p></blockquote><p><em>速度快是Flutter的初心，媲美原生应用的速度是他的口号。</em> 性能方面无需多言，相比于其他跨平台方案是有优势的，但比原生还是有一些差距。特别是iOS平台，由于没有内置Skia 2D加速图形引擎，会使IPA包的大小多出一截。</p><p>支持热重载这点对于开发者来说是非常爽的，开发者做出一点点修改，不用重启整个应用，经历漫长的等待了，在亚秒级别的等待后就能看到更新，非常方便。另外，即使出错了，也可以记住Context，在开发者修复代码后，恢复之前的Context，不用担心typo或者测试过程中，错误很难复现的问题。综合以上两点，Flutter称之为<strong>Stateful Hot Reload</strong>。</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fyfgpqmct1j31gm0t8djh.jpg" alt=""></p><blockquote><p>Flutter开发界面，支持热重载</p></blockquote><p>Flutter是开源的，插件也丰富，有类似于cocoa pod和npm的<a href="https://pub.flutter-io.cn" target="_blank" rel="external">社区</a>，不需要重复造轮子了，开发者也可以发布自己的轮子给别人使用。同时，也可以像使用React一样，仅仅将Flutter作为view层的解决方案，逻辑使用Kotlin或Swift进行开发。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文介绍了目前市面上针对移动开发的主流技术，并比较了他们的优缺点，并引出了Flutter。在下一篇文章中，我们详细介绍Flutter live 18这次大会发布了什么，以及引入的新特性。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://juejin.im/post/5b85e9f86fb9a01a175dc986" target="_blank" rel="external">Flutter和原生应用性能对比</a></li><li><a href="https://www.weibo.com/jasonyuh?is_all=1#_rnd1545449174555" target="_blank" rel="external">JasonYuh的微博</a></li><li><a href="https://zhuanlan.zhihu.com/p/52723705" target="_blank" rel="external">Joey的Flutter之旅</a></li><li><a href="https://zhuanlan.zhihu.com/p/37894353" target="_blank" rel="external">关于 Flutter 的一些想法</a></li><li><a href="https://flutterchina.club" target="_blank" rel="external">Flutter中文网</a></li><li><a href="https://pub.flutter-io.cn" target="_blank" rel="external">Dart Packages</a></li><li><a href="https://flutterchina.club/flutter-for-ios/" target="_blank" rel="external">Flutter for iOS 开发者</a></li><li><a href="https://flutterchina.club/web-analogs/" target="_blank" rel="external">Flutter for Web开发者</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;移动开发技术&quot;&gt;&lt;a href=&quot;#移动开发技术&quot; class=&quot;headerlink&quot; title=&quot;移动开发技术&quot;&gt;&lt;/a&gt;移动开发技术&lt;/h1&gt;&lt;p&gt;移动开发技术泛指手机端的应用开发，平台主要有iOS和Android。移动开发技术大体目前可分为两类，一类是&lt;
      
    
    </summary>
    
      <category term="Flutter" scheme="http://zhihaozhang.github.io/categories/Flutter/"/>
    
    
      <category term="Flutter" scheme="http://zhihaozhang.github.io/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>两个大屏可视化案例的实现</title>
    <link href="http://zhihaozhang.github.io/2018/11/25/BigScreen/"/>
    <id>http://zhihaozhang.github.io/2018/11/25/BigScreen/</id>
    <published>2018-11-25T06:42:28.720Z</published>
    <updated>2018-12-04T12:04:34.953Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>近期分别使用了<strong>React</strong>和<strong>Vue</strong>完成了两个大屏可视化案例，经历了设计师和产品经理的各种<strong>“指指点点”</strong>，也算是对可视化大屏项目有了一点点小的经验，对于两个技术栈写组件也有一点小心得，趁着周末总结一下。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxkbayd3qjj317x0u0h6r.jpg" alt=""></p><blockquote><p>大屏效果图1</p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxkbblzzmzj317w0u0gyo.jpg" alt=""></p><blockquote><p>大屏效果图2</p></blockquote><h1 id="可视化大屏"><a href="#可视化大屏" class="headerlink" title="可视化大屏"></a>可视化大屏</h1><p>无论是在科幻电影还是在真实世界里，可视化大屏都是非常常见的一种表现手法。之前在昆明公安局出差，也亲眼看到了<em>湄公河惨案</em>的真实指挥中心和他的大屏，屏幕的宽度大约有两层楼高。</p><h2 id="可视化大屏的特性"><a href="#可视化大屏的特性" class="headerlink" title="可视化大屏的特性"></a>可视化大屏的特性</h2><p>可视化大屏，<em>归根到底还是运用的可视化技术</em>，只不过展现的屏幕比起笔记本和显示器大了很多。相比于传统的桌面级可视化运用，大屏可视化的特性有:</p><ol><li>屏幕巨大，用户通常离屏幕比较远，文字表达出来的信息需要足够清楚，通常要在字体和颜色上做文章。</li><li>弱化交互，基于键盘和鼠标的交互方式很少，更多时候系统自己做出响应，而不是让人工介入。</li><li>视觉冲击力强，设计一般都是以深色为底色，一来科技感十足，二来可以配合突出的主体动画和强设计感的元素。</li><li>场景化，一块大屏通常用来展示一类场景，场景主要由图表构成，后台管理系统那套表单通常不会出现在大屏。</li><li>动画更重要了，用动画表现出来的数据，通常是大屏项目中<strong>最迷人</strong>的地方。说动画是大屏项目的<strong>灵魂</strong>也不为过。案例一的那条红线被设计师称为<strong>“画龙点睛”之笔</strong>。</li></ol><h2 id="Vue和React可视化组件的实现"><a href="#Vue和React可视化组件的实现" class="headerlink" title="Vue和React可视化组件的实现"></a>Vue和React可视化组件的实现</h2><p>不作为一个整体看大屏项目，其实还是一个个小的组件。在实现两个项目的过程中，由于上海和南京两地团队的<strong>技术栈差异</strong>，使用了Vue和React两种框架。于是我只能看了一晚上Vue之后就上手去写Vue的组件。两个大屏案例之间有共同的组件，不需要整个重写，只需要改写即可；改写的过程中，我也比较深刻体会到了两者的不同。</p><p>由于宽高的不确定性，做组件的第一步是<em>获取组件在大屏上的宽高</em>。</p><ul><li>React获取宽高的方式<br>React获取宽高的方式比较标准，分为三步:在render的时候ref，在did的时候取值，在构造方法create。在生命周期函数的钩子里实现相应方法即可。</li><li>Vue获取宽高的方式<br>Vue似乎<strong>更自由</strong>一些，直接在mouted钩子里就可以拿到相应组件的clientWidth。</li></ul><p>宽高确定了，组件内部的元素和字体大小要进行相应比例的放缩，达到自适应的效果。在我的案例里使用的是d3和bizchart来完成图的绘制，d3中我大量使用了linearScale进行插值计算，而bizChart就更为简单，框架帮你完成了自适应。</p><p>动画部分通常会涉及一些元素的增加，有增加就不能缺少释放，这是内存管理的一个铁律。在完成第一个大屏的过程中，为了完成粒子放射的效果，我增加了很多粒子，起先没有将他们释放掉，只是从视觉上藏了起来，这造成了系统一段时间后会很卡。</p><p>在做组件的过程中，还需注意组件内部的样式<em>不能影响外部</em>。由于粗心，我就出现了这样的一个小错误，楠哥说如果在其他公司是要扣KPI的。</p><h2 id="大屏的自动布局和宽高自适应"><a href="#大屏的自动布局和宽高自适应" class="headerlink" title="大屏的自动布局和宽高自适应"></a>大屏的自动布局和宽高自适应</h2><p>可视化大屏的布局部分也是一个重要的部分。在我们的案例中，使用了纯css3的<strong>vw、vh</strong>实现自适应。</p><h3 id="视口单位"><a href="#视口单位" class="headerlink" title="视口单位"></a>视口单位</h3><h4 id="视口"><a href="#视口" class="headerlink" title="视口"></a>视口</h4><p>在业界，极为推崇的一种理论是 Peter-Paul Koch (江湖人称“PPK大神”)提出的关于视口的解释——在桌面端，视口指的是在桌面端，指的是浏览器的可视区域；而在移动端较为复杂，它涉及到三个视口：分别是 Layout Viewport（布局视口）、 Visual Viewport（视觉视口）、Ideal Viewport。(<strong>大屏一般是桌面端</strong>)</p><h4 id="视口单位-1"><a href="#视口单位-1" class="headerlink" title="视口单位"></a>视口单位</h4><p>根据CSS3规范，视口单位主要包括4个：</p><ol><li>vw : 1vw 等于视口宽度的1%</li><li>vh : 1vh 等于视口高度的1%</li><li>vmin : 选取 vw 和 vh 中最小的那个</li><li>vmax : 选取 vw 和 vh 中最大的那个</li></ol><p>视口单位区别于%单位，视口单位是依赖于视口的尺寸，根据视口尺寸的百分比来定义的；而%单位则是依赖于元素的祖先元素。</p><p>用视口单位度量，视口宽度为100vw，高度为100vh，相当于将宽高分别分成了100份。</p><h3 id="利用视口单位适配页面"><a href="#利用视口单位适配页面" class="headerlink" title="利用视口单位适配页面"></a>利用视口单位适配页面</h3><p>利用视口单位适配页面通常有两种方法，做法一仅使用vw作为CSS单位，使用Sass函数编译。做法二搭配vw和rem，布局更优化。做法二是更为优秀的做法，我们也采用了这种方法，两点原因：</p><ol><li>用户视觉体验更好，增加了最大最小宽度的限制；</li><li>如果选择主流的rem弹性布局方式作为项目开发的适配页面方法，那么做法二更适合于后期项目从 rem 单位过渡到 vw 单位。</li></ol><h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>由于是公司的项目，不同于我个人的项目可以开源，本文更多的讲的是<em>道</em>上的东西，术上的东西并没有过多涉及，甚至没有一行样例代码。<br><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxkd6bwxirj31n50u0gyp.jpg" alt=""></p><blockquote><p>真实的效果图</p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxntmgsn9vj31400u041o.jpg" alt=""></p><blockquote><p>真实的演示现场</p></blockquote><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxuyudi023j31hc0u079f.jpg" alt=""></p><blockquote><p>另一个演示现场</p></blockquote><p>最后还是希望本文能给大家带来一些启发和收获。</p><p>感谢设计师Joseph的设计和督促，让我还原度较高的完成了这次大屏任务。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;近期分别使用了&lt;strong&gt;React&lt;/strong&gt;和&lt;strong&gt;Vue&lt;/strong&gt;完成了两个大屏可视化案例，经历了设计师和
      
    
    </summary>
    
      <category term="visualization" scheme="http://zhihaozhang.github.io/categories/visualization/"/>
    
    
      <category term="大屏可视化" scheme="http://zhihaozhang.github.io/tags/%E5%A4%A7%E5%B1%8F%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Match开发笔记 伍 3.0版的新功能与上架</title>
    <link href="http://zhihaozhang.github.io/2018/10/31/match5/"/>
    <id>http://zhihaozhang.github.io/2018/10/31/match5/</id>
    <published>2018-10-31T12:14:56.953Z</published>
    <updated>2018-11-19T04:45:11.496Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Match问答3.0版本近期在<a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external">App Store</a>和各大安卓市场上架了，此次更新，我们让应用进一步完善。主要新功能有：</p><ol><li>增加图片放缩、移动和本地保存的功能；</li><li>增加对<strong>图文混排</strong>的支持;</li><li>增加对问题关键词和问题难度的系统评判，并基于问题难度提升问题的奖励；</li><li>增加对问题的重新编辑功能；</li><li>修改赞/踩按钮点击延迟的bug；</li><li>优化部分界面UI</li></ol><p>先放张主页预览图。<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fx7nk0w9orj30u01sz42r.jpg" alt=""></p><h1 id="图文混排富文本"><a href="#图文混排富文本" class="headerlink" title="图文混排富文本"></a>图文混排富文本</h1><p>图文混排是本次升级的<strong>主要工作</strong>，也让我比较深入了学习了<strong>TextKit</strong>相关的知识。富文本在Github上可用的轮子不多，我试用了接近10个自带富文本的应用，发现基本都不可用，大部分是基于<em>Webview</em>的包装。</p><p>其实富文本是<em>历史遗留问题</em>，从Match1.0版本的时候就很想要这个功能，但苦于一直没有找到合适的轮子，一直在回避，用文字超链接的方式跳转到详情页，一直安慰自己小图反正也看不清。但看到知乎将图片拉到与手机屏幕等宽，效果还蛮好的，而且阿里云OSS也比较强大，可以支持很多参数,于是开始着手做富文本这块。基于我们系统前后台的json标准，我采取了一种<strong>递归</strong>的方式来解析文本，将图片的特殊标志替换成需要的图片，并提取出key，从阿里云获取相应的图片，插入到textview的合适位置上，参考实现如下:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertImage</span><span class="params">(image: UIImage, imageName:String)</span></span> &#123;</div><div class="line">        <span class="keyword">let</span> attString = createAttStringWithImage(image: image, height: imageheight, imageName: imageName)</div><div class="line">        </div><div class="line">        <span class="comment">//add this attributed string to the current position.</span></div><div class="line">        <span class="keyword">self</span>.textStorage.insert(attString, at: <span class="keyword">self</span>.selectedRange.location)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insertImage</span><span class="params">(image : UIImage , index : Int, imageName:String)</span></span>&#123;</div><div class="line">        <span class="keyword">let</span> attrString = createAttStringWithImage(image: image, height: imageheight/<span class="number">2</span>,imageName: imageName)</div><div class="line">        <span class="keyword">self</span>.textStorage.insert(attrString, at: index)</div><div class="line">        <span class="keyword">self</span>.adjustUITextViewHeight()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createTextStorageByText</span><span class="params">(text : String , num : Int)</span></span> -&gt; [<span class="type">String</span>]&#123;</div><div class="line">        <span class="keyword">if</span>(text.<span class="built_in">count</span> == num &amp;&amp; <span class="keyword">self</span>.flag == <span class="literal">false</span>)&#123;</div><div class="line">            <span class="keyword">self</span>.flag = <span class="literal">true</span></div><div class="line">            <span class="keyword">return</span> []</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> pic_names : [<span class="type">String</span>] = []</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(text.<span class="built_in">count</span> &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">self</span>.flag) &#123;</div><div class="line">            <span class="keyword">if</span>(text.hasPrefix(<span class="string">"&lt;--image_link--&gt;"</span>))&#123;</div><div class="line">                <span class="keyword">var</span> tmpOffset = <span class="number">0</span></div><div class="line">                <span class="keyword">while</span>((text.substring(from: tmpOffset, to: text.<span class="built_in">count</span>).hasPrefix(<span class="string">"&lt;/--image_link--&gt;"</span>))==<span class="literal">false</span>)&#123;</div><div class="line">                    tmpOffset = tmpOffset + <span class="number">1</span></div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                pic_names.append(text.substring(from: <span class="string">"&lt;--image_link--&gt;"</span>.<span class="built_in">count</span> , to : tmpOffset))</div><div class="line">                </div><div class="line">                <span class="keyword">if</span>(<span class="keyword">self</span>.image_names.<span class="built_in">contains</span>(text.substring(from: <span class="string">"&lt;--image_link--&gt;"</span>.<span class="built_in">count</span> , to : tmpOffset))==<span class="literal">false</span>)&#123;</div><div class="line">                    <span class="keyword">self</span>.image_names.append(text.substring(from: <span class="string">"&lt;--image_link--&gt;"</span>.<span class="built_in">count</span> , to : tmpOffset))</div><div class="line">                    </div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="keyword">self</span>.readProvider = (<span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span>).readProvider</div><div class="line">                <span class="keyword">self</span>.readClient   = (<span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span>).readClient</div><div class="line">                <span class="keyword">self</span>.bucketName   = (<span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span>).bucketName</div><div class="line">                </div><div class="line">                    <span class="keyword">let</span> getObjectReq: <span class="type">OSSGetObjectRequest</span> = <span class="type">OSSGetObjectRequest</span>()</div><div class="line">                    getObjectReq.bucketName = <span class="keyword">self</span>.bucketName</div><div class="line">                    getObjectReq.objectKey =  text.substring(from: <span class="string">"&lt;--image_link--&gt;"</span>.<span class="built_in">count</span> , to : tmpOffset)</div><div class="line">                    getObjectReq.xOssProcess = <span class="string">"image/resize,m_fill,h_100,w_<span class="subst">\(screenw)</span>,Q_60"</span></div><div class="line">                    getObjectReq.downloadProgress = &#123; (bytesWritten: <span class="type">Int64</span>,totalBytesWritten : <span class="type">Int64</span>, totalBytesExpectedToWrite: <span class="type">Int64</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">                    &#125;;</div><div class="line">                    <span class="keyword">let</span> task: <span class="type">OSSTask</span> = <span class="keyword">self</span>.readClient.getObject(getObjectReq);</div><div class="line">                    task.<span class="keyword">continue</span>(&#123;(t) -&gt; <span class="type">OSSTask</span>&lt;<span class="type">AnyObject</span>&gt;? <span class="keyword">in</span></div><div class="line">                        <span class="keyword">if</span>(task.error == <span class="literal">nil</span>)&#123;</div><div class="line">                            <span class="keyword">let</span> avatar = task.result</div><div class="line">                            <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">                                <span class="keyword">if</span>(<span class="type">UIImage</span>(data: (avatar?.downloadedData)!) != <span class="literal">nil</span>)&#123;</div><div class="line">                                    <span class="keyword">let</span> image = <span class="type">UIImage</span>(data: (avatar?.downloadedData)!)!</div><div class="line">                                    </div><div class="line">                                    </div><div class="line">                                    <span class="keyword">self</span>.insertImage(image: image, imageName: text.substring(from: <span class="string">"&lt;--image_link--&gt;"</span>.<span class="built_in">count</span> , to : tmpOffset))</div><div class="line">                                    </div><div class="line">                                    </div><div class="line">                                    <span class="keyword">self</span>.offset = <span class="keyword">self</span>.offset + tmpOffset + <span class="string">"&lt;/--image_link--&gt;"</span>.<span class="built_in">count</span></div><div class="line">                                    </div><div class="line"><span class="comment">//                                    self.adjustUITextViewHeight()</span></div><div class="line">                                    </div><div class="line">                                    <span class="keyword">var</span> tmp_pic_names = <span class="keyword">self</span>.createTextStorageByText(text: text.substring(from: tmpOffset + <span class="string">"&lt;/--image_link--&gt;"</span>.<span class="built_in">count</span> , to: text.<span class="built_in">count</span>), num: <span class="number">1000086</span>)</div><div class="line">                                    </div><div class="line">                                    </div><div class="line">                                    tmp_pic_names.<span class="built_in">map</span>&#123; pic <span class="keyword">in</span></div><div class="line">                                        pic_names.append(pic)</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                                </div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">                    &#125;)</div><div class="line">                    task.waitUntilFinished()</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">self</span>.appendLinkString(string: text.substring(from: <span class="number">0</span>, to: <span class="number">1</span>))</div><div class="line">                <span class="keyword">if</span>(text.<span class="built_in">count</span> &gt; <span class="number">1</span>)&#123;</div><div class="line">                    <span class="keyword">var</span> tmp_pic_names = <span class="keyword">self</span>.createTextStorageByText(text: text.substring(from: <span class="number">1</span>), num: <span class="number">1000086</span>)</div><div class="line">                    <span class="keyword">self</span>.offset = <span class="keyword">self</span>.offset + <span class="number">1</span></div><div class="line">                    </div><div class="line">                    tmp_pic_names.<span class="built_in">map</span>&#123; pic <span class="keyword">in</span></div><div class="line">                        pic_names.append(pic)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">         <span class="keyword">return</span> pic_names</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>需要注意的是插入图片的操作要放到<strong>主线程</strong>。当然，实际过程中也遇到了一些问题，比如为了让两张连续图片中间有一定距离，引入了<strong>行距</strong>。但是如果这个<em>问题/回答</em>本身并没有文字，只有图片，行距是不生效的，这种情况就需要在前面加入\t制表符。</p><p>这次允许编辑用户自己之前发表过的问题或回复，当然也是涉及富文本的，图片提交之前判断了以前是不是保存过了，还是新添加的。</p><p>插入图片后，Tableview中富文本Cell的高度自动计算就不正确了，需要自己给出高度的计算方法。这里，我设置了图片的高度为100，宽度为屏幕等宽，因此需要统计图片的数量。还需要统计的是\n的数量、文字的数量，这部分是乘以行距和行高也是Cell高度的有效组成部分。</p><p>这个部分内容较多，在这先不展开了，后面有机会仔细写一下，顺便把这个<strong>richtext</strong>轮子<em>开源</em>。目前还不能称作轮子，是辆整车，需要将业务从现有代码中抽离，尽量做的通用一些。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fx7t3dnaxgj30uc0ns1au.jpg" alt=""></p><blockquote><p>富文本改造前后对比</p></blockquote><h1 id="上架过程"><a href="#上架过程" class="headerlink" title="上架过程"></a>上架过程</h1><p>和以往不同，这次的上架过程显得异常艰难，遇到了很多困难。首先是打包的时候报错。</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx7t76tk3mj315e0p0dy9.jpg" alt=""></p><p>因为之前真机测试和模拟器测试都是没有报错的，在周日晚上发现了这个问题，必然会影响睡眠质量了。经查，有个库<a href="https://github.com/JiongXing/PhotoBrowser" target="_blank" rel="external">PhotoBrowser</a>必须要求使用Swift 4.2，而我现有的库是基于Swift 4.1的。在工程下看到了有别人提了<a href="https://github.com/JiongXing/PhotoBrowser/issues/91" target="_blank" rel="external">类似的issue</a>，于是，我将工程升到了4.2，修改了大概<em>100个地方</em>，时间也来到了近2点。。。结果蛋疼的地方又出现了，有些库只支持到Swift 4.1！！！</p><p>因为现在Xcode正式版还没放出来，第三方库也都没有支持 Swift 4.2 ，通过修改podfile让不支持 Swift 4.2 的第三方库在4.1下编译，等到所有依赖的第三方库都支持 Swift 4.2 之后，再把 podfile 改回去</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">swift_41_pod_targets = ['<span class="type">SnapKit'</span>,'<span class="type">MonkeyKing'</span>,'<span class="type">RxCocoa'</span>, ...]</div><div class="line"></div><div class="line">post_install <span class="keyword">do</span> | installer |</div><div class="line"></div><div class="line">    installer.pods_project.targets.each <span class="keyword">do</span> |target|</div><div class="line"></div><div class="line">        <span class="keyword">if</span> swift_41_pod_targets.include?(target.name)</div><div class="line"></div><div class="line">            target.build_configurations.each <span class="keyword">do</span> |config|</div><div class="line"></div><div class="line">                config.build_settings['<span class="type">SWIFT_VERSION'</span>] = '<span class="number">4.1</span>'</div><div class="line"></div><div class="line">            end</div><div class="line"></div><div class="line">        end</div><div class="line"></div><div class="line">    end</div><div class="line"></div><div class="line">end</div></pre></td></tr></table></figure><p>在 Build Setting 中搜索 <code>Swift Language Version</code> 将 Swift 版本号改为 Swift 4.2，完成了整个工程的语言版本升级。</p><h1 id="logo更新"><a href="#logo更新" class="headerlink" title="logo更新"></a>logo更新</h1><p>在某宝上买了一个Logo设计的服务，400大洋，说是总监级别的设计师，结果前三次完全是搞笑，最后搞出来一个差强人意的logo。<br><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxd9sg0ecmj303c03ca9w.jpg" alt=""></p><p>没想到在上架过程中也遇到了问题<strong>ERROR ITMS-90717</strong>:</p><blockquote><p>Invalid App Store Icon. The App Store Icon in the asset catalog in ‘Some.app’ can’t be transparent nor contain an alpha channel.</p></blockquote><p>在简书搜到了<a href="https://www.jianshu.com/p/e8f3791ec556" target="_blank" rel="external">解决方法</a>，原来苹果<em>需要调整Alpha通道为否</em>。</p><p>这次总算上传成功了。后面的审核也是异常顺利，不到10小时就完成了审核，非常迅速，给苹果的审核团队点赞。</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>这小半年时间，不知不觉已经为Match写下了<em>2,5000+</em>多行代码，现在回头看看，挺感谢Match的，他让我专注思考和动手，激发了我精益求精的态度，也成了我独有的一份精神寄托。他就像我的孩子一样，看着他从无到有，越来越好，心里挺满足的。<br><a href="https://ws3.sinaimg.cn/large/006tNbRwgy1fx7uaovyblj30p00nmjrv.jpg" target="_blank" rel="external"></a></p><h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ol><li><a href="https://www.jianshu.com/p/bab8efb2f2d2" target="_blank" rel="external">升级 Swift 4.2 教程</a></li><li><a href="https://www.raywenderlich.com/5960-text-kit-tutorial-getting-started?utm_source=mybridge&amp;utm_medium=blog&amp;utm_campaign=read_more" target="_blank" rel="external">Text Kit Tutorial</a></li><li><a href="https://github.com/JiongXing/PhotoBrowser" target="_blank" rel="external">PhotoBrowser</a></li><li><a href="https://github.com/JiongXing/PhotoBrowser/issues/91" target="_blank" rel="external">关于Swift 4.2的issue</a></li><li><a href="https://www.jianshu.com/p/e8f3791ec556" target="_blank" rel="external">ERROR ITMS-90717</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;Match问答3.0版本近期在&lt;a href=&quot;https://itunes.apple.com/cn/app/match问答/id1414
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS开发" scheme="http://zhihaozhang.github.io/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Match开发笔记 肆 极光推送接入指南(Swift版)</title>
    <link href="http://zhihaozhang.github.io/2018/09/20/match4/"/>
    <id>http://zhihaozhang.github.io/2018/09/20/match4/</id>
    <published>2018-09-20T10:01:51.958Z</published>
    <updated>2018-09-25T06:56:49.245Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在接入极光推送过程中，发现<a href="https://docs.jiguang.cn/jpush/client/iOS/ios_guide_new/" target="_blank" rel="external">官网文档</a>比较老旧了，而且使用的是OC版本，在上架<a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external">Match 2.0</a>的过程中，需要增加推送功能。于是就花了一些精力去研究，并最终改写得到了Swift版本的代码，这里写一个总结，希望能对想使用Swift接入极光推送的朋友们提供一些启发。</p><h1 id="iOS推送机制和JPush的意义"><a href="#iOS推送机制和JPush的意义" class="headerlink" title="iOS推送机制和JPush的意义"></a>iOS推送机制和JPush的意义</h1><h2 id="APNs"><a href="#APNs" class="headerlink" title="APNs"></a>APNs</h2><p>iOS推送，最终只有一条官方渠道，那就是<strong>APNs</strong>。APNs通知是指通过向Apple APNs服务器发送通知，到达iOS设备，由iOS系统提供展现的推送。</p><h2 id="极光推送的意义"><a href="#极光推送的意义" class="headerlink" title="极光推送的意义"></a>极光推送的意义</h2><p>一般开发者都是自己部署服务器，向APNs Server推送。极光推送，是在这中间增加了一步，即开发者自己部署的服务器向极光服务器推送，然后由极光服务器向APNs推送。</p><p><img src="https://docs.jiguang.cn/jpush/client/image/jpush_ios.png" alt=""></p><blockquote><p>iOS和JPush的关系图(来源极光推送官网)</p></blockquote><p>这样做有什么意义呢？极光认为带来了下列好处:</p><ol><li>减少开发及维护成本：应用开发者不需要去开发维护自己的推送服务器与 APNs 对接。集成了 JPush iOS SDK 后不必自己维护更新 device token。通过 JPush 的 Web Portal 直接推送，也可以调用 JPush 的 HTTP 协议 API 来完成，开发工作量大大减少。</li><li>减少运营成本：极光推送支持一次推送，同时向 Android, iOS, WinPhone 三个平台。支持统一的 API 与推送界面。极光推送提供标签、别名绑定机制，以及提供了非常细分的用户分群方式，运营起来非常简单、直观。</li><li>提供应用内推送：除了使得 APNs 推送更简单，也另外提供应用内消息推送。这在类似于聊天的场景里很有必要。</li></ol><h1 id="接入前期准备"><a href="#接入前期准备" class="headerlink" title="接入前期准备"></a>接入前期准备</h1><h2 id="设置iOS消息推送证书"><a href="#设置iOS消息推送证书" class="headerlink" title="设置iOS消息推送证书"></a>设置iOS消息推送证书</h2><p>接入通知前，需要严格按照此文档配置相关证书。否则将会影响消息推送组件的正常使用。苹果开发最烦人的部分恐怕证书绝对算的上是一个了，关于推送证书的生成，这里推荐<a href="https://www.jianshu.com/p/fc962db539e6" target="_blank" rel="external">一个博客</a>，可以参考。</p><p>iOS相比于安卓比较特殊，分为生产环境(上架版)和测试环境(开发版)，最后导出极光所需要的.p12文件。导出.p12文件的坑也不少，推荐<a href="https://www.jianshu.com/p/7d4bba2f1dcb" target="_blank" rel="external">这篇博文</a>，供参考。</p><p>最终在极光控制台上，分别将生产环境和开发环境的两个.p12文件上传，通过验证后，会出现下面截图的样子。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fvg33e6zfyj30yg0i2weu.jpg" alt=""></p><h2 id="极光平台注册"><a href="#极光平台注册" class="headerlink" title="极光平台注册"></a>极光平台注册</h2><p>在极光平台注册你的app,主要需要Bundle ID和开发者认证(企业营业执照)。注册完成后，获得重要信息:<strong>AppKey</strong>，这个码是后面一直需要使用的。</p><h2 id="极光SDK的导入"><a href="#极光SDK的导入" class="headerlink" title="极光SDK的导入"></a>极光SDK的导入</h2><p>导入极光SDK，既可以选择手动，也可以选择使用cocoapods。我使用的是cocoapods，原因很简单，因为如果不想要推送功能了，只需要在podfile里删掉pod ‘JPush’那行就行了。</p><p>导入后，一定记得要在XCode里勾上Application Target 的 Capabilities-&gt;Push Notifications 选项，否则将无法接受推送。</p><p><img src="https://docs.jiguang.cn/jpush/client/image/capabilities_intro.jpg" alt=""></p><h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="添加bridge文件"><a href="#添加bridge文件" class="headerlink" title="添加bridge文件"></a>添加bridge文件</h2><p>因为极光推送是由OC写成，因此swift的项目里不能直接使用，需要借助桥接文件。只要在项目里新建一个OC文件，XCode就会创建一个xxx-Bridging-Header.h文件，在该文件中加入代码，就可以使用极光推送SDK了，啊真香！</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> #<span class="keyword">import</span> "JPUSHService.h"</div><div class="line">#ifdef <span class="type">NSFoundationVersionNumber_iOS_9_x_Max</span></div><div class="line">#<span class="keyword">import</span> &lt;UserNotifications/UserNotifications.h&gt;</div><div class="line">#endif</div><div class="line">#<span class="keyword">import</span> &lt;AdSupport/AdSupport.h&gt;</div></pre></td></tr></table></figure><h2 id="添加Delegate"><a href="#添加Delegate" class="headerlink" title="添加Delegate"></a>添加Delegate</h2><p>在AppDelegate.swift文件中，让AppDelegate遵从JPUSHRegisterDelegate，后面就可以使用相关代理方法了。</p><h2 id="初始化相关代码"><a href="#初始化相关代码" class="headerlink" title="初始化相关代码"></a>初始化相关代码</h2><h3 id="初始化APNs和JPush"><a href="#初始化APNs和JPush" class="headerlink" title="初始化APNs和JPush"></a>初始化APNs和JPush</h3><p>初始化代码如下</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line"><span class="keyword">let</span> entity = <span class="type">JPUSHRegisterEntity</span>()</div><div class="line">entity.types = <span class="number">1</span> &lt;&lt; <span class="number">0</span> | <span class="number">1</span> &lt;&lt; <span class="number">1</span> | <span class="number">1</span> &lt;&lt; <span class="number">2</span></div><div class="line"><span class="type">JPUSHService</span>.register(forRemoteNotificationConfig: entity, delegate: <span class="keyword">self</span>)</div><div class="line"></div><div class="line"><span class="keyword">let</span> advertisingId = <span class="type">ASIdentifierManager</span>.shared().advertisingIdentifier.uuidString</div><div class="line">        <span class="type">JPUSHService</span>.setup(withOption: launchOptions, appKey: <span class="string">"极光平台给分配的"</span>, channel: <span class="string">"App Store"</span>, apsForProduction: <span class="literal">true</span>, advertisingIdentifier: advertisingId)</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="上报device-token"><a href="#上报device-token" class="headerlink" title="上报device_token"></a>上报device_token</h3><p>实现JPUSHRegisterDelegate的代理方法，上报device_token。device_token主要是用来帮助推送定位到特定的设备使用的。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data)</span></span> &#123;</div><div class="line">    <span class="comment">//注册 DeviceToken</span></div><div class="line">    <span class="type">JPUSHService</span>.registerDeviceToken(deviceToken)</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="接收到消息的处理"><a href="#接收到消息的处理" class="headerlink" title="接收到消息的处理"></a>接收到消息的处理</h3><p>这个部分为可选，主要是用来实现用户点开通知后的特定动作，比如跳转到特定页面。这就要跟后端开发人员商量好，将特定的消息通过通知的extra选项传递过来，然后手机端在做相应的跳转。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">jpushNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter!, didReceive response: UNNotificationResponse!, withCompletionHandler completionHandler: <span class="params">(<span class="params">()</span></span></span></span> -&gt; <span class="type">Void</span>)!) &#123;</div><div class="line">      </div><div class="line">       <span class="keyword">let</span> userInfo = response.notification.request.content.userInfo</div><div class="line">       </div><div class="line">       <span class="keyword">let</span> page : <span class="type">String</span> = userInfo[<span class="type">AnyHashable</span>(<span class="string">"page"</span>)] <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">       <span class="keyword">if</span>(page == <span class="string">"home"</span>) &#123;</div><div class="line">          <span class="comment">//跳转到home页面</span></div><div class="line">           </div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(page == <span class="string">"display"</span>)&#123;</div><div class="line">           <span class="comment">//跳转到特定页面</span></div><div class="line">           &#125;</div><div class="line">           </div><div class="line">       &#125;</div></pre></td></tr></table></figure><p>根据通知类型跳转到不同页面的效果:<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fvg4hlrn7pg30om1hckjn.gif" alt=""></p><h3 id="清楚应用ICON角标"><a href="#清楚应用ICON角标" class="headerlink" title="清楚应用ICON角标"></a>清楚应用ICON角标</h3><p>当用户点进应用之后，应用角标的通知数目应该清0，否则强迫症患者会被逼疯。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationWillEnterForeground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</div><div class="line">        application.applicationIconBadgeNumber = <span class="number">0</span></div><div class="line">        application.cancelAllLocalNotifications()</div><div class="line">    &#125;</div></pre></td></tr></table></figure><h3 id="设置Tags和alias"><a href="#设置Tags和alias" class="headerlink" title="设置Tags和alias"></a>设置Tags和alias</h3><p>Tags是区分通知类型的，可以给不同的推送类型打Tag，比如我想接受新题目通知，不想接收点赞通知。而alias一般是有唯一性的，需要根据用户名或手机号这种好区分的东西来分辨。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> outAlias:<span class="type">NSString</span>?</div><div class="line">            <span class="keyword">var</span> outTags:<span class="type">NSSet</span>?</div><div class="line">            (outAlias, outTags) = <span class="keyword">self</span>.analyseInput(alias <span class="keyword">as</span> <span class="type">NSString</span>!, tags: tags)</div><div class="line"></div><div class="line"><span class="type">JPUSHService</span>.setTags(outTags <span class="keyword">as</span>! <span class="type">Set</span>&lt;<span class="type">String</span>&gt;, completion: &#123; (a, b, <span class="built_in">c</span>) <span class="keyword">in</span></div><div class="line"></div><div class="line">            &#125;, seq: <span class="number">1</span>)</div><div class="line">            </div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">analyseInput</span><span class="params">(<span class="number">_</span> alias:NSString!, tags:NSSet!)</span></span>-&gt;(<span class="type">NSString</span>?,<span class="type">NSSet</span>?) &#123;</div><div class="line">        <span class="keyword">var</span> outAlias:<span class="type">NSString</span>?</div><div class="line">        <span class="keyword">var</span> outTags:<span class="type">NSSet</span>?</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> alias.length == <span class="number">0</span> &#123;</div><div class="line">            outAlias = <span class="literal">nil</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            outAlias = alias</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> tags.<span class="built_in">count</span> == <span class="number">0</span> &#123;</div><div class="line">            outTags = <span class="literal">nil</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            outTags = tags</div><div class="line">            <span class="keyword">var</span> emptyStringCount = <span class="number">0</span></div><div class="line">            tags.enumerateObjects(&#123; (tag:<span class="type">Any</span>, stop:<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">ObjCBool</span>&gt;) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">                <span class="keyword">if</span> (tag <span class="keyword">as</span> <span class="type">AnyObject</span>).isEqual(to: <span class="string">""</span>) &#123;</div><div class="line">                    emptyStringCount += <span class="number">1</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    emptyStringCount = <span class="number">0</span></div><div class="line">                    stop.pointee = <span class="literal">true</span></div><div class="line">                &#125;</div><div class="line">                &#125; <span class="keyword">as</span>! (<span class="type">Any</span>, <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">ObjCBool</span>&gt;) -&gt; <span class="type">Void</span>)</div><div class="line">            <span class="keyword">if</span> emptyStringCount == tags.<span class="built_in">count</span> &#123;</div><div class="line">                outAlias = <span class="literal">nil</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (outAlias,outTags)</div><div class="line">    &#125;</div></pre></td></tr></table></figure><h1 id="上架前的提醒"><a href="#上架前的提醒" class="headerlink" title="上架前的提醒"></a>上架前的提醒</h1><p>提交新版本或者初次上架之前，最后会遇到一个关于IDFA的选项。</p><blockquote><p>您的 App 正在使用广告标识符 (IDFA)。您必须先提供关于 IDFA 的使用信息或将其从 App 中移除，然后再上传您的二进制文件。</p></blockquote><p><strong>记得要勾上是</strong>。否则会遇到麻烦。</p><p><img src="http://upload-images.jianshu.io/upload_images/1088461-31b95b90500c3cb2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="http://blog.jiguang.cn/apns/" target="_blank" rel="external">APNs 推送原理及问题</a></li><li><a href="https://docs.jiguang.cn/jpush/client/iOS/ios_guide_new/" target="_blank" rel="external">iOS SDK 集成指南</a></li><li><a href="https://www.jianshu.com/p/fc962db539e6" target="_blank" rel="external">ios 消息推送证书设置和整理(备忘)</a></li><li><a href="https://www.jianshu.com/p/7d4bba2f1dcb" target="_blank" rel="external">p12证书导出按钮为灰色的处理办法</a></li><li><a href="https://blog.csdn.net/WiKi_Su/article/details/78647307" target="_blank" rel="external">iOS提交审核：您的 App 正在使用广告标识符 (IDFA)</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在接入极光推送过程中，发现&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/iOS/ios_gui
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS开发" scheme="http://zhihaozhang.github.io/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus+微信实时报警模块的实现与Docker部署</title>
    <link href="http://zhihaozhang.github.io/2018/09/09/prometheusPlusWechat/"/>
    <id>http://zhihaozhang.github.io/2018/09/09/prometheusPlusWechat/</id>
    <published>2018-09-09T14:13:06.130Z</published>
    <updated>2018-09-09T14:13:22.313Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>对很多公司而言，保证服务可用，在服务不可用时报警到相关服务负责人提醒其及时修复，是非常重要的一件事。在我司，看服务可不可用，是分配给员工们还停留在人眼观察阶段。由行政人员安排轮流值班，每个人负责两周。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fv3bsl5dfvj30u00m6jvk.jpg" alt=""></p><blockquote><p>每人两周的值班表</p></blockquote><p>我觉得这个事情由人来看有三个缺点：</p><ol><li>浪费了人力，值班的人不能全心全意把心思放到工作上。</li><li>报警不够及时，值班人员不可能时刻将注意力放在这上面。</li><li>值班人员只是将异常的服务截图发到群里，有可能不知道通知谁来处理，且真实的责任人看到这个截图又需要一定时间。</li></ol><p>这眼看着很快就要轮到我了，我比较<strong>懒</strong>，于是就找<strong>旁门左道</strong>来替我处理这件事了。</p><h1 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h1><h2 id="普罗米修斯介绍"><a href="#普罗米修斯介绍" class="headerlink" title="普罗米修斯介绍"></a>普罗米修斯介绍</h2><p><a href="https://github.com/prometheus" target="_blank" rel="external">Prometheus（普罗米修斯）</a>是一套开源的<strong>监控/报警/时间序列</strong>数据库的组合,由<strong>SoundCloud</strong>公司开发。</p><p>Prometheus基本原理是通过HTTP协议周期性抓取被监控组件的状态，这样做的好处是任意组件只要提供HTTP接口就可以接入监控系统，不需要任何SDK或者其他的集成过程。这样做非常适合虚拟化环境比如VM或者Docker。</p><p>Prometheus应该是为数不多的适合Docker、Mesos、Kubernetes环境的监控系统之一。</p><p><img src="https://upload-images.jianshu.io/upload_images/1814710-bb27d75d61b730a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/796" alt=""></p><blockquote><p>普罗米修斯架构图</p></blockquote><h2 id="Alertmanager模块的扩展-Email-VS-Wechat"><a href="#Alertmanager模块的扩展-Email-VS-Wechat" class="headerlink" title="Alertmanager模块的扩展 Email VS Wechat"></a>Alertmanager模块的扩展 Email VS Wechat</h2><p>普罗米修斯<em>Alertmanager模块</em>提供了<strong>Email</strong>通知，但是用户查Email不频繁，而且很容易将用户邮箱塞满，以至于后面被邮箱系统判为垃圾邮件，失去了通知的意义。</p><p>和<strong>邮件</strong>形成对比的是<strong>微信</strong>，微信似乎已经成了大部分人手机里使用最频繁的软件了，而且有桌面客户端，即使不看手机，在电脑上工作也能收到消息。一收到消息，特别是@到自己的消息，好奇心会趋势用户打开，看到了自己的服务出现了错误，在群聊里丢了脸，会尽力尽快修复，这也达到了及时通知的目的。</p><h2 id="wechaty"><a href="#wechaty" class="headerlink" title="wechaty"></a>wechaty</h2><p>之前美团和饿了么红包在微信里抢大红包，我那时候第一次知道微信有自动分组、回复和对消息的监听的框架。我在GitHub里搜到了一个叫<a href="https://github.com/wechaty/wechaty" target="_blank" rel="external">wechaty</a>的开源微信SDK，它基于微信公开的API，对接口进行了一系列的封装，提供一系列简单的接口，然后开发者可以在其之上进行微信机器人的开发。</p><blockquote><p>最终促使我使用这个库的原因很简单，是一个墙外用户的评价:**”太好用，好用的想哭”。没想到我后面在墙内部署的时候，真的哭了。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Wechaty.instance()</div><div class="line">.on(<span class="string">'scan'</span>, (url, code) =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(url)</div><div class="line">    <span class="keyword">let</span> loginUrl = url.replace(<span class="string">'qrcode'</span>, <span class="string">'l'</span>)</div><div class="line">    QrcodeTerminal.generate(loginUrl)</div><div class="line">  &#125;)</div><div class="line">.on(<span class="string">'login'</span>,user =&gt; &#123;<span class="built_in">console</span>.log(<span class="string">`User <span class="subst">$&#123;user&#125;</span> logined`</span>)&#125;)</div><div class="line">.on(<span class="string">'message'</span>, <span class="keyword">async</span> (message) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> contact = message.from()</div><div class="line">    <span class="keyword">const</span> content = message.text()</div><div class="line">    <span class="keyword">const</span> room = message.room()</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(room.toString() == <span class="string">"Room&lt;群聊名&gt;"</span>)&#123;</div><div class="line">        heliumMessage = message</div><div class="line">        heliumRoom = room</div><div class="line">    &#125;</div><div class="line">&#125;).start()</div><div class="line"></div><div class="line">server.post(<span class="string">'/sendMsg'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(heliumMessage)&#123;</div><div class="line">    heliumMessage.say(req.body.msg)</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">&#125;).listen(<span class="number">3000</span>)</div></pre></td></tr></table></figure><p>配合node.js用起来真挺方便的，如果起在本地，已经可以正常的工作了。虽然有个小瑕疵，就是需要在群聊里先说一句话，才能找到这个群聊，因为群聊跟联系人还不同。</p><h2 id="部署在docker端"><a href="#部署在docker端" class="headerlink" title="部署在docker端"></a>部署在docker端</h2><p>因为本地机器的IP地址是会发生变化的，因此需要将这个服务部署到docker端，且wechaty宣称支持docker端部署，于是就进行了一番尝试。</p><p>部署到docker，首先遇到的问题的是无法将二维码或url实时传出来，除非通过查询log文件。于是就在代码里集成了邮件模块，将二维码的url以邮件的形式发出来。url里有个坑，刚开始发出来的url是经过替换的，需要将/r/换成/qrcode/。</p><p>wechaty是需要<em>红芯浏览器(chromium)内核</em>的，需要科学的上网方式，整个Image build完之后居然有2G。node的版本也需要v8，v10检查会严格一些，跑不通。</p><p><em>(dockerfile附录于文末)</em></p><h1 id="反响和未来工作"><a href="#反响和未来工作" class="headerlink" title="反响和未来工作"></a>反响和未来工作</h1><p>服务投入使用第一天，值班人员觉得没他什么事了，我就觉得我做这项工作是值得的，减轻了所有人值班的压力。</p><p><img src="https://ws2.sinaimg.cn/large/0069RVTdgy1fv3f4r80h3j30le0dg74t.jpg" alt=""></p><blockquote><p>报警样例与值班人员的反响</p></blockquote><p>现在遇到的问题是报警给很多人，后面想实现一个基于订阅的点对点推送应用。</p><p>#附录 Dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:18.04</div><div class="line"></div><div class="line">ENV DEBIAN_FRONTEND     noninteractive</div><div class="line">ENV WECHATY_DOCKER      1</div><div class="line">ENV LC_ALL              C.UTF-8</div><div class="line">ENV NODE_ENV            $NODE_ENV</div><div class="line">ENV NPM_CONFIG_LOGLEVEL warn</div><div class="line"></div><div class="line"># Installing the &apos;apt-utils&apos; package gets rid of the &apos;debconf: delaying package configuration, since apt-utils is not installed&apos;</div><div class="line"># error message when installing any other package with the apt-get package manager.</div><div class="line"># https://peteris.rocks/blog/quiet-and-unattended-installation-with-apt-get/</div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \</div><div class="line">    apt-utils \</div><div class="line">    bash \</div><div class="line">    build-essential \</div><div class="line">    ca-certificates \</div><div class="line">    curl \</div><div class="line">    coreutils \</div><div class="line">    ffmpeg \</div><div class="line">    figlet \</div><div class="line">    git \</div><div class="line">    gnupg2 \</div><div class="line">    jq \</div><div class="line">    libgconf-2-4 \</div><div class="line">    moreutils \</div><div class="line">    python-dev \</div><div class="line">    shellcheck \</div><div class="line">    sudo \</div><div class="line">    tzdata \</div><div class="line">    vim \</div><div class="line">    wget \</div><div class="line">  &amp;&amp; apt-get purge --auto-remove \</div><div class="line">  &amp;&amp; rm -rf /tmp/* /var/lib/apt/lists/*</div><div class="line"></div><div class="line">RUN curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - \</div><div class="line">    &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends nodejs \</div><div class="line">    &amp;&amp; apt-get purge --auto-remove \</div><div class="line">    &amp;&amp; rm -rf /tmp/* /var/lib/apt/lists/*</div><div class="line"></div><div class="line"># https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md</div><div class="line"># https://github.com/ebidel/try-puppeteer/blob/master/backend/Dockerfile</div><div class="line"># Install latest chrome dev package.</div><div class="line"># Note: this also installs the necessary libs so we don&apos;t need the previous RUN command.</div><div class="line"></div><div class="line">RUN apt-get update -q </div><div class="line">RUN sudo apt-get install -y chromium-browser  xvfb libpango1.0-0 fonts-liberation libappindicator1 libdbusmenu-glib4 libdbusmenu-gtk4   libindicator7 indicator-application</div><div class="line">RUN apt-get install -f -y gconf-service gconf2-common  libgconf-2-4 gconf-service-backend</div><div class="line"></div><div class="line">RUN wget -c https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</div><div class="line">RUN sudo dpkg -i google-chrome-stable_current_amd64.deb</div><div class="line">RUN nohup Xvfb :0 -ac -screen 0 1024x768x24 &amp;</div><div class="line">RUN export DISPLAY=0:0</div><div class="line"></div><div class="line">RUNecho Asia/Shanghai &gt; /etc/timezone&amp;&amp;\</div><div class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</div><div class="line"></div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y tar</div><div class="line"></div><div class="line">WORKDIR /opt</div><div class="line"></div><div class="line">RUN mkdir -p /opt/wechat_robot</div><div class="line">COPY package.json /opt/wechat_robot/</div><div class="line">COPY wechat.js /opt/wechat_robot</div><div class="line">COPY start.sh /opt/wechat_robot</div><div class="line">RUN mkdir -p /opt/wechat_robot/node_modules</div><div class="line">COPY node_modules/ /opt/wechat_robot/node_modules/</div><div class="line"></div><div class="line">RUN chmod +x /opt/wechat_robot/start.sh</div><div class="line"></div><div class="line">ENTRYPOINT  [ &quot;/bin/bash&quot;, &quot;/opt/wechat_robot/start.sh&quot; ]</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;对很多公司而言，保证服务可用，在服务不可用时报警到相关服务负责人提醒其及时修复，是非常重要的一件事。在我司，看服务可不可用，是分配给员工们还
      
    
    </summary>
    
      <category term="监控" scheme="http://zhihaozhang.github.io/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="效率" scheme="http://zhihaozhang.github.io/tags/%E6%95%88%E7%8E%87/"/>
    
  </entry>
  
  <entry>
    <title>上架沙盒化应用,重启应用后保持文件持久访问性指南</title>
    <link href="http://zhihaozhang.github.io/2018/08/24/invisibilitycloak/"/>
    <id>http://zhihaozhang.github.io/2018/08/24/invisibilitycloak/</id>
    <published>2018-08-24T09:44:50.320Z</published>
    <updated>2018-08-25T05:54:01.106Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><em>Invisibility Cloak</em>上架Mac App Store了，在此过程中，遇到了一些困难，在这里记录一下又一次与苹果审核团队撕逼的过程。</p><p>开发这款软件的<strong>初衷</strong>是<del>将xxx.mp4/xxx.avi/xxx.mkv在白天藏起来，免得被别人发现。</del> 在Apple store上发现了一款类似的文件隐藏软件<strong>Secret Folder</strong>，售价128元，而且卖的不错。我觉得这个应用蛮有用(坏笑)，而且实现起来难度不是特别大，于是就做了一个相同功能的软件，并将它上架了。</p><p>功能上，我额外支持了drag&amp;drop添加文件的操作，比Secret Folder的体验更<strong>丝滑</strong>一些。定价上，仅为<strong>Secret Folder</strong>的一折，12RMB，现在特价一周，仅售6元，<em>有将某些文件在白天或演讲时藏起来的朋友们别错过。</em> <a href="https://itunes.apple.com/cn/app/invisibility-cloak/id1426266978?mt=12" target="_blank" rel="external">苹果商店下载地址</a></p><p align="center"><br>  <a href="https://itunes.apple.com/cn/app/invisibility-cloak/id1426266978?mt=12" target="_blank" rel="external"><br>    <img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fukxuftu8vj309g09gt8n.jpg" width="200"><br>  <img alt="Download on the app store" src="https://user-images.githubusercontent.com/7317008/43209852-4ca39622-904b-11e8-8ce1-cdc3aee76ae9.png" width="160"><br>  </a><br></p><h1 id="上架过程中遇到的坑"><a href="#上架过程中遇到的坑" class="headerlink" title="上架过程中遇到的坑"></a>上架过程中遇到的坑</h1><p>不得不说，mac应用的审核比iOS应用的审核快多了，短短两天内审核了四次，这或许也从一定程度上反映了两者提交应用数量的差别。</p><p>第一次拒绝我的原因很<strong>奇葩</strong>，说我的名字起的不好，<strong>AVHider</strong>难道有些露骨？</p><p>第二次拒绝我是因为我勾选了Downloads/Picture/Music/Movie folder的读写权限，隐藏文件嘛，能Access的路径当然是越多越好了，但苹果不这么认为，他认为不该勾选的权限绝不能勾。</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fugf3euvrlj313q0qggml.jpg" alt=""></p><blockquote><p>沙盒中的File Access</p></blockquote><p>第三次被拒其实有点懵，因为我在《macOS开发基础教程》这本书里看到说如果要上架，一定要勾上sandbox和printing，但苹果审核团队以printing对我没用为由，拒绝了我。或许是我理解有误，也有可能是作者的笔误。</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fugfcmp305j311g0dggmq.jpg" alt=""></p><blockquote><p>《macOS开发基础教程》一书中关于上架前注意事项的描述</p></blockquote><p>第四次拒绝的原因是为了解决所有路径文件可用性时，我采取了一种粗暴的手法，直接在.entitlements文件里增加了根目录，即所有文件</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;key&gt;com.apple.security.temporary-exception.files.absolute-path.read-write&lt;/key&gt;</div><div class="line">&lt;array&gt;</div><div class="line">    &lt;string&gt;/&lt;/string&gt;</div><div class="line">&lt;/array&gt;</div></pre></td></tr></table></figure><p>苹果让我重新找其他方法上架，于是我找到了本文需要重点介绍的:<strong>com.apple.security.files.bookmarks.app-scope</strong>.</p><h1 id="沙盒访问机制中的File-Access"><a href="#沙盒访问机制中的File-Access" class="headerlink" title="沙盒访问机制中的File Access"></a>沙盒访问机制中的File Access</h1><p>在iOS和macOS中，每个应用都有一个<strong>专属</strong>存储空间，它就是<strong>沙盒(sandbox)</strong>。就macOS来说，苹果规定从macOS X 10.6开始，所有发布到Mac App Store的应用都必须遵从沙盒约定，主要是考虑到第三方恶意应用对系统进行攻击，从安全性角度出发， 对应用访问的系统资源,硬件外设,文件,网络,XPC等做了严格的限制。</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fukwjs9uylj31iu0pq0x0.jpg" alt=""></p><blockquote><p>引入沙盒机制前后APP对系统资源、数据开放程度对比</p></blockquote><p>在没有上架之前，我没有考虑过这个问题，同样，如果你的应用不准备上架，可以不开启Sandbox，随意访问mac上的文件和数据。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fukwohw5ofj30is05ujts.jpg" alt=""></p><blockquote><p>Sandbox中的File Access</p></blockquote><p>经过第二次被拒之后，我只勾上了用户选择的文件这个Type的读/写权限。但我很快就发现了问题，在应用没重启之前，一切正常运行，但是应用退出再重新打开之后，之前的文件就失去了读写的权限。</p><p>我们需要找到一种策略，让app<strong>记住</strong>我们曾经有过某个文件路径的读写权限，这就是app-scoped bookmark。翻译成中文是<strong>书签</strong>，也很好理解，就好像我们读一本书，某天读累了，<em>夹一张书签在上次看过的地方，下次我们再读的时候，就可以快速回到这一页，而不必从头开始一页页的翻阅了。</em></p><p>既然要记录下来，就涉及到持久化的问题，由于书签比较轻量级，因此我选用了相对简单的<strong>NSUserDefaults</strong>. 网上有OC版本的代码，我用Swift进行了改写，代码如下:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveBookmarks</span><span class="params">(<span class="number">_</span> filePath : String)</span></span>&#123;</div><div class="line"> </div><div class="line">       <span class="keyword">let</span> userDefault = <span class="type">UserDefaults</span>.standard</div><div class="line">       <span class="keyword">let</span> folderPath = <span class="type">NSURL</span>(fileURLWithPath: filePath)</div><div class="line">       <span class="built_in">print</span>(folderPath.absoluteString!)</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           <span class="keyword">let</span> bookmark = <span class="keyword">try</span> folderPath.bookmarkData(options: .securityScopeAllowOnlyReadAccess, includingResourceValuesForKeys: <span class="literal">nil</span>, relativeTo: <span class="literal">nil</span>)</div><div class="line">           userDefault.<span class="keyword">set</span>(bookmark, forKey: folderPath.absoluteString!)</div><div class="line">       &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</div><div class="line">           <span class="built_in">print</span>(<span class="string">"Set Bookmark Fails: <span class="subst">\(error.description)</span>"</span>)</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">func</span> <span class="title">readBookmarks</span><span class="params">(<span class="number">_</span> filePath : String)</span></span>&#123;</div><div class="line">       </div><div class="line">       <span class="keyword">let</span> userDefault = <span class="type">UserDefaults</span>.standard</div><div class="line">       <span class="keyword">if</span> <span class="keyword">let</span> bookmarkData = userDefault.object(forKey: filePath) <span class="keyword">as</span>? <span class="type">NSData</span> &#123;</div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               <span class="keyword">let</span> url = <span class="keyword">try</span> <span class="type">NSURL</span>.<span class="keyword">init</span>(resolvingBookmarkData: bookmarkData <span class="keyword">as</span> <span class="type">Data</span>, options: .withoutUI, relativeTo: <span class="literal">nil</span>, bookmarkDataIsStale: <span class="literal">nil</span>)</div><div class="line">               url.startAccessingSecurityScopedResource()</div><div class="line">           &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</div><div class="line">               <span class="built_in">print</span>(<span class="string">"Bookmark Access Fails: <span class="subst">\(error.description)</span>"</span>)</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p>分为<strong>保存</strong>书签和<strong>读取</strong>书签两个函数，考虑到key的唯一性，为了避免冲突我以文件路径为key存bookmark。每次应用启动之后，都根据之前的路径索取这些路径的读写权限。当然这里也是有<strong>注意点</strong>的，主要是当文件路径中包含<em>数字、字母之外</em>的字符(如中文字符、特殊字符等)时，需要注意<strong>转码</strong>。</p><h1 id="上架后思考"><a href="#上架后思考" class="headerlink" title="上架后思考"></a>上架后思考</h1><p>上架的第一天，在中国区付费应用总排行榜出乎我的意料的排到了第121名。这件事说明了: 1.小而美的应用是有市场的；2.用户对价格还是很敏感的；3.不少用户愿意为他们需要的应用付费。</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fuger4jpwtj31kw10j46x.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;em&gt;Invisibility Cloak&lt;/em&gt;上架Mac App Store了，在此过程中，遇到了一些困难，在这里记录一下又一次与苹
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="macOS开发" scheme="http://zhihaozhang.github.io/tags/macOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Match for iPhone开发笔记 叁 测试与上架篇</title>
    <link href="http://zhihaozhang.github.io/2018/08/02/Match3/"/>
    <id>http://zhihaozhang.github.io/2018/08/02/Match3/</id>
    <published>2018-08-02T07:31:04.373Z</published>
    <updated>2018-09-20T10:09:24.480Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>“Match问答”App今天终于通过了苹果的审核，在<em>App Store上架了，</em><a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external">苹果商店下载地址</a>，不得不说，苹果的审核还是很严格的。因此今天想写一下从提交审核到被拒(<em>若干回合</em>)再到最终上架这段时间里的故事，其他技术方面的<strong>难点总结</strong>放到后面写。</p><h1 id="上架前的必经之路————测试"><a href="#上架前的必经之路————测试" class="headerlink" title="上架前的必经之路————测试"></a>上架前的必经之路————测试</h1><p>在上架之前有一个关键的步骤其实很容易被<strong>忽略</strong>，特别是<em>个人开发者</em>，没法像公司那样聘请专业的测试团队进行完备的测试。大体上讲，iOS的测试可以分为3类:</p><ol><li>单元测试、UI测试、性能测试、集成测试，通常在模拟器上进行</li><li>真机测试</li><li>Testflight内测</li></ol><h2 id="模拟器测试"><a href="#模拟器测试" class="headerlink" title="模拟器测试"></a>模拟器测试</h2><p>第一类测试通常可以发现App里所有可能的<strong>逻辑错误</strong>、<strong>排版问题</strong>和<strong>用户体验</strong>，在进行真机测试之前，一般需要保证模拟器适配各个手机尺寸，需要特别注意的是iPhone X<em>刘海的打理</em>。因为iPhone大小各异，而独立开发者通常不会有所有屏幕尺寸的机型，因此模拟器进行全面测试很有必要。</p><h2 id="真机测试"><a href="#真机测试" class="headerlink" title="真机测试"></a>真机测试</h2><p>第二类测试是<em>真机测试</em>，和模拟器的区别主要集中在<strong>功能</strong>和<strong>硬件</strong>两方面。功能方面，模拟器不支持信息、通话、短信、Accessibility功能(为残障人士准备);硬件方面，模拟器没有蓝牙、相机等硬件，模拟不了相关功能。如果使用了上述的功能，<strong>必须</strong>真机测试。即使没有使用，也应该安装到真机试试，<em>如果你自己都不想用这个APP，别人更不会用</em>。</p><h2 id="Testflight内测"><a href="#Testflight内测" class="headerlink" title="Testflight内测"></a>Testflight内测</h2><p>第三类也是需要苹果审核的，不过Testflight通常比较松，没有明显的bug、闪退一般会在24小时内批准。这一步通过之后，就可以<strong>邀请</strong>更多的亲朋好友来使用了，注意，这一步是<strong>邀请制</strong>的。需要开发者在<a href="https://appstoreconnect.apple.com/WebObjects/iTunesConnect.woa/ra/ng/app/1414728016/testflight?section=iosbuilds" target="_blank" rel="external">itunes connect</a>里手动添加相关测试人员的iCloud账号，当然也是支持<strong>CSV批量导入</strong>功能的。</p><p>当然Testflight测试也有限制，目前的限制提现在两方面:测试时间不超过<strong>90</strong>天、总测试人数上限是<strong>10000</strong>人，对于大部分应用来说已经很足够了。</p><p><img src="https://ws2.sinaimg.cn/large/0069RVTdgy1ftvhqlaq9kj31kw0yctbb.jpg" alt=""></p><blockquote><p>TestFilght页截图，可见信息有测试剩余天数、邀请数、安装数、活跃用户数、崩溃数</p></blockquote><h2 id="App崩溃的可能原因"><a href="#App崩溃的可能原因" class="headerlink" title="App崩溃的可能原因"></a>App崩溃的可能原因</h2><p>在测试过程中，App崩溃会经常发生。我遇到的比较常见的原因有:</p><ol><li>代码出错</li><li>OOM</li><li>网络状况</li><li>cocoapods的问题</li></ol><p>代码出错很常见，比如我经常犯的错误是ViewController的<em>强制向下转型**，明明不是某个特定VC，你强制向他转，肯定会出错；JSON编码解码也经常会出错，如果没有相应机制，就会引起闪退。</em>Objective-C*动态性能比较好，[obj method]这行代码即使obj对象没有method这个方法，在编译器也是不会报错的，但是运行时就会出错。</p><p>内存不够主要是应用在运行时占用了大量收集内存，使得系统强制将应用回收了。通过<strong>Instruments</strong>可以找到原因。</p><p><img src="https://ws4.sinaimg.cn/large/0069RVTdly1ftvo50ywacj30vk0iy3zd.jpg" alt=""></p><blockquote><p>Instruments截图</p></blockquote><p>网络状况出问题主要是网络不佳(<em>蜂窝2G/3G信号网速慢</em>)造成了相应超时;另外也有可能是后端服务器down掉了(<strong>请求太多处理不过来或受到攻击</strong>)。</p><p>cocoapods里的第三方库质量参差不齐，很难保证没有错误，我在开发Match初期就引了一个非常小众的库(<em>这里就不点名了</em>)，已经不work了。我没有<em>深究原因</em>，有可能是Swift版本原因或者我个人使用有误。后面换了一个star数很多的库，就解决了。总体来说，那些<strong>大名鼎鼎、维护比较勤、关注度高</strong>的库比较<strong>solid</strong>一点，也推荐大家尽量使用那样的库。</p><h1 id="上架"><a href="#上架" class="headerlink" title="上架"></a>上架</h1><p>上架的流程比较复杂，具体的操作步骤我在这里就不展开介绍了，有需求的读者可以参考<a href="http://www.xiaoboswift.com/course/44" target="_blank" rel="external">这个教程</a>。</p><p>上架过程中会遇到一些坑，我不能全方面覆盖，只能结合一些自身经历给大家一些建议。</p><h2 id="第一次提交审核-gt-Reject"><a href="#第一次提交审核-gt-Reject" class="headerlink" title="第一次提交审核 -&gt; Reject"></a>第一次提交审核 -&gt; Reject</h2><p>返回意见：</p><p><strong>Guideline 2.1 - Information Needed</strong></p><p>We have started the review of your app, but we were unable to successfully register for an in-app account. In order for us to review your app, please provide a demo account so that we may fully assess your app’s features.</p><p>第一次返回的意见是让我提供一个账户给他。Match采用的是短信动态验证，虽然我在审核信息里也说了需要审核人员填自己的手机号<em>动态获取</em>。。。但是! 谁让他的爷呢，我不得不给应用开了<strong>后门</strong>，乖乖的重新提交第二个版本。</p><p>第一次审核时间真是快，<strong>24小时内</strong>。</p><h2 id="第二次审核-gt-Reject"><a href="#第二次审核-gt-Reject" class="headerlink" title="第二次审核  -&gt; Reject"></a>第二次审核  -&gt; Reject</h2><p>返回意见：<br><strong>Guideline 2.1 - Information Needed</strong></p><p>This type of app has been identified as one that may violate one or more of the following App Store Review Guidelines. Specifically, these types of apps often:</p><p>1.1.6 - Include false information, features, or misleading metadata.</p><p>2.3.0 - Undergo significant concept changes after approval</p><p>2.3.1 - Have hidden or undocumented features, including hidden “switches” that redirect to a gambling or lottery website</p><p>3.1.1 - Use payment mechanisms other than in-app purchase to unlock features or functionality in the app</p><p>3.2.1 - Do not come from the financial institution performing the loan services</p><p>4.3.0 - Are a duplicate of another app or are conspicuously similar to another app</p><p>5.2.1 - Were not submitted by the legal entity that owns and is responsible for offering any services provided by the app</p><p>5.2.3 - Facilitate illegal file sharing or include the ability to save, convert, or download media from third party sources without explicit authorization from those sources</p><p>5.3.4 - Do not have the necessary licensing and permissions for all the locations where the app is used</p><p><strong>Guideline 5.1.1 - Legal - Privacy - Data Collection and Storage</strong></p><p>We noticed that your app requests the user’s consent to access their camera and photos but does not clarify the use of this feature in the permission modal alert.</p><p>第二次审核终于进入正题了，<em>Guideline 2.1</em>给的意见比较<strong>模糊</strong>，审核人员只是将所有的条款列了出来，并没有具体说到底违反了哪条。</p><p><em>Guideline 5.1.1</em>是个坑，我搜了一下，很多其他开发者也都中过招。我记得之前在<strong>infoplist</strong>里是说了需要获得<em>相机/相册</em>的权限的，但是5.1.1说的是，你不仅需要申明你需要使用相机/相册，还要说<strong>为什么需要使用</strong>，编造一个原因吧。</p><p>针对<em>Guideline 2.1</em>，我们为了得到比较具体的回复，针对条款，<strong>逐条</strong>进行了回复，写了整整一页纸。</p><p>第二次审核时间：<strong>2天。</strong></p><h2 id="第三次审核-gt-Reject"><a href="#第三次审核-gt-Reject" class="headerlink" title="第三次审核  -&gt; Reject"></a>第三次审核  -&gt; Reject</h2><p><em>Guideline 2.1 - Information Needed</em></p><ul><li>How do users obtain 积分?</li></ul><p>终于得到了不那么应付的2.1，原来是审核人员对我们应用内的虚拟货币的获取方式产生了怀疑。这点其实挺<strong>尴尬</strong>的，因为苹果不让接入支付宝和微信购买虚拟的货品，而内购的方式苹果会抽成<strong>30</strong>%，这个比例对于我们来说太高了。因此，我们制定了一个策略，即每天登陆送1个积分；内购功能正在做(<em>其实还没有</em>)，回复了苹果提出的问题。</p><p><em>Guideline 2.3.10 - Performance - Accurate Metadata</em></p><ul><li>We noticed that your app or its metadata includes irrelevant third-party platform information. </li></ul><p>Specifically, a non-iOS status bar is shown in the screenshots.</p><p>Referencing third-party platforms in your app or its metadata is not permitted on the App Store unless there is specific interactive functionality.</p><p>针对<em>2.3.10</em>，这点大家也需要特别注意，苹果特别<strong>反感安卓</strong>，在任何审核人员可见的地方，尽量不要出现安卓这个词。</p><p>问答系统里有很多安卓用户，回答高数的形式主要有两种，一种是在纸上手写答案；第二种是在软件内写公式和推导过程，写完后，用户直接截图，就会有安卓系统的顶栏。这点也被审核人员吐槽了，没办法，只能<strong>认错</strong>，说我们会尽量要求用户去掉顶栏。</p><p>第三次审核时间长了起来：<strong>5天</strong>,包含了<strong>周末两天</strong>。</p><h2 id="第四次审核-gt-Reject"><a href="#第四次审核-gt-Reject" class="headerlink" title="第四次审核  -&gt; Reject"></a>第四次审核  -&gt; Reject</h2><p>第四次审核返回的还是2.1，关于用户获取如何积分的疑问。可能不是同一个审核人员吧，没有看我们的回复？这次我直接将首次针对这条的回复贴了进去，也是想得到一个不那么敷衍的回复罢了。</p><p>第四次审核时间:<strong>3天</strong>。</p><h2 id="第五次审核-gt-Accepted"><a href="#第五次审核-gt-Accepted" class="headerlink" title="第五次审核 -&gt; Accepted"></a>第五次审核 -&gt; Accepted</h2><p>不抱任何希望的情况下，今早收到了通知，居然被允许上架了，苹果审核真是<strong>玄学</strong>。虽然这时候已经做了最坏的打算，并开始2.0新版本的开发了，这其中就包括了<strong>内购</strong>，但1.0最终被接受也算是一件振奋人心好事儿。</p><blockquote><p>苹果审核挺蛋疼的，需要做好被拒绝几次的准备。</p></blockquote><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>至此，我完成了当初给<strong>XZJ同学</strong>许诺的让Match上架App Store的约定。在1个月时间内利用下班时间重拾iOS开发技巧，<strong>熬夜</strong>克服了一个又一个困难，现在回想起来还挺<strong>值得</strong>的。看到别人手机、电脑上跑着我写的应用，是我作为一个程序员最大的<strong>满足</strong>。</p><p>最后，打一个广告，欢迎各位同学使用Match来学高数、赚零花钱。<strong>各大应用商店有售!</strong></p><p align="center"><br>  <a href="https://itunes.apple.com/cn/app/match问答/id1414728016?mt=8" target="_blank" rel="external"><br>  <img alt="Download on the app store" src="https://user-images.githubusercontent.com/7317008/43209852-4ca39622-904b-11e8-8ce1-cdc3aee76ae9.png" width="160"><br>  </a><br></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;“Match问答”App今天终于通过了苹果的审核，在&lt;em&gt;App Store上架了，&lt;/em&gt;&lt;a href=&quot;https://itune
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS开发" scheme="http://zhihaozhang.github.io/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>浅谈函数式编程 (Introducing Functional Programming)</title>
    <link href="http://zhihaozhang.github.io/2018/07/30/FunctionalPrograming/"/>
    <id>http://zhihaozhang.github.io/2018/07/30/FunctionalPrograming/</id>
    <published>2018-07-30T12:30:44.000Z</published>
    <updated>2018-08-01T09:16:20.415Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近两周利用空余时间<strong>艰难</strong>“啃完”了objc.io出版的<a href="https://objccn.io/products/functional-swift/" target="_blank" rel="external">《函数式Swift》</a>这本书，感觉有些摸到了函数式编程的门道;在函数式编程<strong>思维</strong>的影响下，将之前的项目代码进行了改造。关于函数式编程，也算是有了一点心得，遂写成此文，虽然行文主要是以Swift为<strong>载体</strong>，但并不影响函数式思想的介绍。由于本人才疏学浅，而函数式编程本身<em>博大精深</em>，故谬误在所难免，如发现，还请指出。</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fts0h9ibzrj31kw0r2ahf.jpg" alt=""></p><blockquote><p>《函数式Swift》</p></blockquote><h1 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h1><h2 id="WHAT-is-函数式编程"><a href="#WHAT-is-函数式编程" class="headerlink" title="WHAT is 函数式编程"></a>WHAT is 函数式编程</h2><p>wiki对于函数式编程的定义如下:</p><blockquote><p>In computer science, functional programming is a <strong>programming paradigm</strong>—a style of building the structure and elements of computer programs—that treats computation as the evaluation of mathematical functions and avoids changing-state and mutable data. It is a <strong>declarative</strong> programming paradigm, which means programming is done with expressions or declarations instead of statements. </p></blockquote><p>我认为最重要的两个单词是<strong>programming Paradigm</strong>和<strong>declarative</strong>，而后者又是为了描述前者准备的。什么是programming Paradigm？我在前几个月写的博客<a href="http://zhihaozhang.github.io/2018/05/20/ProtocolOP/">《面向协议编程初探》</a>中已经解释过了，中文可以翻译为<em>编程范式</em>，我理解为<strong>编程语言设计者希望编程语言的使用者在使用编程语言的时候，思考问题的方式。</strong></p><p>而declarative可以翻译为<em>声明式</em>的，与之相对应的是<strong>imperative</strong>(指令式的)，目前最为广泛使用的<em>面向对象编程</em>就可以划到指令式编程这一类。(declarative和imperative的区别在下文中有所提及)</p><h2 id="函数式编程的和面向对象编程的历史"><a href="#函数式编程的和面向对象编程的历史" class="headerlink" title="函数式编程的和面向对象编程的历史"></a>函数式编程的和面向对象编程的历史</h2><p>在函数式编程面前，面向对象编程其实是晚辈。如果以smalltalk的出现作为面向对象编程元年，那么面向对象编程的历史应该从1975年算起(数据来源<a href="https://baike.baidu.com/item/smalltalk/1379989?fr=aladdin" target="_blank" rel="external">百度百科</a>);而函数式编程的元年可以追溯到Lisp语言出现的1958年(数据来源<a href="https://baike.baidu.com/item/LISP/22083" target="_blank" rel="external">百度百科</a>)。</p><p>函数式编程被很多大佬美誉为<strong>the next big thing</strong>，甚至被称为<strong>最好</strong>的编程范式。让人不免疑惑，既然比面向对象编程出来的早，为什么之前没火，而现在又火了呢？</p><h2 id="WHY函数式编程这两年又火了"><a href="#WHY函数式编程这两年又火了" class="headerlink" title="WHY函数式编程这两年又火了"></a>WHY函数式编程这两年又火了</h2><p>带着疑问，我在搜索引擎中搜索了“函数式编程”和“火了”这两个关键词，找到了一个<a href="https://www.zhihu.com/question/30190384/answer/142902047" target="_blank" rel="external">知乎问答</a>，了解了这一段历史。</p><p>很赞成知乎用户<em>狗好看</em>的回答:</p><blockquote><p>根本的原因是<em>摩尔定律</em>不适用。cpu的性能提升将体现在<strong>核数</strong>增加，这样并行的程序运行速度会越来越快。并行的程序的写法就是找出不能并行的地方，其他地方都尽量并行。如果要这样写，最需要避免的事情就是赋值。函数式编程的本质就是，规避掉“赋值”。</p></blockquote><p>他的回答比较不容易懂，我来用我的理解<em>翻译翻译</em>。</p><blockquote><p>摩尔定律: 当价格不变时，集成电路上可容纳的元器件的数目，约每隔18-24个月便会增加一倍，性能也将提升一倍。</p></blockquote><p>越来越多的人知道，放在初期还是成立的摩尔定律，最近有点不适用了。这和其他很多学科一样，开始的指数级发展，很容易让人过于乐观，到了瓶颈期后，学科发展很容易停滞不前。一个最明显的例子是医学领域关于癌症的笑话，说癌症被攻克，<strong>永远还需要30年</strong>。我用的第一台电脑的CPU是<strong>奔腾4</strong>的，同期经常听到的词还有<strong>赛扬</strong>处理器，奔四有1.4GHz左右的内核时钟，到今天我用的是2016年的顶配MacBook Pro，查了一下，参数为2.7GHz(<em>约20年过去了，还不到2000年的两倍</em>)。</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fts1rk3ge3j30wk0jo46i.jpg" alt=""></p><blockquote><p>2016年的顶配MacBook Pro</p></blockquote><p>Intel的工程师也尝试过将这一参数加到3GHz甚至更高，但是他们发现功耗太高、发热太快。但是每年产品线又要更新，那怎么办呢？只能是往CPU里<em>塞核心</em>来获得<strong>计算能力</strong>和<strong>吞吐量</strong>，刚刚发布的MacBook Pro 2018顶配已经用上了<strong>多达6核心的i9</strong>处理器，甚至连iPhone X都已经有了6个核心。将这些核心都利用上，可以让设备充分发挥作用，如果没有充分利用，很多核心就会在那里空转。为了充分利用多核心，在面向对象编程的世界中，经常用到的技术是<strong>同步机制和加锁</strong>，但由于函数式编程的特性，在函数式编程的世界里就不会出现这个问题，因此函数式编程又<strong>火了</strong>。</p><p>其实在科技界这种死灰复燃的例子还有很多，zelear的<em>王自如</em>在他的节目《科技相对论》<a href="http://www.zealer.com/post/223.html" target="_blank" rel="external">小众产品复活指南</a>里曾经介绍过几款死灰复燃产品，比如：<em>有轨电车、死飞、机械键盘、拍立得、车载广播</em>等。这些产品和函数式编程一样，都没有被<strong>替代</strong>的那么彻底，时过境迁，找到了合适的土壤，用户突然又开始想念他的某个功能，所以又活过来了。</p><h1 id="函数式编程的特性-HOW"><a href="#函数式编程的特性-HOW" class="headerlink" title="函数式编程的特性(HOW)"></a>函数式编程的特性(HOW)</h1><p>很遗憾，经过上一节的解释，我依然未能说清函数式编程是什么。这个问题跟面向对象等其他编程范式一样很难给出准确的定义，只能从几个比较<strong>热门</strong>的特性列举一些例子。</p><h2 id="一等函数"><a href="#一等函数" class="headerlink" title="一等函数"></a>一等函数</h2><p>函数的重要性在函数式编程里不言而喻，在支持函数式编程特性的语言里，函数被<strong>提到</strong>了一个非常重要的位置，他跟<em>Int、String、Bool</em>有着相同的地位。函数可以作为变量的字面量存储起来、作为函数的参数和返回值在函数之间传递。</p><p>函数作为变量的例子很多，只想说一句话：</p><blockquote><p>闭包是函数的<em>字面量</em>，就像1之于Int，true之于Bool。</p></blockquote><h2 id="Currying"><a href="#Currying" class="headerlink" title="Currying"></a>Currying</h2><p>接下来举一个函数作为返回值的例子：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">addFactory</span><span class="params">(value1 : Int)</span></span> -&gt; (<span class="type">Int</span> -&gt; <span class="type">Int</span>)&#123;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">adder</span><span class="params">(value2 : Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line"><span class="keyword">return</span> value1+value2</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> adder</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> addOne = addFactory(<span class="number">1</span>)</div><div class="line">addOne(<span class="number">2</span>)  <span class="comment">// return 3</span></div><div class="line"></div><div class="line">addFactory(<span class="number">1</span>)(<span class="number">2</span>)  <span class="comment">// return 3</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(value1 : Int , value2 : Int)</span></span>&#123;</div><div class="line"><span class="keyword">return</span> value1 + value2</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>addFactory返回的值是一个函数，其类型为(Int -&gt; Int),意思是返回值是一个接受Int并且返回Int的函数，我们可以用两种方式调用它。其中第二种addFactory(1)(2)又被称为我们习以为常的add(1,2)这种函数调用方式的<strong>Currying(柯里化)</strong>。多说一句，Currying是一个人的名字，他的全名叫<em>Haskell</em> Currying，剩下的应该不需要多解释了。</p><h2 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h2><p>接受其它函数作为参数的函数有时被称为<strong>高阶函数</strong>。或许大多数人都使用过<em>Map/Reduce/Filter</em>，他们就是高阶函数最常见的例子。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> nums = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>]</div><div class="line"></div><div class="line"><span class="comment">// way 1</span></div><div class="line"><span class="keyword">let</span> strs : [<span class="type">String</span>] = []</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">0</span>..&lt;nums.<span class="built_in">count</span>) &#123;</div><div class="line">strs[i] = <span class="string">"No."</span> + <span class="type">String</span>(nums[i])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// way 2</span></div><div class="line"><span class="keyword">let</span> brr = nums.<span class="built_in">map</span> &#123;</div><div class="line">    <span class="string">"No."</span> + <span class="type">String</span>($<span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>以Map为例，假设我们有这样一个需求，将一个整型数组，变为一个String类型的数组，并且在每个数字前加上“No.”，一个没有函数式编程思想的程序员极可能写出way1的代码，这种循环的代码几乎每个程序员都写了几千遍了，很好懂也并没有觉得有什么异常，但其实这是一种<strong>指令式</strong>的编程方式。何为指令式编程呢？就是人以机器的思维方式去思考，我们把自己当做了一台机器，比如上面way1的实现方式，就是我们将思维映射到了CPU上，强迫自己像CPU一样去思考。机器是怎么处理这个问题的呢？他首先要开辟一片内存，然后变更寄存器的值映射到变量i上，通过递增来做循环，然后创建字符串的字面量放到刚开辟出来的内存指定位置上。</p><p>way2使用了集合类型的高阶函数，它接收一个参数，这个参数是另一个函数(函数名不重要)，负责String的初始化的方法。当它拿到这个函数之后，自动帮我们把里面的每一个元素拿出来，传到这个String的初始化函数里面去，就生成了最终的数组。这就是<strong>声明式编程</strong>，好处很明显，代码比以前短了很多，思维方式变得更像人思考的方式了。</p><p>有了高阶函数，函数可以自由<strong>装配</strong>，由一些简单的函数<strong>装配</strong>出一些高级的函数。</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fts5pfl6e9j30fz089jrz.jpg" alt=""></p><blockquote><p>装配过程的可视化</p></blockquote><p>关于函数组合的例子，《函数式Swift》给出的实例是对CoreImage库的使用，对一幅图像进行<strong>模糊、加滤镜、切圆角</strong>等操作。一些网红照片的出炉，通常也是由这些看似最简单的操作组合起来的。</p><h2 id="纯函数-pure-function"><a href="#纯函数-pure-function" class="headerlink" title="纯函数(pure function)"></a>纯函数(pure function)</h2><p>在函数式编程中，对于函数还有两点特殊的要求。</p><ol><li>不依赖外部</li><li>不改变外部<br>满足上面两点要求的函数被称为<em>纯函数(pure function)</em>。这两点保证了无论在什么时候调用函数，对于相同的输入，总会得到相同的输出。这至少带来了两点好处：</li></ol><p>1.函数的可测试性</p><p>2.上文提到的函数式编程没有的<em>同步与加锁</em>问题</p><p>至此也可以引出函数式编程的<strong>思想</strong>了:</p><blockquote><p>避免使用程序状态和可变对象，是降低程序复杂度的有效方式之一，而这也正是函数式编程的精髓。函数式编程强调执行的结果，而非执行的过程。我们先构建一系列简单却具有一定功能的小函数，然后再将这些函数进行组装以实现完整的逻辑和复杂的运算，这是函数式编程的基本思想。</p></blockquote><h2 id="函子、适用函子、单子-Functor-Applicative-Monad"><a href="#函子、适用函子、单子-Functor-Applicative-Monad" class="headerlink" title="函子、适用函子、单子(Functor, Applicative, Monad)"></a>函子、适用函子、单子(Functor, Applicative, Monad)</h2><p>这个部分需要单独写一篇文章介绍，我在理解过程中发现了一个很好的<a href="http://jiyinyiyong.github.io/monads-in-pictures/" target="_blank" rel="external">图解blog</a>.</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fts5vo3dsoj30og07gmy7.jpg" alt=""></p><p>这里先给出结论：<br>functor: 通过 fmap 或者 &lt;$&gt; 应用是函数到封装过的值<br>applicative: 通过 &lt;*&gt; 或者 liftA 应用封装过的函数到封装过的值<br>monads: 通过 &gt;&gt;= 或者 liftM 应用会返回封装过的值的函数到封装过的值</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li>《函数式Swift》(<a href="https://objccn.io/products/functional-swift/" target="_blank" rel="external">https://objccn.io/products/functional-swift/</a>)</li><li>smallTalk 百度百科 (<a href="https://baike.baidu.com/item/smalltalk/1379989?fr=aladdin" target="_blank" rel="external">https://baike.baidu.com/item/smalltalk/1379989?fr=aladdin</a>)</li><li>Lisp 百度百科(<a href="https://baike.baidu.com/item/LISP/22083" target="_blank" rel="external">https://baike.baidu.com/item/LISP/22083</a>)</li><li>知乎:为什么函数式编程这两年又火了(<a href="https://www.zhihu.com/question/30190384/answer/142902047" target="_blank" rel="external">https://www.zhihu.com/question/30190384/answer/142902047</a>)</li><li>《科技相对论》小众产品复活指南(<a href="http://www.zealer.com/post/223.html" target="_blank" rel="external">http://www.zealer.com/post/223.html</a>)</li><li>Functor, Applicative, 以及 Monad 的图片阐释 (<a href="http://jiyinyiyong.github.io/monads-in-pictures/" target="_blank" rel="external">http://jiyinyiyong.github.io/monads-in-pictures/</a>)</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;最近两周利用空余时间&lt;strong&gt;艰难&lt;/strong&gt;“啃完”了objc.io出版的&lt;a href=&quot;https://objccn.io
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="swift" scheme="http://zhihaozhang.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title>Match for iPhone开发笔记 贰 网络请求和数据流篇</title>
    <link href="http://zhihaozhang.github.io/2018/07/23/Match2/"/>
    <id>http://zhihaozhang.github.io/2018/07/23/Match2/</id>
    <published>2018-07-23T09:43:02.370Z</published>
    <updated>2018-09-20T10:09:41.284Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>书接<a href="http://zhihaozhang.github.io/2018/07/11/Match/">上文</a>,作为一个<strong>数据驱动</strong>(<em>Data driven</em>)类的APP,如何从服务器端<em>获取到数据</em>并发送<strong>尽量少</strong>的请求次数是一个非常重要的点，甚至被定为<strong>最重要</strong>的点也不为过。这篇博客将介绍我在做Match这个应用过程中使用到的技术以及优化的方法。</p><h1 id="网络请求库"><a href="#网络请求库" class="headerlink" title="网络请求库"></a>网络请求库</h1><h2 id="Alamofire、Moya和Just"><a href="#Alamofire、Moya和Just" class="headerlink" title="Alamofire、Moya和Just"></a>Alamofire、Moya和Just</h2><p>现有的网络请求库非常多，从OC时代<em>大名鼎鼎</em>的<strong><a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">AFNetworking</a></strong>到Swift时代的<strong><a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="external">Alamofire</a></strong>及它的进一步封装<em><a href="https://github.com/Moya/Moya" target="_blank" rel="external">Moya</a></em>,都是对苹果网络层URLSession的封装，且有着相似的目的<strong>：将网络请求从ViewController中解耦出去。</strong>ViewController中如果混杂了太多的网络请求的<strong>构建</strong>、<strong>发送</strong>、<strong>响应接收</strong>、<strong>响应请求的处理</strong>，会使得ViewController非常<strong>臃肿</strong>，不利于代码维护。</p><p><img src="https://moya.github.io/web/diagram.png" alt=""></p><blockquote><p>Moya在Alamofire的基础上进一步对网络请求进行了封装，使网络请求更容易</p></blockquote><p>考虑到Alamofire和Moya引入的成本较高，我发现了另一个更容易上手的库，名字也很酷，叫<a href="https://github.com/JustHTTP/Just" target="_blank" rel="external">Just</a>,名字就感觉<strong>屌屌</strong>的，用起来也是出奇的好用，调用<em>GET/POST</em>请求<strong>Just</strong>需要一行代码，</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  get request</span></div><div class="line"><span class="type">Just</span>.<span class="keyword">get</span>(<span class="string">"http://httpbin.org/get"</span>)</div><div class="line"></div><div class="line"><span class="comment">//  post request</span></div><div class="line"><span class="type">Just</span>.post(</div><div class="line">    <span class="string">"http://justiceleauge.org/member/register"</span>,</div><div class="line">    data: [<span class="string">"username"</span>: <span class="string">"barryallen"</span>, <span class="string">"password"</span>:<span class="string">"ReverseF1ashSucks"</span>],</div><div class="line">    files: [<span class="string">"profile_photo"</span>: .<span class="type">URL</span>(fileURLWithPath:<span class="string">"flash.jpeg"</span>, <span class="literal">nil</span>)]</div><div class="line">) &#123; r <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> r.ok &#123; <span class="comment">/* success! */</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>但由于这个项目已经1年多没人维护了，只支持到了Swift 3，在github上发现一堆Swift 4的issue list，因此不得不再寻找其他网络请求库。这时候，<a href="https://github.com/daltoniam/SwiftHTTP" target="_blank" rel="external">SwiftHTTP</a>出现在我视野中，并成了我最终的选择。</p><h2 id="SwiftHTTP成了最终的选择"><a href="#SwiftHTTP成了最终的选择" class="headerlink" title="SwiftHTTP成了最终的选择"></a>SwiftHTTP成了最终的选择</h2><p>SiwftHTTP有着和Just类似的简洁语法，能做到一行代码解决HTTP请求。对需要快速完成整个APP开发的我来说，它能够<em>构建请求并发送</em>、<em>接收响应并处理</em>，加上它的体积小、用法简单等优点，简直就是<strong>简单、可依赖</strong>最好的诠释。当然，Alamofire和Moya存在的价值是不可否定的。</p><p><img src="https://user-gold-cdn.xitu.io/2018/4/3/16288fa6039c2696?imageView2/0/w/1280/h/960/ignore-error/1" alt=""></p><blockquote><p>网络请求库的简单流程</p></blockquote><h2 id="SwiftHTTP响应的处理"><a href="#SwiftHTTP响应的处理" class="headerlink" title="SwiftHTTP响应的处理"></a>SwiftHTTP响应的处理</h2><p>网络请求的响应都是二进制数据，具体到iOS，是NSData类型的数据，因此需要将响应结果进行<strong>编码</strong>。比如拿到的结果是一张图片，在你用<strong>UIImage</strong>对其<em>编码(decode)</em>之前，在计算机看来，它跟其他音频、视频甚至字符串没有什么俩样，都是一串<em>二进制码</em>。</p><p>有过网络方面开发经验的朋友都知道，无论是响应还是请求，除了我们最想要数据部分(<em>请求体</em>)，还有额外的<strong>开销(头部)</strong>，他们告诉你这段请求成功了没有、什么原因没有成功、请求从哪里来、到哪里去等信息，真正有用的部分其实只占了一部分。这也是为什么需要尽量减少网络请求次数的原因，因为这些<strong>额外</strong>的部分，也是会带来<strong>开销</strong>的。网络请求次数太多难免造成应用卡顿，使得用户体验较差。</p><p>具体到SwiftHTTP，我获取到的响应体可能是一个<strong>String</strong>、一个<strong>Int</strong>值、一个<strong>Double</strong>值，更多的时候，是一个<em>对象(Object)</em>，我们需要根据和后端开发者的约定，将其进行正确编码。对Object的编码是较为复杂的,示例如下:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="type">HTTP</span>.<span class="type">POST</span>(servlet_path!)&#123; response <span class="keyword">in</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = response.error&#123;</div><div class="line">                <span class="built_in">print</span>(error)</div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">do</span> &#123;</div><div class="line">                <span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</div><div class="line">                <span class="keyword">self</span>.user_history = <span class="keyword">try</span> decoder.decode(history.<span class="keyword">self</span>, from: r.data)</div><div class="line">            &#125;<span class="keyword">catch</span>&#123;</div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        </div><div class="line"></div><div class="line"><span class="comment">// history 遵从**Codable**</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">history</span> : **<span class="title">Codable</span>**</span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> asked : [<span class="type">Int</span>]!</div><div class="line">    <span class="keyword">var</span> campaigning : [<span class="type">Int</span>]!</div><div class="line">    <span class="keyword">var</span> favourite : [<span class="type">Int</span>]!</div><div class="line">    <span class="keyword">var</span> phoneNumber : <span class="type">Int</span>!</div><div class="line">    <span class="keyword">var</span> replied : [<span class="type">Int</span>]!</div><div class="line">    <span class="keyword">var</span> tableIndex : <span class="type">Int</span>!</div><div class="line">    <span class="keyword">var</span> voting : [<span class="type">Int</span>]!</div><div class="line">    <span class="keyword">var</span> won : [<span class="type">Int</span>]!</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>相应的处理流程是先判断有没有错误，如果有错，直接返回；没有错误的前提下，使用SwiftyJSON中的JSONDecoder对Object进行编码，需要用do和catch<strong>包围</strong>，因为这一过程不保证一定能成功。</p><blockquote><p>如果结果是数组，将<strong>history.self</strong>改为<strong>[history].self</strong>即可。</p></blockquote><p>需要提前申明Object的类型，且服从<strong>Codable</strong>协议。这里我选用了<strong>Strcut</strong>而不是<strong>Class</strong>，两者的具体区别感兴趣的可以自行去搜索，主要区别是Struct是<strong>值类型</strong>，Class是<strong>引用类型</strong>的。</p><p>当然，String和Int等其他基本类型也有自己的编码方法。比如String的编码方法为:String(data: r.data, encoding: String.Encoding.utf8)。</p><h2 id="Object-Model文件的生成和注意事项"><a href="#Object-Model文件的生成和注意事项" class="headerlink" title="Object Model文件的生成和注意事项"></a>Object Model文件的生成和注意事项</h2><p>Struct和Class的生成可以借助第三方工具<strong><a href="https://github.com/Ahmed-Ali/JSONExport" target="_blank" rel="external">JSONExport</a></strong>完成，国内有人将其进行了<a href="https://github.com/yagamis/JSONExport" target="_blank" rel="external">汉化</a>,可以很方便的导出我们所需要的Swift model文件。</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ftjy4408vwj31ju1440xs.jpg" alt=""></p><blockquote><p>JSONExport汉化版界面</p></blockquote><p>在使用JSONExport之前，网络请求的结果一般是通过PostMan获取的，有些字段的结果可能是<strong>nil</strong>,直接复制进去JSONExport就会将该字段申明为<strong>Any</strong>，但是这就让编译器为难了，因为他并不知道需要为这个字段开多大的空间。因此当你尝试让该Struct服从<strong>Codable</strong>协议时，<strong>会报错</strong>，这时就需要与后端开发人员沟通，<em>将Any改为正确的特定类型。</em></p><h1 id="从数据流角度减少网络请求数"><a href="#从数据流角度减少网络请求数" class="headerlink" title="从数据流角度减少网络请求数"></a>从数据流角度减少网络请求数</h1><p>上文已经提到了，网络请求会给系统带来很大的一笔开销，减少网络请求数是开发者在开发应用过程中优化应用的一个<strong>重要方面</strong>。这里，我给出在做Match过程中减少网络请求数比较<em>Hack</em>的一个小技巧，也不知道对不对，总之是有效的减少了网络请求数。</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1ftjx2jktw7j31j417yadt.jpg" alt=""></p><blockquote><p>从<em>数据流(data-flow)</em>角度看应用</p></blockquote><p>鉴于在应用开发过程中反复了这种模式，这里只需举一个业务场景来说明即可。上图中涉及了三个场景，第一个场景是问题列表页，是一个TableView，数据是从服务器端获取的(默认20个)。当用户点击TableView的某个Cell，会跳转到问题详情页，包含了该问题的题干和回复部分，这部分数据是由第一个场景传过来的，至此没有<strong>再次</strong>发送获取信息的网络请求。</p><p>第三个场景是用户尝试回答这道题目，点击发送之后，回到第二个场景，这时候如果不做任何动作，用户是看不到自己刚刚的回复内容的，这很容易让用户<strong>造成困惑。</strong>但是我又不想再次发送网络请求来更新数据，于是我借助了<strong>App Delegate</strong>这个<em>中转站</em>，将刚刚用户回复的相关信息进行了保存，并<em>人为的</em>添加到了TableView的数据中。这样，在没有发送任何数据请求的前提下，做到了视图已经更新的<strong>假象</strong>。</p><h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>早在写上一篇开发笔记的时候，就有读者问能否像之前的应用一样将Match<strong>开源</strong>。诚然，作为一个完整的应用，有着较大的借鉴意义，但是考虑到朋友为这个应用的开发向我支付了不菲的费用，这个应用最终版权应属于他，所以考虑再三，决定<strong>不开源</strong>，还望大家理解。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;书接&lt;a href=&quot;http://zhihaozhang.github.io/2018/07/11/Match/&quot;&gt;上文&lt;/a&gt;,作为一个
      
    
    </summary>
    
      <category term="苹果开发" scheme="http://zhihaozhang.github.io/categories/%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS开发" scheme="http://zhihaozhang.github.io/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>魔都买房杂记(下)</title>
    <link href="http://zhihaozhang.github.io/2018/07/18/buyhousetwo/"/>
    <id>http://zhihaozhang.github.io/2018/07/18/buyhousetwo/</id>
    <published>2018-07-18T05:47:26.015Z</published>
    <updated>2018-07-18T05:47:26.015Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>上一篇博客<a href="http://zhihaozhang.github.io/2018/07/16/buy-house/">魔都买房杂记(上)</a>写完分享以来，我只在朋友圈进行了分享，便得到了近300次的阅读，我微信好友一共才<em>400</em>人。虽然可能存在某些好友多次阅读了这个文章的现象，但还是不难看出<strong>楼市</strong>的受关注度，毕竟它挑动着每一个人的<strong>神经</strong>，每个人都迟早是有一块地方要安定下来的。</p><p>在写这篇博客的时候，我已经走完了剩下的几乎所有流程，完成了<strong>草签</strong>(合同与正式网签一样)，只剩下网签这最后一步了。这篇博客，我准备书接上文，将后续的流程写出来，方便读者就看到完整的新房购买过程;同时，将重点放在二手房的<strong>看房、选购</strong>和<strong>谈价</strong>技巧，和上文一样，由于我的<em>不专业性</em>，所提意见有强烈的<em>个人主观色彩</em>，也不接受任何质疑和撕逼，仅供大家参考。</p><h1 id="选房后的签约"><a href="#选房后的签约" class="headerlink" title="选房后的签约"></a>选房后的签约</h1><p>签约有很多流程，由于我认购楼盘的房源比较多，需要打印的东西太多，即使10台打印机同时出动依然来不及。并且网签需要时间，而zf网签系统只在指定的时间段内开放，所以昨晚我经历的只能算是<strong>草签</strong>。</p><p>草签和正式签差别并不大，所有合同都是一样的，只是为了<em>减少正式网签</em>的确认时间，过程还是需要<strong>仔细核对</strong>的，我在核对过程中就发现草签合同里把我购买的房屋售价<strong>写错</strong>了。</p><p>需要签的合同非常多，而且通常至少是一式两份，如果嫌写名字太麻烦，也可以带<strong>个人印章</strong>。合同的细节非常多，这时候我不知道除了接受，还有没有argue的余地了。反正我是无脑的签完了，整个流程需要<strong>两个小时</strong>。</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fte9lrckdnj30r80qadh3.jpg" alt=""></p><blockquote><p>众多合同之一，其他涉及敏感信息的合同不宜展示</p></blockquote><p>草签最终合同之前，是需要付清<strong>除了贷款部分所有钱的</strong>。注意，只能刷个人名下的银行卡(最多两张)。由于金额太大，刷卡前最好跟银行客服确认好刷卡额度，现场排队的时候你再去跟人确认申请调整就太浪费时间了。付完钱后，注意<strong>一定</strong>要保留好pos机的票和<strong>收据</strong>。</p><p>接下来就是等正式的网签通知啦~</p><h1 id="二手房看房、选购、谈价"><a href="#二手房看房、选购、谈价" class="headerlink" title="二手房看房、选购、谈价"></a>二手房看房、选购、谈价</h1><p>坦率的讲，这批16年被捂的新盘开完后，上海未来三年内新房将会<strong>极少</strong>。这并非我信口开河，而是由土拍市场决定的，且后面zf想租售并举，所以短期内买新房的机会真的<strong>不多</strong>了，有<strong>房票</strong>和<strong>火力</strong>的抓紧了。<br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fte9rsnspej30u60omgn3.jpg" alt=""></p><p>我看的二手房也不少，也经历过几次与房东谈价格(包括面对面和电话谈价)，也小小的总结了一点点经验和教训，提供给有购买二手房打算的朋友做个参考。</p><h2 id="二手房看房"><a href="#二手房看房" class="headerlink" title="二手房看房"></a>二手房看房</h2><p>二手房看房一般是需要提前预约的，守时很重要，因为对方交易也想找个靠谱、讲信用的人，而守时都不能做到，会大大减分。</p><p>除此之外，我觉得二手房看房最需要注意是<strong>不卑不亢</strong>，在房东(包括中介)面前不要<strong>暴露</strong>出你的真实想法。在房东面前，<strong>尽量找他房子的一些缺点</strong>，比如<em>楼层不好、朝向不好、装修</em>不好等，<strong>暗示他你的房子并没有你想象的那么好</strong>，给后面的谈价<strong>留出足够的余地</strong>。之前就是有次在某个房东面前表现的太喜欢他房子了，被他吃定了的感觉。最后跟他谈价没有成功，后面他居然以低于我报价10万的价格将房子售出了。</p><p>如果真的是很喜欢，<strong>暗自窃喜</strong>就行，不要表现出来，最多就说还行吧。如果真的不喜欢，那也好办，当房东面多说一些他的优点，出门后再也不联系就行。</p><p>我发现我最开始看房最大的一个错误就是主要<strong>看装修了</strong>，其实装修好这事也不全是好处。房东会在总价里体现出来，而房屋的装修用料什么的需要时间来<em>检验</em>。其实看二手房，最主要看的是<strong>户型</strong>，户型好很重要，相比于高昂的房价，<em>装修其实没那么值钱</em>。有些装修一般的房子，售价要比<strong>号称“精装”</strong>的房子便宜非常多，那他的房子就显得性价比非常高了。</p><p>之前有人说毛坯房最好，自己拿来想怎么装修就怎么装修。这点我非常认同，因为那种<strong>半吊子</strong>房屋你如果想重新装修，不得不先把之前装修处理掉，然后再进行重新装修，这个过程显然是比毛坯直接装修要<strong>麻烦</strong>的，当然装修过程中是需要费一些<strong>精力</strong>和<strong>时间</strong>的。</p><p>觉得满意的房子，在正式进入谈价之前，需要<strong>委托中介做产调、确认房子无抵押、向小区里的人打听房子里面没有出过事(成交后因为凶宅闹上法庭的案例不少)。</strong></p><p>总结：</p><blockquote><p>二手房<strong>看户型不看装修</strong>，通常 毛坯房 &gt; 简装房，<strong>真</strong>精装房根据与毛坯的溢价定，谈价前请中介做产调。</p></blockquote><h2 id="二手房谈价"><a href="#二手房谈价" class="headerlink" title="二手房谈价"></a>二手房谈价</h2><p>二手房谈价是个技术活，一般是由中介进行<strong>初步沟通</strong>的。比如这个房子你想以<strong>500</strong>万买到，你就应该告诉中介，我最多出<strong>480</strong>万，让他去跟房东进行沟通。房东一般是不同意的，会抛出一个价格，如果不高于<strong>520</strong>，那你们就可以坐下来面对面谈了，因为房东对中介也不会说出心里的底价，最终价格都是需要和真实客户面对面商量的。</p><p>有了上一步的铺垫，你抓住他房子的缺点，告诉他你出价的理由(<em>列缺点</em>)，如果对方态度友好，最后适当降价达到了你心理预期价格，你就装作免为其难的<strong>接受</strong>吧，毕竟人都有贪小便宜的缺点，愉快的成交就行。如果实在不行，而且你又很想得到这个房子，那就看加价的幅度能不能承受，遇到真正喜欢的就下手吧，多几万<strong>放在30年来看</strong>也不是多大的问题。</p><p>谈价分为税费各付价和买房付价，其实差别也不大，羊毛还是出在羊身上。还是那句话，这种重要的事情最好是能够当面坐下来谈，如果谈到价格低于你的心理预期了，可以付个十万二十万定金，防止房东<strong>反悔</strong>，因为你看中的房子，其他人很可能因为喜欢这套房子，愿意比你多出几万。</p><h2 id="对中介的态度"><a href="#对中介的态度" class="headerlink" title="对中介的态度"></a>对中介的态度</h2><p>买二手房，选中介真的很重要，好的中介推荐的房子靠谱，而且砍价多，做事稳妥。站在中介的立场上考虑，他最希望的就是卖家和买家尽快成交，他好去搞定新的客户，最怕把战线拖的太长了。</p><p>一般中介不会特别<strong><em>偏袒</em></strong>买家或者卖家，他能迅速找到一个价格，让买卖双方都能接受，拿到中介费，对他来说是最重要的。在中介面前也需要有所保留，不能把你心里的真实想法和价格告诉他。极端情况下，你甚至可以给中介<strong>悬赏</strong>，比如上面的例子，你告诉他如果他能把价格搞到480万，你另给<strong>5</strong>万他作为奖励，这样他就会<strong>有动力</strong>去跟房东砍价，中介的口才一般是比你好的多的。如果最终他做到了，你也以<strong>485</strong>万(低于心理预期的<strong>500万</strong>)成交了；如果他没有做到，有了上面中介与房东的砍价过程，房东的<em>心理预期价格</em>通常会有所<strong>松动</strong>，你后面再谈价会<strong>顺利</strong>一些。</p><p>如果价格合适，双方都能接受，下面就是谈中介费了。很遗憾，我没能走到这一步，因此不能给出太多有效建议，但是上海的中介一般会要求你给房屋售价的<strong>2%</strong>，从我身边朋友了解到的情况来看，通常最终都在<strong>1.4%-1.6%</strong>之间，这里推荐<strong>正规的大中介(如链家)</strong>。某些中介上来就说他们只收<strong>1%</strong>的费用，这种尤其需要<strong>警惕</strong>。</p><h1 id="市区二手小房子和郊区大房子怎么选"><a href="#市区二手小房子和郊区大房子怎么选" class="headerlink" title="市区二手小房子和郊区大房子怎么选"></a>市区二手小房子和郊区大房子怎么选</h1><p><strong>写在前面:</strong>如果你资金足够，市区成熟的<em>学区、医院和商圈</em>还是会给你的生活带来很多便利。这个章节主要是给预算<strong>不那么足</strong>的人看的。</p><p>选购市区二手房的主要原因可能还是由于它的<em>地段好，周边配套比较齐全</em>。相比于郊区的房子，市区的二手房更为<strong>保值</strong>，这点是毋庸置疑的。保值是指大环境不好，万一房价下跌时候，市区价格表现更为坚挺;但是对于房价上涨，升值空间就不好说了，由于市区配套已经很齐全了，周边配套暂时不全的郊区完善后带来的利好，市区是享受不到的。</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fte4z3bv7pj308c0ckglz.jpg" alt=""></p><blockquote><p>1997年从东方明珠上俯瞰陆家嘴</p></blockquote><p>20年前从东方明珠上俯瞰陆家嘴，是上图的场景，从图片中看，荒凉到还不如现在的郊区。放到当时，你会投资吗？房子买的是未来，买配套成熟的不叫<strong>投资</strong>，只能叫<strong>储蓄</strong>。</p><p>郊区空气好，环境好，也相对比较安静。但郊区也可能会有<strong>飞机</strong>经过、<strong>高铁</strong>经过，距离<em>垃圾焚烧厂、变电站</em>等对人体不利的功能场所比较近等缺点。这些都是需要<strong>综合考虑</strong>的。</p><h1 id="最后的感悟"><a href="#最后的感悟" class="headerlink" title="最后的感悟"></a>最后的感悟</h1><p>其实在大城市买房，是需要<em>两代</em>(<em>甚至三代人</em>)的努力的，知乎上经常有问题问该不该掏空6个钱包来买房这种问题。大部分的回答是趋同的，即<em>应该掏空买</em>。因为这样能让父辈和祖辈的资产更保值甚至升值，因为把钱投入到楼市，比起存到银行或者放到最近经常炸雷的<strong>P2P</strong>，已经是<strong>对抗通货膨胀</strong>很优秀、<em>很无脑</em>的方法了。房贷也是这样，<strong>4.9%</strong>的基础利率，比起每年通货膨胀率的7%-9%来说，<strong>狠赚</strong>，因此能多贷尽量多贷。毕竟国家肯一次性借给你这么多钱的机会，通常也就买房这一次了。</p><p>工薪阶层如果完全白手起家，是很难凑够首付的，正如上篇博客结尾梁老师微博说的那样，郊区买不了也别拧巴，东南沿海城市了解一下，实在不行就回家找个能发挥先进经验的行业，<strong>给孩子铺个路。</strong></p><h2 id="三代人的“美国梦”"><a href="#三代人的“美国梦”" class="headerlink" title="三代人的“美国梦”"></a>三代人的“美国梦”</h2><p>文末，我引两个故事。第一个是美国<strong>华裔</strong>前商务部部长骆家辉的故事。骆家辉先生的祖父<strong>1880</strong>年去到美国，从一名仆人做起，学习语言同时挣钱，而后回到中国组建家庭。在骆家辉的父亲12岁时，祖父又把一家人带回了美国。骆家辉父亲像半个ABC一样，在美国度过了青少年时光，成年后参军并参加了第二次世界大战，还参与了诺曼底登陆。随后，他的父亲也像祖父一样，回到香港组建了家庭，最后再次举家回到美国，定居西雅图。</p><p>骆家辉记得，在自己幼儿园时期，母亲也在为了成为美国公民学习英语。除了学习语言，父母还做了一些小生意维持生计。不管做什么，他很清楚的认识到，家庭的重心，父母的重心，都放在三件事情上：<strong>第一，获得优良的教育；第二，努力奋斗；第三相互扶持。</strong></p><p>他的父母和中国大多数父母一样，节俭的生活，即使再穷也没有穷子女的教育，为的就是让他们能够过上更好的生活，抓住更多的机遇。正是因为如此，骆家辉先生成为了美国历史上第一位美国本土的亚裔州长和第一位华裔州长。</p><p><img src="https://gss0.bdstatic.com/94o3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike80%2C5%2C5%2C80%2C26/sign=920aeb7fbe096b63951456026d5aec21/b03533fa828ba61e309fe47f4134970a304e5968.jpg" alt=""></p><blockquote><p>在就职典礼上，他开玩笑说，州长宅邸距离自己祖父曾经帮佣的那间房子只有<em>一英里的距离</em>，但是他们家族花了<strong>整整100年时间</strong>才<em>走完这段路</em>。</p></blockquote><h2 id="《神秘的西夏》"><a href="#《神秘的西夏》" class="headerlink" title="《神秘的西夏》"></a>《神秘的西夏》</h2><p>我最近一直在看一部央视纪录片《神秘的西夏》，讲的是西夏的开国皇帝<strong>李元昊</strong>在祖父李继迁和父亲<strong>李德明</strong>长达数十年积攒实力后，<strong>称帝</strong>并和建立了与宋、辽三分天下的百年基业。</p><p><img src="https://gss2.bdstatic.com/9fo3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike80%2C5%2C5%2C80%2C26/sign=4720b4d9b6b7d0a26fc40ccfaa861d6c/50da81cb39dbb6fdb8723d4d0d24ab18972b37b4.jpg" alt=""></p><p>神秘的西夏这部<strong>充满诚意</strong>的纪录片，涉及了西夏<em>文化、经济、政治、军事</em>等诸多方面，看完这部纪录片我懂了很多，<em>历史</em>就是不断重复的<strong>人性</strong>，很多道理和规律放到今天还是这样，<strong>强烈</strong>建议感兴趣的朋友可以去看看。</p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>买房这段时间我一直在想，我的<strong>成长过程</strong>和我的孩子将来会怎么样。</p><p>我出生于江苏<strong>四线</strong>城市(的镇子上)，从小少有人管，属于完全的<strong>放养</strong>状态。由于父母比较忙，我经常是只能放了学玩到天黑，饿到不行才到隔壁老爷爷家吃口饭。虽然贪玩，但我还算自觉，基本能坚持做到先做完作业再玩。初到大学，我发现周围的同学都有很多才艺，而我却没有什么拿得出手的才艺。但我从未抱怨过，我觉得农民身上的<strong>纯朴</strong>是千金难换的。我预感到我孩子将来的成长环境<strong>同比</strong>会比我好一些，可能也会像很多城里孩子那样接受很多种类的学前班、兴趣班。另外，优秀小学也是个资源，这就是<strong>学区房</strong>售价高的主要原因，但是由于预算不够，暂时不能给他提供好的学区。</p><p>上一辈总是希望下一辈能够过的比自己好，因为下一辈总是站在上一辈的肩膀上。和平年代，那种<strong>朝为田舍郎，暮登天子堂</strong>的情况已然不可能发生，某一代人突然成为行业的领袖、一飞冲天，概率也并不是很大。</p><p>吴军老师曾在《<strong>硅谷来信</strong>》中提到过这个现象，他把社会阶级进行了分层(比如<strong>100</strong>层)，这100层大致是类似于金字塔那样的结构，越往上走，人数会越少。有些人命好，出生在第10层的家庭，那他10%的努力可能都比第90层的人100%的努力有效。这不能说是不公平，是由他父辈甚至祖辈的努力带来的。对第90层的人来说，让在他这一辈就冲到第10层的难度非常大，他能通过自己的努力，尽可能多<strong>往上*</strong>拱几层<em>，为他的孩子铺个路已经很好了。同样，对于第10层的人来说，如果他不够努力，在他这一代人掉到二三十层也是有可能的，但他通常活的比开始第90层要好很多。</em>懂了这个道理，看很多东西也就看开了。*</p><p>大部分家庭是需要一代人接着上一代人进行<strong>扎实努力</strong>，<em>扶摇曲折向上</em>的。最后希望大家日子都能越过越<strong>红火</strong>，家族越来越<strong>兴旺</strong>，一代更比一代强!</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fte9nruvz2j30u01sz78m.jpg" alt=""></p><blockquote><p>我未来的家</p></blockquote><p>———<strong>谨以此文献给帮助过我的亲人们</strong>———</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;上一篇博客&lt;a href=&quot;http://zhihaozhang.github.io/2018/07/16/buy-hous
      
    
    </summary>
    
      <category term="购房" scheme="http://zhihaozhang.github.io/categories/%E8%B4%AD%E6%88%BF/"/>
    
    
      <category term="随感" scheme="http://zhihaozhang.github.io/tags/%E9%9A%8F%E6%84%9F/"/>
    
  </entry>
  
  <entry>
    <title>魔都买房杂记(上)</title>
    <link href="http://zhihaozhang.github.io/2018/07/16/buy-house/"/>
    <id>http://zhihaozhang.github.io/2018/07/16/buy-house/</id>
    <published>2018-07-16T11:14:16.002Z</published>
    <updated>2018-08-24T10:02:39.975Z</updated>
    
    <content type="html"><![CDATA[<h1 id="为什么要写这篇博客"><a href="#为什么要写这篇博客" class="headerlink" title="为什么要写这篇博客"></a>为什么要写这篇博客</h1><p>近期终于在魔都<strong>上海</strong>买到了一个属于自己的三房，在一线城市有了一个稳定的<em>安身立命</em>场所。经历了大半年的看二手房、和房东谈价格，到最终选择新房、认筹、摇号、选房。一来记录一下这段经历，二来也为想买房的人提供一些<strong>参考</strong>吧，也仅仅是参考了，毕竟我不是<strong>专业</strong>的。</p><h1 id="购买新房"><a href="#购买新房" class="headerlink" title="购买新房"></a>购买新房</h1><p>决定购买新房是在一次和二手房房东谈价谈崩之后，加上刚刚过去，印象比较深刻，有必要先行记录一下。</p><h2 id="购买新房的好处"><a href="#购买新房的好处" class="headerlink" title="购买新房的好处"></a>购买新房的好处</h2><p>众所周知，由于zf限价，新楼盘一般售价是低于周边二手房的，因为二手房需要支付约2%的中介费、个税(与是否满五唯一相关)、增值税(<strong>5.37%</strong>)和契税(新房也需要)，大部分的房子加起来也要9%，即使是满五唯一的房子，也会被卖家作为一个卖点体现在了售价之中，<strong>毕竟羊毛出在羊身上</strong>。</p><p>而新房就没这么多杂七杂八的费用，现在由于限价，售价比起周边二手，有不小的优势。因为zf可以限制开发商定价，不让他们拿预售证，但是无法跟老百姓们说，你们卖贵了，降价吧。</p><p>除了这些费用，新房最大的好处是房子是全新的，没有他人使用过，也不用担心之前里面出过什么事情，一般买二手房都需要去小区里打听打听需要购买的房子里面出了什么事情没有、咨询房东的出售房子的动机(回答不一定真实)。</p><p>这一批开盘的房子，很多都是被捂盘了两年的，如果是精装交付的房子，装修一般是已经装修好了，没法降低装修标准，在zf限价的大环境下显得尤为值当。无法保证，后面如果继续限价，开发商在装修时候不降准，达到一期同样的水准。</p><p>新房由开发商统一定价，都有一房一价表，不需要(也不可能)遇到二手房时和房东谈价的过程，这个过程真的<strong>超累</strong>！这也是最终促使我购买新房的原因。</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1ftbywzz6waj31kw16o7wh.jpg" alt=""></p><blockquote><p>我购买楼盘的一房一价表</p></blockquote><h2 id="新房的坏处"><a href="#新房的坏处" class="headerlink" title="新房的坏处"></a>新房的坏处</h2><p>新房也有坏处，即新房一般是期房，二手房一般三四个月的流程走完后，就可以交房了，而新房一般需要等待两年左右(被捂成准现房的大约1年甚至更短)。</p><p>有些新房的学区是暂时没有确定的，存在一定的不确定因素。</p><h1 id="新房购买流程"><a href="#新房购买流程" class="headerlink" title="新房购买流程"></a>新房购买流程</h1><p>在上海购买新房一般需要经历<em>认筹、验资、交认筹金、摇号、选房、付首付、办理贷款、网签等后续过程</em>。</p><h2 id="认筹与验资"><a href="#认筹与验资" class="headerlink" title="认筹与验资"></a>认筹与验资</h2><p>认筹与验资其实是一个过程，新楼盘拿到zf开盘许可证后，一般有一周左右的时间让客户认筹。认筹是需要验资的，验资一方面是验证购房者有购房资格，另一方面是验证购房者能够拿出足够的首付款和资金来购买此楼盘的房子。</p><p>拥有购房资格据我所知一般有两种途径，一种是已经落户了的，这种最好办，带个人户口卡或户籍证明原件及复印件到现场即可;另一种是<strong>已婚</strong>并连续缴纳五年以上的社保的，相比之下第二种更为麻烦，所带的材料大约有结婚证、社保缴纳证明和夫妻双方身份证原件和复印件。(我比较幸运，从复旦毕业后，幸运地落了户。所以走的第一条，<strong>第二条所需材料可能不全</strong>)</p><p>检验资产这部分是根据楼盘售价定的，主要是确保你有此楼盘售价最便宜房屋的资金的首付(首套不低于35%/二套不低于70%)。比如我看的楼盘，房屋售价从400-700w，那么就需要有银行开具的200w存款证明(首套)，并且需要冻结认筹金50w。又比如昨天新开的<strong>前滩晶耀</strong>，由于地段好，售价大多在1000w以上，需要验资410w(<em>二套820w</em>)，冻结认筹金<strong>234</strong>万。</p><p>由于新房的性价比不同，认筹比差别非常大，有些楼盘认筹比大约是<strong>1000%</strong>，被笑称为彩票盘;有些性价比低的楼盘认筹比仅有<strong>1.5%</strong>。一句话，群众的眼睛是雪亮的，认筹比越高的楼盘通常意味着性价比越高。</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1ftbzm120m4j30m80go76r.jpg" alt=""></p><blockquote><p>博主所购楼盘认筹现场</p></blockquote><h2 id="摇号"><a href="#摇号" class="headerlink" title="摇号"></a>摇号</h2><p>摇号是由公证处完成并公布的，有没有猫腻我不知道，但大抵是公平的。虽然有人说，凡是有阳光照到的地方都有阴影。但作为毫无背景的人来说，也只能是听天由命了。我一个好朋友，在杭州3000多人认筹的楼盘里摇号结果为第一名。这件事也从一个侧面说明了，运气还是很重要的。当然我平时<strong>好事做的比较多</strong>，运气也很好，1700认筹里排在了320+，还算是比较靠前的。</p><h2 id="选房"><a href="#选房" class="headerlink" title="选房"></a>选房</h2><p>选房之前，是需要好好研究上文提到的一房一价表的，需要将在预算内的房子，综合考虑性价比和想要的程度，列一个从前往后的list。很幸运，我所列的list第一个房间就被我选到啦，12楼的东边套，因此我仅用了<strong>5秒钟</strong>就完成了这一步骤。</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ftc00326z4j31400u0q5h.jpg" alt=""></p><blockquote><p>我们的选房攻略</p></blockquote><p>上面的步骤还是很重要的，因为不是每个人都可以如我一般幸运。如果号够靠前，很容易在里面纠结很久，看到后面进来的人选了房子，很难不着急。特别是在想要的楼栋号和楼层之间怎么选，1楼、2楼和顶楼、次顶楼怎么选，在你纠结的时候，你发现旁边人把你的候选项选走了，选择空间越来越小。当然，号码比较靠后也不全是坏处，选择空间不大了，倒也不至于那么纠结，因为凡事都有两面性。</p><p>多说两句，选房现场和外场不是同一个地方，大约1分钟放10个人进去，这10个人是不分先后选房顺序的，如果1分钟后，你没有选房，又会进来10个人跟你一起选，同样，没有先后顺序。外场跟传销现场差不多，一旦里面有客户选房成功，喇叭里就会喊:”恭喜客户选房成功！” 在外面的人变得更紧张了。真正轮到你之后，会有人带领你<strong>冲</strong>选房内场，并以极快的语速向你喊：“要几号楼几楼，快！快！快！”那语气感觉跟抢劫没啥两样，如果你没有提前做好攻略，很容易进退维谷。</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1ftc09s78qnj31kw0ehtqs.jpg" alt=""></p><blockquote><p>内场选房现场，几乎全部售出</p></blockquote><p>选好之后，工作人员会将印有该房间的信息和售价贴到你的选房卡上，这时候就不能反悔了，认筹金就自动变为了<strong>定金</strong>。</p><h2 id="付首付等后续环节"><a href="#付首付等后续环节" class="headerlink" title="付首付等后续环节"></a>付首付等后续环节</h2><p>我刚刚进行到这一环节，知道的也比较少。一般选完房之后，开发商会给约一周的时间给你筹款。这里<strong>郑重申明</strong>一下:由于上海房价较高，因此即使是首套，首付款也不可能只有35%,因为通常工薪阶层的人贷不到那65%。当然，如果你收入高或者有自己的产业、公司，提供流水，最低最低也要准备房价的35%。<em>我发现很多人将首付款误解为了房价的35%，其实除了贷款外的所有钱，都是需要你一次性给清的。</em></p><p>一句话:</p><blockquote><p>首付款 = 房价 - 你能贷款到的钱</p></blockquote><p>贷款的话，就在<strong>售楼现场</strong>咨询各家银行贷款的信息，选一家贷款最多的吧，一般建设银行和中国银行是比较好的。为什么一定要在售楼现场，因为如果不是开发商合作的银行，将会非常麻烦，要走的流程很复杂，所以不推荐。</p><p>后续的等走完全部流程，在下一篇博客中写。</p><h1 id="一点小建议"><a href="#一点小建议" class="headerlink" title="一点小建议"></a>一点小建议</h1><p>由于我现在已经购入了房子，因此说话难免有失公允，但我仍觉得当下对于上海是一个好的购房时机。原因如下：</p><ol><li>在上海已经限制一般公司购房的大背景下，博主所购的楼盘依然一日卖光，说明了上海不缺买房的资金，也不缺买房的人，缺的是高性价比的产品，像上海现在这样的低谷期，遇到合适的就上。</li><li>zf调控楼市，对购房者有利，从容进场，比恐慌性地进场更能选到自己喜欢的房子。</li><li>由于房企资金链压力，房企不得不接受zf的低价入市，精装房子没有降低标准，性价比比后续的要高。</li><li><strong>在城市里拥有一本印有自己名字的房产证，其意义是何等重要，无法用文字来表达，不仅是代表了从此之后有了安身立命之处，也是从无产转变到有产的标志，人生地位从此跨出新舞台。</strong>(引自房产孟老师的微博)</li></ol><p>用梁老师的微博结束正文部分，共勉吧。最后祝大家都能买到自己<strong>称心如意</strong>的房子!</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftc0sjm2cjj30u01sz0wb.jpg" alt=""></p><blockquote><p>梁老师的微博</p></blockquote><h1 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h1><p>感谢<strong>父母</strong>，他们每天辛勤劳作、省吃俭用为我准备了首付款;</p><p>感谢大家庭里的亲人们，在我困难的时候提供了周转资金，让我<strong>倍感温暖</strong>;</p><p>感谢之前带我看二手房的中介L总，他跟我年纪相仿，教会了我很多房产的知识。都是在这个大城市奋斗的年轻人，最后没能经他手买到房子，感到有些抱歉;也要感谢龙湖的销售LQQ，这次相处时间并不长，但是给我的建议非常中肯和有用；</p><p>last but not least, <strong> My soul-mate xiaoli，Thank you very much indeed! </strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;为什么要写这篇博客&quot;&gt;&lt;a href=&quot;#为什么要写这篇博客&quot; class=&quot;headerlink&quot; title=&quot;为什么要写这篇博客&quot;&gt;&lt;/a&gt;为什么要写这篇博客&lt;/h1&gt;&lt;p&gt;近期终于在魔都&lt;strong&gt;上海&lt;/strong&gt;买到了一个属于自己的三房，在一线
      
    
    </summary>
    
      <category term="购房" scheme="http://zhihaozhang.github.io/categories/%E8%B4%AD%E6%88%BF/"/>
    
    
      <category term="随感" scheme="http://zhihaozhang.github.io/tags/%E9%9A%8F%E6%84%9F/"/>
    
  </entry>
  
</feed>
